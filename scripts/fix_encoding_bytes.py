# -*- coding: ascii -*-
"""Fix mojibake encoding in backtest_results.js using byte-level replacements."""

import sys

filepath = sys.argv[1] if len(sys.argv) > 1 else 'frontend/js/pages/backtest_results.js'

# Read as bytes
with open(filepath, 'rb') as f:
    data = f.read()

print(f"Original size: {len(data)} bytes")

# Mapping of mojibake byte sequences to correct UTF-8 bytes
# Format: (corrupted_bytes, correct_bytes)
replacements = [
    # Capital + strategy (label)
    (b'\xd0\xa0\xd1\x99\xd0\xa0\xc2\xb0\xd0\xa0\xd1\x97\xd0\xa0\xd1\x91\xd0\xa1\xe2\x80\x9a\xd0\xa0\xc2\xb0\xd0\xa0\xc2\xbb \xd0\xa1\xc6\x92\xd0\xa1\xe2\x80\x9a\xd0\xa1\xe2\x82\xac\xd0\xa0\xc2\xb0\xd0\xa1\xe2\x80\x9a\xd0\xa0\xc2\xb5\xd0\xa0\xd1\x96\xd0\xa0\xd1\x91\xd0\xa0\xd1\x91', 
     b'\xd0\x9a\xd0\xb0\xd0\xbf\xd0\xb8\xd1\x82\xd0\xb0\xd0\xbb \xd1\x81\xd1\x82\xd1\x80\xd0\xb0\xd1\x82\xd0\xb5\xd0\xb3\xd0\xb8\xd0\xb8'),
    
    # Buy and hold (label)
    (b'\xd0\xa0\xd1\x9f\xd0\xa0\xd1\x95\xd0\xa0\xd1\x94\xd0\xa1\xc6\x92\xd0\xa0\xd1\x97\xd0\xa0\xd1\x94\xd0\xa0\xc2\xb0 \xd0\xa0\xd1\x91 \xd0\xa1\xc6\x92\xd0\xa0\xc2\xb4\xd0\xa0\xc2\xb5\xd0\xa1\xe2\x82\xac\xd0\xa0\xc2\xb6\xd0\xa0\xc2\xb0\xd0\xa0\xd1\x95\xd0\xa0\xd1\x91\xd0\xa0\xc2\xb5',
     b'\xd0\x9f\xd0\xbe\xd0\xba\xd1\x83\xd0\xbf\xd0\xba\xd0\xb0 \xd0\xb8 \xd1\x83\xd0\xb4\xd0\xb5\xd1\x80\xd0\xb6\xd0\xb0\xd0\xbd\xd0\xb8\xd0\xb5'),
    
    # Wins
    (b'\xd0\xa0\xd1\x9f\xd0\xa0\xd1\x95\xd0\xa0\xc2\xb1\xd0\xa0\xc2\xb5\xd0\xa0\xc2\xb4\xd0\xa1\xe2\x80\xb9', b'\xd0\x9f\xd0\xbe\xd0\xb1\xd0\xb5\xd0\xb4\xd1\x8b'),
    
    # Losses
    (b'\xd0\xa0\xc2\xa3\xd0\xa0\xc2\xb1\xd0\xa1\xe2\x80\xb9\xd0\xa1\xe2\x80\x9a\xd0\xa0\xd1\x94\xd0\xa0\xd1\x91', b'\xd0\xa3\xd0\xb1\xd1\x8b\xd1\x82\xd0\xba\xd0\xb8'),
    
    # Breakeven
    (b'\xd0\xa0\xd0\x86\xd0\xa0\xc2\xb5\xd0\xa0\xc2\xb7\xd0\xa1\xc6\x92\xd0\xa0\xc2\xb1\xd0\xa1\xe2\x80\xb9\xd0\xa1\xe2\x80\x9a\xd0\xa0\xd1\x95\xd0\xa1\xe2\x80\xa1\xd0\xa0\xd1\x95\xd0\xa0\xd1\x95\xd0\xa1\xc3\x91\xd0\xa1\xe2\x80\x9a\xd0\xa1\xc5\x92',
     b'\xd0\x91\xd0\xb5\xd0\xb7\xd1\x83\xd0\xb1\xd1\x8b\xd1\x82\xd0\xbe\xd1\x87\xd0\xbd\xd0\xbe\xd1\x81\xd1\x82\xd1\x8c'),
    
    # Total trades
    (b'\xd0\xa0\xd0\x86\xd0\xa1\xc3\x91\xd0\xa0\xc2\xb5\xd0\xa0\xd1\x96\xd0\xa0\xd1\x95 \xd0\xa1\xc3\x91\xd0\xa0\xc2\xb4\xd0\xa0\xc2\xb5\xd0\xa0\xc2\xbb\xd0\xa0\xd1\x95\xd0\xa0\xd1\x94',
     b'\xd0\x92\xd1\x81\xd0\xb5\xd0\xb3\xd0\xbe \xd1\x81\xd0\xb4\xd0\xb5\xd0\xbb\xd0\xbe\xd0\xba'),
    
    # Green emoji
    (b'\xd1\x80\xd0\xbf\xd0\xbf\xd1\x9e', b'\xf0\x9f\x9f\xa2'),
    
    # Red emoji  
    (b'\xd1\x80\xd0\xbf"\xd0\xb4', b'\xf0\x9f\x94\xb4'),
    
    # File emoji
    (b'\xd1\x80\xd0\xbf"\xd0\x84', b'\xf0\x9f\x93\x84'),
    
    # Bullet point
    (b'\xd0\xb2\xe2\x80\x9a\xd1\x9e', b'\xe2\x80\xa2'),
]

count = 0
for old_bytes, new_bytes in replacements:
    if old_bytes in data:
        occurrences = data.count(old_bytes)
        data = data.replace(old_bytes, new_bytes)
        count += occurrences
        print(f"Fixed {occurrences} occurrences")

# Write back
with open(filepath, 'wb') as f:
    f.write(data)

print(f"Total fixes applied: {count}")
print(f"New size: {len(data)} bytes")
print("Done!")
