"""
Fix mojibake in backtest_results.js using exact Unicode patterns.
All patterns are Unicode escapes.
"""

import sys

def fix_mojibake_file(filepath):
    with open(filepath, 'r', encoding='utf-8') as f:
        text = f.read()
    
    print(f"Original length: {len(text)} chars")
    
    # Exact patterns from file analysis
    # Format: (mojibake, correct)
    replacements = [
        # "Капитал стратегии" - from U+0420 U+0459 U+0420 U+00B0 U+0420 U+0457 U+0420 U+0451 U+0421 U+201A U+0420 U+00B0 U+0420 U+00BB U+0020 U+0421 U+0403 U+0421 U+201A U+0421 U+0402 U+0420 U+00B0 U+0421 U+201A U+0420 U+00B5 U+0420 U+0456 U+0420 U+0451 U+0420 U+0451
        ('\u0420\u0459\u0420\u00b0\u0420\u0457\u0420\u0451\u0421\u201a\u0420\u00b0\u0420\u00bb \u0421\u0403\u0421\u201a\u0421\u0402\u0420\u00b0\u0421\u201a\u0420\u00b5\u0420\u0456\u0420\u0451\u0420\u0451', '\u041a\u0430\u043f\u0438\u0442\u0430\u043b \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0438'),
        
        # "Покупка и удержание"
        ('\u0420\u045f\u0420\u0455\u0420\u0454\u0421\u0453\u0420\u0457\u0420\u0454\u0420\u00b0 \u0420\u0451 \u0421\u0453\u0420\u00b4\u0420\u00b5\u0421\u0402\u0420\u00b6\u0420\u00b0\u0420\u045d\u0420\u0451\u0420\u00b5', '\u041f\u043e\u043a\u0443\u043f\u043a\u0430 \u0438 \u0443\u0434\u0435\u0440\u0436\u0430\u043d\u0438\u0435'),
        
        # "Победы"
        ('\u0420\u045f\u0420\u0455\u0420\u00b1\u0420\u00b5\u0420\u00b4\u0421\u2039', '\u041f\u043e\u0431\u0435\u0434\u044b'),
        
        # "Убытки"
        ('\u0420\u0403\u0420\u00b1\u0421\u2039\u0421\u201a\u0420\u0454\u0420\u0451', '\u0423\u0431\u044b\u0442\u043a\u0438'),
        
        # "Безубыточность"
        ('\u0420\u0406\u0420\u00b5\u0420\u00b7\u0421\u0453\u0420\u00b1\u0421\u2039\u0421\u201a\u0420\u0455\u0421\u2021\u0420\u045d\u0420\u0455\u0421\u0403\u0421\u201a\u0421\u045c', '\u0411\u0435\u0437\u0443\u0431\u044b\u0442\u043e\u0447\u043d\u043e\u0441\u0442\u044c'),
        
        # "Всего сделок"
        ('\u0420\u0406\u0421\u0403\u0420\u00b5\u0420\u0456\u0420\u0455 \u0421\u0403\u0420\u00b4\u0420\u00b5\u0420\u00bb\u0420\u0455\u0420\u0454', '\u0412\u0441\u0435\u0433\u043e \u0441\u0434\u0435\u043b\u043e\u043a'),
        
        # "Итого прибыль"
        ('\u0420\u0406\u0421\u201a\u0420\u0455\u0420\u0456\u0420\u0455 \u0420\u0457\u0421\u0402\u0420\u0451\u0420\u00b1\u0421\u2039\u0420\u00bb\u0421\u045c', '\u0418\u0442\u043e\u0433\u043e \u043f\u0440\u0438\u0431\u044b\u043b\u044c'),
        
        # "Открытые ПР/УБ"
        ('\u0420\u045e\u0421\u201a\u0420\u0454\u0421\u0402\u0421\u2039\u0421\u201a\u0421\u2039\u0420\u00b5 \u0420\u045f\u0420 /\u0420\u0403\u0420\u0406', '\u041e\u0442\u043a\u0440\u044b\u0442\u044b\u0435 \u041f\u0420/\u0423\u0411'),
        
        # "Итого убыток"
        ('\u0420\u0406\u0421\u201a\u0420\u0455\u0420\u0456\u0420\u0455 \u0421\u0453\u0420\u00b1\u0421\u2039\u0421\u201a\u0420\u0455\u0420\u0454', '\u0418\u0442\u043e\u0433\u043e \u0443\u0431\u044b\u0442\u043e\u043a'),
        
        # "Комиссия"
        ('\u0420\u0459\u0420\u0455\u0420\u0458\u0420\u0451\u0421\u0403\u0421\u0403\u0420\u0451\u0421\u040f', '\u041a\u043e\u043c\u0438\u0441\u0441\u0438\u044f'),
        
        # "Общие ПР/УБ"
        ('\u0420\u045e\u0420\u00b1\u0421\u2030\u0420\u0451\u0420\u00b5 \u0420\u045f\u0420 /\u0420\u0403\u0420\u0406', '\u041e\u0431\u0449\u0438\u0435 \u041f\u0420/\u0423\u0411'),
        
        # "Совокупные ПР/УБ"
        ('\u0420\u040e\u0420\u0455\u0420\u0406\u0420\u0455\u0420\u0454\u0421\u0453\u0420\u0457\u0420\u045d\u0421\u2039\u0420\u00b5 \u0420\u045f\u0420 /\u0420\u0403\u0420\u0406', '\u0421\u043e\u0432\u043e\u043a\u0443\u043f\u043d\u044b\u0435 \u041f\u0420/\u0423\u0411'),
        
        # "Прибыль при покупке и удержании"
        ('\u0420\u045f\u0421\u0402\u0420\u0451\u0420\u00b1\u0421\u2039\u0420\u00bb\u0421\u045c \u0420\u0457\u0421\u0402\u0420\u0451 \u0420\u0457\u0420\u0455\u0420\u0454\u0421\u0453\u0420\u0457\u0420\u0454\u0420\u00b5 \u0420\u0451 \u0421\u0453\u0420\u00b4\u0420\u00b5\u0421\u0402\u0420\u00b6\u0420\u00b0\u0420\u045d\u0420\u0451\u0420\u0451', '\u041f\u0440\u0438\u0431\u044b\u043b\u044c \u043f\u0440\u0438 \u043f\u043e\u043a\u0443\u043f\u043a\u0435 \u0438 \u0443\u0434\u0435\u0440\u0436\u0430\u043d\u0438\u0438'),
        
        # "Прибыльность стратегии"
        ('\u0420\u045f\u0421\u0402\u0420\u0451\u0420\u00b1\u0421\u2039\u0420\u00bb\u0421\u045c\u0420\u045d\u0420\u0455\u0421\u0403\u0421\u201a\u0421\u045c \u0421\u0403\u0421\u201a\u0421\u0402\u0420\u00b0\u0421\u201a\u0420\u00b5\u0420\u0456\u0420\u0451\u0420\u0451', '\u041f\u0440\u0438\u0431\u044b\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0438'),
        
        # "Убыток"
        ('\u0420\u0403\u0420\u00b1\u0421\u2039\u0421\u201a\u0420\u0455\u0420\u0454', '\u0423\u0431\u044b\u0442\u043e\u043a'),
        
        # "Прибыль"
        ('\u0420\u045f\u0421\u0402\u0420\u0451\u0420\u00b1\u0421\u2039\u0420\u00bb\u0421\u045c', '\u041f\u0440\u0438\u0431\u044b\u043b\u044c'),
        
        # "Диапазон"
        ('\u0420\u201d\u0420\u0451\u0420\u00b0\u0420\u0457\u0420\u00b0\u0420\u00b7\u0420\u0455\u0420\u045d', '\u0414\u0438\u0430\u043f\u0430\u0437\u043e\u043d'),
        
        # "Текущ. цена"
        ('\u0420\u0162\u0420\u00b5\u0420\u0454\u0421\u0453\u0421\u2030. \u0421\u2020\u0420\u00b5\u0420\u045d\u0420\u00b0', '\u0422\u0435\u043a\u0443\u0449. \u0446\u0435\u043d\u0430'),
        
        # File emoji
        ('\u0440\u0457"\u0404', '\U0001F4C4'),
        
        # Green emoji
        ('\u0440\u0457\u0457\u0439', '\U0001F7E2'),
        
        # Red emoji
        ('\u0440\u0457"\u0434', '\U0001F534'),
        
        # Bullet
        ('\u0432\u2019\u201a\u0439', '\u2022'),
        
        # More variations found in file
        ('\u0420\u045f\u0420 /\u0420\u0403\u0420\u0406', '\u041f\u0420/\u0423\u0411'),
        ('\u0420\u045f\u0420 /\u0420\u0403\u0420\u0406 ', '\u041f\u0420/\u0423\u0411 '),
    ]
    
    count = 0
    for old, new in replacements:
        if old in text:
            occurrences = text.count(old)
            text = text.replace(old, new)
            count += occurrences
            print(f"Replaced {occurrences}x: -> {new}")
    
    # Write back
    with open(filepath, 'w', encoding='utf-8', newline='\n') as f:
        f.write(text)
    
    print(f"\nTotal replacements: {count}")
    print(f"New length: {len(text)} chars")
    return count

if __name__ == '__main__':
    filepath = sys.argv[1] if len(sys.argv) > 1 else 'frontend/js/pages/backtest_results.js'
    
    # Run multiple times to catch nested patterns
    for i in range(3):
        print(f"\n=== Pass {i+1} ===")
        fixed = fix_mojibake_file(filepath)
        if fixed == 0:
            break
