## üîí –ö–æ–¥ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–µ—Å–æ—á–Ω–∏—Ü –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

–ù–∏–∂–µ ‚Äî –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥, –≥–æ—Ç–æ–≤—ã–π –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –≤–∞—à—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (`agents/memory/`, `agents/consensus/`). –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∫–ª—é—á–∞—é—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏—é, –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –∑–∞—â–∏—Ç—É –æ—Ç edge cases.

---

## üß™ 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Å–æ—á–Ω–∏—Ü—ã (`agents/memory/context_sandbox.py`)

```python
"""
–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏.
"""

import re
import hashlib
import json
from typing import Any, Dict, List, Optional, Tuple, Union
from dataclasses import dataclass, field
from enum import Enum
import logging
from datetime import datetime, timedelta
import uuid

logger = logging.getLogger(__name__)


class SourceType(Enum):
    """–¢–∏–ø—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö"""
    MARKET_DATA = "market_data"      # –°–≤–µ—á–∏, –æ—Ä–¥–µ—Ä–±—É–∫, –æ–±—ä—ë–º—ã
    NEWS = "news"                    # –ù–æ–≤–æ—Å—Ç–∏ —Å —Å—Å—ã–ª–∫–∞–º–∏
    ON_CHAIN = "on_chain"            # –î–∞–Ω–Ω—ã–µ –±–ª–æ–∫—á–µ–π–Ω–∞
    EXCHANGE_API = "exchange_api"    # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ API (Bybit, Binance)
    HISTORICAL = "historical"        # –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
    AGENT_MEMORY = "agent_memory"    # –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞


@dataclass(frozen=True)
class VerifiableSource:
    """–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö —Å –¥–æ–∫–∞–∑—É–µ–º–æ–π –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å—é"""
    source_type: SourceType
    content_hash: str                # SHA-256 —Ö—ç—à —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    timestamp: datetime
    provenance_url: Optional[str] = None  # URL –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫
    confidence_score: float = 1.0    # –î–æ–≤–µ—Ä–∏–µ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É (0.0-1.0)
    
    def __post_init__(self):
        if not (0.0 <= self.confidence_score <= 1.0):
            raise ValueError("confidence_score must be between 0.0 and 1.0")
    
    @classmethod
    def from_market_data(cls, symbol: str, timestamp: datetime, data_snapshot: Dict) -> 'VerifiableSource':
        content = json.dumps({
            "symbol": symbol,
            "timestamp": timestamp.isoformat(),
            "data": data_snapshot
        }, sort_keys=True)
        return cls(
            source_type=SourceType.MARKET_DATA,
            content_hash=hashlib.sha256(content.encode()).hexdigest(),
            timestamp=timestamp,
            confidence_score=0.95
        )
    
    @classmethod
    def from_news(cls, url: str, headline: str, timestamp: datetime) -> 'VerifiableSource':
        content = json.dumps({
            "url": url,
            "headline": headline,
            "timestamp": timestamp.isoformat()
        }, sort_keys=True)
        return cls(
            source_type=SourceType.NEWS,
            content_hash=hashlib.sha256(content.encode()).hexdigest(),
            timestamp=timestamp,
            provenance_url=url,
            confidence_score=0.85
        )


@dataclass
class SanitizedContext:
    """–û—á–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø–µ—Å–æ—á–Ω–∏—Ü—ã"""
    agent_id: str
    session_id: str
    sanitized_data: Dict[str, Any]
    rejected_claims: List[Tuple[str, str]]  # (–∫–ª—é—á, –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)
    sources: List[VerifiableSource]
    sandbox_timestamp: datetime = field(default_factory=datetime.utcnow)
    
    @property
    def integrity_score(self) -> float:
        """–û—Ü–µ–Ω–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (0.0-1.0)"""
        if not self.sources:
            return 0.0
        return min(1.0, sum(s.confidence_score for s in self.sources) / len(self.sources))


class ContextSandbox:
    """
    –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–∞.
    –ë–ª–æ–∫–∏—Ä—É–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    """
    
    # –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –Ω–µ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
    _UNVERIFIED_CLAIM_PATTERNS = [
        r"(—è –ø–æ–º–Ω—é|–º—ã –≤–∏–¥–µ–ª–∏|—Ä–∞–Ω–µ–µ –±—ã–ª–æ|–≤—á–µ—Ä–∞ –ø—Ä–æ–∏–∑–æ—à–ª–æ).*[:\-‚Äì‚Äî]?\s*([A-Z][a-z]+.*?(?:–ø–∞–¥–µ–Ω–∏–µ|—Ä–æ—Å—Ç|—Ö–∞–∫|—Å–ª–∏–≤|–≤–∑–ª–æ–º))",
        r"(—Å–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º|–ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏|–∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–æ–±—â–∞—é—Ç).*–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞",
        r"(\d+\.?\d*%).*—Ä–æ—Å—Ç|–ø–∞–¥–µ–Ω–∏–µ.*–±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏",
    ]
    
    def __init__(
        self,
        agent_id: str,
        max_context_age_seconds: int = 300,  # 5 –º–∏–Ω—É—Ç
        min_source_confidence: float = 0.7,
        require_source_for_numerical: bool = True
    ):
        self.agent_id = agent_id
        self.session_id = str(uuid.uuid4())
        self.max_context_age_seconds = max_context_age_seconds
        self.min_source_confidence = min_source_confidence
        self.require_source_for_numerical = require_source_for_numerical
        self._source_registry: Dict[str, VerifiableSource] = {}
        
        logger.info(f"Intialized ContextSandbox for agent '{agent_id}' (session: {self.session_id[:8]})")
    
    def sanitize_input(self, raw_data: Dict[str, Any], sources: Optional[List[VerifiableSource]] = None) -> SanitizedContext:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: –æ—á–∏—Å—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –Ω–µ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.
        
        Args:
            raw_data: –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            sources: –°–ø–∏—Å–æ–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        
        Returns:
            SanitizedContext —Å –æ—á–∏—â–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ —Å–ø–∏—Å–∫–æ–º –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
        """
        sanitized = {}
        rejected = []
        actual_sources = sources or []
        
        for key, value in raw_data.items():
            is_valid, reason = self._validate_claim(key, value, actual_sources)
            
            if is_valid:
                sanitized[key] = value
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if isinstance(value, dict) and "sources" in value:
                    for src in value["sources"]:
                        if isinstance(src, VerifiableSource):
                            self._register_source(src)
            else:
                rejected.append((key, reason))
                logger.warning(f"Agent '{self.agent_id}': Rejected claim '{key}' - {reason}")
        
        return SanitizedContext(
            agent_id=self.agent_id,
            session_id=self.session_id,
            sanitized_data=sanitized,
            rejected_claims=rejected,
            sources=actual_sources
        )
    
    def _validate_claim(self, key: str, value: Any, sources: List[VerifiableSource]) -> Tuple[bool, str]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
        if isinstance(value, dict) and "timestamp" in value:
            ts = value["timestamp"]
            if isinstance(ts, str):
                try:
                    ts = datetime.fromisoformat(ts.replace("Z", "+00:00"))
                except ValueError:
                    return False, "Invalid timestamp format"
            
            if (datetime.utcnow() - ts).total_seconds() > self.max_context_age_seconds:
                return False, f"Context too old (> {self.max_context_age_seconds}s)"
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å–ª–æ–≤—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π (—Ç—Ä–µ–±—É—é—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
        if self.require_source_for_numerical and self._contains_numerical_claim(str(value)):
            if not sources or not any(s.confidence_score >= self.min_source_confidence for s in sources):
                return False, "Numerical claim requires verified source with confidence >= 0.7"
        
        # 3. –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–µ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
        value_str = str(value).lower()
        for pattern in self._UNVERIFIED_CLAIM_PATTERNS:
            if re.search(pattern, value_str):
                return False, f"Unverified claim pattern detected: '{pattern[:50]}...'"
        
        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ (—É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏)
        if self._is_hallucination_risk(value_str):
            if not any("timestamp" in str(s) or s.provenance_url for s in sources):
                return False, "High hallucination risk: claim lacks temporal/spatial anchoring"
        
        return True, "Valid"
    
    def _contains_numerical_claim(self, text: str) -> bool:
        """–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π (—Ü–µ–Ω—ã, %, –æ–±—ä—ë–º—ã)"""
        # –¶–µ–Ω–∞: $50,000, 50000 USD
        price_pattern = r"(\$|‚Ç¨|USD|USDT)\s*[\d,]+\.?\d*"
        # –ü—Ä–æ—Ü–µ–Ω—Ç: +5%, -12.3%
        pct_pattern = r"[-+]?\d+\.?\d*\s*%"
        # –û–±—ä—ë–º: 1.2B, 500M
        vol_pattern = r"\d+\.?\d*\s*[BMK]($|[^a-zA-Z])"
        
        return any(re.search(p, text) for p in [price_pattern, pct_pattern, vol_pattern])
    
    def _is_hallucination_risk(self, text: str) -> bool:
        """–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–∏–Ω–≥–≤–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"""
        high_risk_phrases = [
            r"\b–≤—á–µ—Ä–∞\b.*\b(–ø—Ä–æ–∏–∑–æ—à—ë–ª|–±—ã–ª|—Å–ª—É—á–∏–ª—Å—è)\b",
            r"\b–∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–æ–±—â–∞—é—Ç\b.*\b–±–µ–∑ —Å—Å—ã–ª–∫–∏\b",
            r"\b—è —É–≤–µ—Ä–µ–Ω\b.*\b—á—Ç–æ\b",
            r"\b—ç–∫—Å–ø–µ—Ä—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—Ç\b.*\b–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤\b"
        ]
        return any(re.search(phrase, text) for phrase in high_risk_phrases)
    
    def _register_source(self, source: VerifiableSource) -> bool:
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–µ—Å—Ç—Ä–µ —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π"""
        if source.content_hash in self._source_registry:
            existing = self._source_registry[source.content_hash]
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π
            if (source.timestamp > existing.timestamp and 
                source.confidence_score > existing.confidence_score):
                self._source_registry[source.content_hash] = source
                return True
            return False
        
        self._source_registry[source.content_hash] = source
        return True
    
    def get_integrity_report(self) -> Dict[str, Any]:
        """–û—Ç—á—ë—Ç –æ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–µ—Å–æ—á–Ω–∏—Ü—ã –¥–ª—è –∞—É–¥–∏—Ç–∞"""
        return {
            "agent_id": self.agent_id,
            "session_id": self.session_id,
            "total_sources_registered": len(self._source_registry),
            "sources_by_type": self._count_sources_by_type(),
            "oldest_source_age_seconds": self._get_oldest_source_age(),
            "sandbox_health": "healthy" if len(self._source_registry) > 0 else "at_risk"
        }
    
    def _count_sources_by_type(self) -> Dict[str, int]:
        counts = {}
        for src in self._source_registry.values():
            counts[src.source_type.value] = counts.get(src.source_type.value, 0) + 1
        return counts
    
    def _get_oldest_source_age(self) -> Optional[float]:
        if not self._source_registry:
            return None
        oldest = min(src.timestamp for src in self._source_registry.values())
        return (datetime.utcnow() - oldest).total_seconds()


# ==================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ê–†–•–ò–¢–ï–ö–¢–£–†–û–ô –ê–ì–ï–ù–¢–û–í ====================

class AgentContextManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Å–æ—á–Ω–∏—Ü–µ–π.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –±–∞–∑–æ–≤–æ–º –∫–ª–∞—Å—Å–µ –∞–≥–µ–Ω—Ç–∞.
    """
    
    def __init__(self, agent_id: str):
        self.agent_id = agent_id
        self.sandbox = ContextSandbox(agent_id)
        self._current_context: Optional[SanitizedContext] = None
    
    def receive_message(self, raw_message: Dict[str, Any], sources: Optional[List[VerifiableSource]] = None) -> SanitizedContext:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞"""
        self._current_context = self.sandbox.sanitize_input(raw_message, sources)
        return self._current_context
    
    def get_safe_context(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≥–µ–Ω—Ç–æ–º"""
        if not self._current_context:
            return {}
        return self._current_context.sanitized_data
    
    def has_rejected_claims(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π"""
        return self._current_context and len(self._current_context.rejected_claims) > 0
    
    def get_integrity_score(self) -> float:
        """–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        return self._current_context.integrity_score if self._current_context else 0.0


# ==================== –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ====================

if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    # –°–æ–∑–¥–∞—ë–º –ø–µ—Å–æ—á–Ω–∏—Ü—É –¥–ª—è –∞–≥–µ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
    reasoning_agent_sandbox = ContextSandbox(agent_id="reasoning_agent_v1")
    
    # –ü—Ä–∏–º–µ—Ä "–∑–∞—Ä–∞–∂—ë–Ω–Ω–æ–≥–æ" –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    malicious_context = {
        "market_signal": "BTC —É–ø–∞–ª –Ω–∞ 15% –≤—á–µ—Ä–∞ –∏–∑-–∑–∞ —Ö–∞–∫–∞ Bybit –Ω–∞ $1.5B",
        "price_prediction": "–¶–µ–ª—å $85,000 –∫ –∫–æ–Ω—Ü—É –Ω–µ–¥–µ–ª–∏",
        "confidence": 0.92,
        "timestamp": "2026-02-13T14:30:00Z"
    }
    
    # –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
    sanitized = reasoning_agent_sandbox.sanitize_input(malicious_context)
    
    print("=== –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ ===")
    print(f"–ü—Ä–∏–Ω—è—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: {len(sanitized.sanitized_data)}")
    print(f"–û—Ç–∫–ª–æ–Ω–µ–Ω–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: {len(sanitized.rejected_claims)}")
    for key, reason in sanitized.rejected_claims:
        print(f"  ‚úó '{key}': {reason}")
    print(f"–ò–Ω—Ç–µ–≥—Ä–∏—Ç–∏-—Å–∫–æ—Ä: {sanitized.integrity_score:.2f}")
    
    # –ü—Ä–∏–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
    safe_sources = [
        VerifiableSource.from_market_data(
            symbol="BTCUSDT",
            timestamp=datetime.utcnow(),
            data_snapshot={"close": 51245.5, "volume": 1245.8}
        ),
        VerifiableSource.from_news(
            url="https://www.coindesk.com/bitcoin-rallies-above-50k",
            headline="Bitcoin rallies above $50K on ETF inflows",
            timestamp=datetime.utcnow()
        )
    ]
    
    safe_context = {
        "price": 51245.5,
        "volume": 1245.8,
        "news_headline": "Bitcoin rallies above $50K on ETF inflows"
    }
    
    sanitized_safe = reasoning_agent_sandbox.sanitize_input(safe_context, safe_sources)
    print("\n=== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ===")
    print(f"–ò–Ω—Ç–µ–≥—Ä–∏—Ç–∏-—Å–∫–æ—Ä: {sanitized_safe.integrity_score:.2f} (–æ–∂–∏–¥–∞–µ–º–æ –≤—ã—Å–æ–∫–∏–π)")
```

---

## üìä 2. –°—Ö–µ–º–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (`agents/consensus/calibration_engine.py`)

```python
"""
–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤
—Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏.
"""

import math
import statistics
from typing import List, Dict, Optional, Tuple
from dataclasses import dataclass, field
from enum import Enum
import logging
from datetime import datetime, timedelta

logger = logging.getLogger(__name__)


class AgentType(Enum):
    """–¢–∏–ø—ã –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏"""
    RESEARCH = "research"          # Perplexity ‚Äî —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    REASONING = "reasoning"        # Qwen ‚Äî –∞–Ω–∞–ª–∏–∑ –∏ –≥–∏–ø–æ—Ç–µ–∑—ã
    EXECUTION = "execution"        # DeepSeek ‚Äî –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
    RISK = "risk"                  # Risk Agent ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º


class MarketRegime(Enum):
    """–†–µ–∂–∏–º—ã —Ä—ã–Ω–∫–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏"""
    LOW_VOLATILITY = "low_volatility"      # < 2% –∑–∞ 15 –º–∏–Ω
    NORMAL = "normal"                      # 2-5% –∑–∞ 15 –º–∏–Ω
    HIGH_VOLATILITY = "high_volatility"    # 5-10% –∑–∞ 15 –º–∏–Ω
    EXTREME_VOLATILITY = "extreme"         # > 10% –∑–∞ 15 –º–∏–Ω
    LIQUIDITY_CRISIS = "liquidity_crisis"  # –°–ø—Ä–µ–¥ > 0.5%


@dataclass(frozen=True)
class AgentResponse:
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""
    agent_id: str
    agent_type: AgentType
    raw_confidence: float          # –°—ã—Ä–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç –º–æ–¥–µ–ª–∏ (0.0-1.0)
    decision: str                  # "buy", "sell", "hold"
    reasoning: str                 # –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è
    sources_count: int             # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    timestamp: datetime = field(default_factory=datetime.utcnow)
    market_regime: MarketRegime = MarketRegime.NORMAL
    symbol: str = "BTCUSDT"
    
    def __post_init__(self):
        if not (0.0 <= self.raw_confidence <= 1.0):
            raise ValueError("raw_confidence must be between 0.0 and 1.0")


@dataclass
class CalibrationResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    agent_id: str
    raw_confidence: float
    calibrated_confidence: float
    adjustments: Dict[str, float]  # –ò–º–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–π –∏ –∏—Ö –≤–µ–ª–∏—á–∏–Ω–∞
    final_decision: str
    risk_adjusted_position_size: float  # –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º —Ä–∏—Å–∫–∞ (0.0-1.0)
    is_actionable: bool            # –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ?
    
    @property
    def confidence_delta(self) -> float:
        return self.calibrated_confidence - self.raw_confidence


class ConfidenceCalibrationEngine:
    """
    –î–≤–∏–∂–æ–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Å –º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π.
    
    –§–æ—Ä–º—É–ª–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:
    calibrated = raw * source_multiplier * volatility_multiplier * 
                 historical_accuracy * regime_multiplier * consensus_boost
    """
    
    # –ü–æ—Ä–æ–≥–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
    MIN_ACTIONABLE_CONFIDENCE = 0.65
    MIN_SOURCE_COUNT = 2
    MAX_CONFIDENCE = 0.92  # –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    
    def __init__(
        self,
        agent_historical_accuracy: Dict[str, float] = None,
        volatility_window_minutes: int = 15
    ):
        self.agent_historical_accuracy = agent_historical_accuracy or {}
        self.volatility_window_minutes = volatility_window_minutes
        self._calibration_history: List[CalibrationResult] = []
    
    def calibrate(self, response: AgentResponse, peer_responses: Optional[List[AgentResponse]] = None) -> CalibrationResult:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞.
        
        Args:
            response: –û—Ç–≤–µ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
            peer_responses: –û—Ç–≤–µ—Ç—ã –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            CalibrationResult —Å –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        """
        adjustments = {}
        
        # 1. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        source_mult = self._calculate_source_multiplier(response.sources_count)
        adjustments["source_multiplier"] = source_mult
        
        # 2. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞
        vol_mult = self._calculate_volatility_multiplier(response.market_regime)
        adjustments["volatility_multiplier"] = vol_mult
        
        # 3. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞
        hist_mult = self._calculate_historical_multiplier(response.agent_id)
        adjustments["historical_multiplier"] = hist_mult
        
        # 4. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
        regime_mult = self._calculate_regime_multiplier(response.market_regime, response.agent_type)
        adjustments["regime_multiplier"] = regime_mult
        
        # 5. –ë–æ–Ω—É—Å –∑–∞ –∫–æ–Ω—Å–µ–Ω—Å—É—Å (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç—ã –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤)
        consensus_boost = 1.0
        if peer_responses:
            consensus_boost = self._calculate_consensus_boost(response, peer_responses)
            adjustments["consensus_boost"] = consensus_boost
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å–∫–∞–¥–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é
        calibrated = response.raw_confidence
        calibrated *= source_mult
        calibrated *= vol_mult
        calibrated *= hist_mult
        calibrated *= regime_mult
        calibrated *= consensus_boost
        
        # –ñ—ë—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        calibrated = min(calibrated, self.MAX_CONFIDENCE)
        calibrated = max(calibrated, 0.0)
        
        # –†–∞—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º —Ä–∏—Å–∫–∞
        position_size = self._calculate_risk_adjusted_position(calibrated, response.market_regime)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ
        is_actionable = (
            calibrated >= self.MIN_ACTIONABLE_CONFIDENCE and
            response.sources_count >= self.MIN_SOURCE_COUNT and
            response.market_regime not in [MarketRegime.EXTREME_VOLATILITY, MarketRegime.LIQUIDITY_CRISIS]
        )
        
        result = CalibrationResult(
            agent_id=response.agent_id,
            raw_confidence=response.raw_confidence,
            calibrated_confidence=round(calibrated, 4),
            adjustments=adjustments,
            final_decision=response.decision if is_actionable else "hold",
            risk_adjusted_position_size=position_size,
            is_actionable=is_actionable
        )
        
        self._calibration_history.append(result)
        logger.info(
            f"Calibrated {response.agent_id}: {response.raw_confidence:.2%} ‚Üí "
            f"{calibrated:.2%} (actionable: {is_actionable}, position: {position_size:.1%})"
        )
        
        return result
    
    def _calculate_source_multiplier(self, source_count: int) -> float:
        """
        –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
        –§–æ—Ä–º—É–ª–∞: 0.75 + 0.1 * log2(source_count + 1)
        """
        if source_count == 0:
            return 0.5  # –°–∏–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        elif source_count == 1:
            return 0.8
        elif source_count == 2:
            return 1.0
        else:
            return min(1.2, 0.75 + 0.1 * math.log2(source_count + 1))
    
    def _calculate_volatility_multiplier(self, regime: MarketRegime) -> float:
        """–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞"""
        multipliers = {
            MarketRegime.LOW_VOLATILITY: 1.1,   # –ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî –≤—ã—à–µ –¥–æ–≤–µ—Ä–∏–µ
            MarketRegime.NORMAL: 1.0,
            MarketRegime.HIGH_VOLATILITY: 0.85,
            MarketRegime.EXTREME_VOLATILITY: 0.6,
            MarketRegime.LIQUIDITY_CRISIS: 0.3   # –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
        }
        return multipliers.get(regime, 1.0)
    
    def _calculate_historical_multiplier(self, agent_id: str) -> float:
        """–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ 100 —Ä–µ—à–µ–Ω–∏–π)"""
        accuracy = self.agent_historical_accuracy.get(agent_id, 0.7)  # –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å 70%
        
        # –ù–µ–ª–∏–Ω–µ–π–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è: —Å–∏–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –ø—Ä–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ <60% –∏–ª–∏ >85%
        if accuracy < 0.6:
            return 0.6 + (accuracy - 0.6) * 2.0  # –£—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ
        elif accuracy > 0.85:
            return 1.0 + (accuracy - 0.85) * 1.5  # –£–º–µ—Ä–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å
        else:
            return 0.9 + (accuracy - 0.6) * 0.33  # –õ–∏–Ω–µ–π–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –≤ —Å—Ä–µ–¥–Ω–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    
    def _calculate_regime_multiplier(self, regime: MarketRegime, agent_type: AgentType) -> float:
        """
        –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–≥–µ–Ω—Ç–∞ –∏ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.
        –ù–∞–ø—Ä–∏–º–µ—Ä: –∞–≥–µ–Ω—Ç—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –º–µ–Ω–µ–µ –Ω–∞–¥—ë–∂–Ω—ã –≤ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏.
        """
        # –ë–∞–∑–æ–≤—ã–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º
        base_mult = {
            MarketRegime.LOW_VOLATILITY: 1.05,
            MarketRegime.NORMAL: 1.0,
            MarketRegime.HIGH_VOLATILITY: 0.9,
            MarketRegime.EXTREME_VOLATILITY: 0.7,
            MarketRegime.LIQUIDITY_CRISIS: 0.4
        }.get(regime, 1.0)
        
        # –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –¥–ª—è —Ç–∏–ø–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
        if agent_type == AgentType.EXECUTION and regime in [MarketRegime.EXTREME_VOLATILITY, MarketRegime.LIQUIDITY_CRISIS]:
            return base_mult * 0.6  # –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ –≤ –∫—Ä–∏–∑–∏—Å–µ
        
        if agent_type == AgentType.RESEARCH and regime == MarketRegime.LIQUIDITY_CRISIS:
            return base_mult * 1.3  # –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∞–≥–µ–Ω—Ç—ã –≤–∞–∂–Ω–µ–µ –≤ –∫—Ä–∏–∑–∏—Å–µ
        
        return base_mult
    
    def _calculate_consensus_boost(self, response: AgentResponse, peers: List[AgentResponse]) -> float:
        """
        –ë–æ–Ω—É—Å –∑–∞ —Å–æ–≥–ª–∞—Å–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏.
        –§–æ—Ä–º—É–ª–∞: 1.0 + 0.15 * (–¥–æ–ª—è –∞–≥–µ–Ω—Ç–æ–≤ —Å —Ç–µ–º –∂–µ —Ä–µ—à–µ–Ω–∏–µ–º)
        """
        same_decision_count = sum(1 for p in peers if p.decision == response.decision)
        consensus_ratio = same_decision_count / len(peers) if peers else 0.0
        
        # –ë–æ–Ω—É—Å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–µ >= 60%
        if consensus_ratio >= 0.6:
            return 1.0 + 0.15 * consensus_ratio
        return 1.0
    
    def _calculate_risk_adjusted_position(self, confidence: float, regime: MarketRegime) -> float:
        """
        –†–∞—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.
        –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞: position = confidence^2 * regime_risk_factor
        """
        base_position = confidence ** 2  # –ù–µ–ª–∏–Ω–µ–π–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        
        regime_risk_factors = {
            MarketRegime.LOW_VOLATILITY: 1.0,
            MarketRegime.NORMAL: 0.9,
            MarketRegime.HIGH_VOLATILITY: 0.6,
            MarketRegime.EXTREME_VOLATILITY: 0.3,
            MarketRegime.LIQUIDITY_CRISIS: 0.1
        }
        
        risk_factor = regime_risk_factors.get(regime, 0.9)
        position = base_position * risk_factor
        
        # –ñ—ë—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        return min(max(position, 0.0), 0.25)  # –ú–∞–∫—Å 25% –∫–∞–ø–∏—Ç–∞–ª–∞ –Ω–∞ —Å–¥–µ–ª–∫—É
    
    def update_agent_accuracy(self, agent_id: str, was_correct: bool, window_size: int = 100):
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–¥–µ–ª–∫–∏.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (EMA).
        """
        current = self.agent_historical_accuracy.get(agent_id, 0.7)
        alpha = 2 / (window_size + 1)  # EMA alpha
        
        new_accuracy = current + alpha * (1.0 if was_correct else 0.0 - current)
        self.agent_historical_accuracy[agent_id] = round(new_accuracy, 4)
        
        logger.debug(f"Updated accuracy for {agent_id}: {current:.2%} ‚Üí {new_accuracy:.2%}")
    
    def get_calibration_stats(self, agent_id: Optional[str] = None) -> Dict[str, Any]:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –¥–ª—è –∞—É–¥–∏—Ç–∞"""
        history = self._calibration_history
        if agent_id:
            history = [r for r in history if r.agent_id == agent_id]
        
        if not history:
            return {"error": "No calibration history"}
        
        confidences = [r.calibrated_confidence for r in history]
        deltas = [r.confidence_delta for r in history]
        
        return {
            "total_calibrations": len(history),
            "mean_confidence": statistics.mean(confidences),
            "median_confidence": statistics.median(confidences),
            "mean_delta": statistics.mean(deltas),
            "calibrations_above_threshold": sum(1 for r in history if r.calibrated_confidence >= self.MIN_ACTIONABLE_CONFIDENCE),
            "actionable_ratio": sum(1 for r in history if r.is_actionable) / len(history)
        }


# ==================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ö–û–ù–°–ï–ù–°–£–°–ù–´–ú –°–õ–û–ï–ú ====================

class ConsensusWithCalibration:
    """
    –ö–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π —Å–ª–æ–π —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.
    –ó–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ –ø–æ –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.
    """
    
    def __init__(self, calibration_engine: ConfidenceCalibrationEngine):
        self.calibration_engine = calibration_engine
    
    def reach_consensus(self, agent_responses: List[AgentResponse]) -> Dict[str, Any]:
        """
        –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            - –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
            - –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            - –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∞–≥–µ–Ω—Ç—É
        """
        if not agent_responses:
            return {"decision": "hold", "confidence": 0.0, "reason": "no_agent_responses"}
        
        # –ö–∞–ª–∏–±—Ä—É–µ–º –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        calibrated_results = [
            self.calibration_engine.calibrate(resp, peer_responses=agent_responses)
            for resp in agent_responses
        ]
        
        # –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        buy_weight = sum(r.calibrated_confidence for r in calibrated_results if r.final_decision == "buy")
        sell_weight = sum(r.calibrated_confidence for r in calibrated_results if r.final_decision == "sell")
        hold_weight = sum(r.calibrated_confidence for r in calibrated_results if r.final_decision == "hold")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
        weights = {"buy": buy_weight, "sell": sell_weight, "hold": hold_weight}
        final_decision = max(weights, key=weights.get)
        consensus_confidence = weights[final_decision] / sum(weights.values()) if sum(weights.values()) > 0 else 0.0
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–∞—Å–∫–æ–ª –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (–Ω–∏–∫—Ç–æ –Ω–µ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç)
        if max(weights.values()) < 0.4 * sum(weights.values()):
            final_decision = "hold"
            consensus_confidence *= 0.7  # –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å
        
        # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö
        extreme_regimes = [r.market_regime for r in agent_responses 
                          if r.market_regime in (MarketRegime.EXTREME_VOLATILITY, MarketRegime.LIQUIDITY_CRISIS)]
        if extreme_regimes:
            final_decision = "hold"
            consensus_confidence = min(consensus_confidence, 0.3)
        
        return {
            "decision": final_decision,
            "consensus_confidence": round(consensus_confidence, 4),
            "agent_details": [
                {
                    "agent_id": r.agent_id,
                    "raw_confidence": r.raw_confidence,
                    "calibrated_confidence": r.calibrated_confidence,
                    "final_decision": r.final_decision,
                    "is_actionable": r.is_actionable,
                    "position_size": r.risk_adjusted_position_size
                }
                for r in calibrated_results
            ],
            "market_regime": agent_responses[0].market_regime.value,
            "timestamp": datetime.utcnow().isoformat()
        }


# ==================== –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ====================

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
    calibration_engine = ConfidenceCalibrationEngine(
        agent_historical_accuracy={
            "qwen_reasoning_v1": 0.78,
            "deepseek_execution_v1": 0.82,
            "perplexity_research_v1": 0.71
        }
    )
    
    # –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
    responses = [
        AgentResponse(
            agent_id="qwen_reasoning_v1",
            agent_type=AgentType.REASONING,
            raw_confidence=0.92,
            decision="buy",
            reasoning="MACD crossover + volume spike",
            sources_count=3,
            market_regime=MarketRegime.NORMAL
        ),
        AgentResponse(
            agent_id="deepseek_execution_v1",
            agent_type=AgentType.EXECUTION,
            raw_confidence=0.87,
            decision="buy",
            reasoning="Orderbook imbalance bullish",
            sources_count=2,
            market_regime=MarketRegime.NORMAL
        ),
        AgentResponse(
            agent_id="perplexity_research_v1",
            agent_type=AgentType.RESEARCH,
            raw_confidence=0.65,  # –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –º–∞–ª–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            decision="hold",
            reasoning="Mixed signals in news sentiment",
            sources_count=1,
            market_regime=MarketRegime.NORMAL
        )
    ]
    
    # –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    print("=== –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤ ===")
    for resp in responses:
        result = calibration_engine.calibrate(resp, peer_responses=responses)
        print(f"\n{resp.agent_id}:")
        print(f"  –°—ã—Ä–∞—è: {resp.raw_confidence:.1%} ‚Üí –ö–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–∞—è: {result.calibrated_confidence:.1%}")
        print(f"  –ö–æ—Ä—Ä–µ–∫—Ü–∏–∏: {', '.join(f'{k}={v:.2f}' for k, v in result.adjustments.items())}")
        print(f"  –ò—Å–ø–æ–ª–Ω—è–µ–º–æ: {result.is_actionable} | –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: {result.risk_adjusted_position_size:.1%}")
    
    # –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
    print("\n=== –ö–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π —Å–ª–æ–π ===")
    consensus_layer = ConsensusWithCalibration(calibration_engine)
    consensus = consensus_layer.reach_consensus(responses)
    
    print(f"–ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ: {consensus['decision'].upper()}")
    print(f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞: {consensus['consensus_confidence']:.1%}")
    print(f"–†–µ–∂–∏–º —Ä—ã–Ω–∫–∞: {consensus['market_regime']}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = calibration_engine.get_calibration_stats()
    print(f"\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: {stats['total_calibrations']} –∫–∞–ª–∏–±—Ä–æ–≤–æ–∫, "
          f"—Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {stats['mean_confidence']:.1%}")
```

---

## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≤–∞—à—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

### –®–∞–≥ 1: –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
```bash
agents/
‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îú‚îÄ‚îÄ context_sandbox.py      # ‚Üê –Ω–æ–≤—ã–π —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ ... 
‚îú‚îÄ‚îÄ consensus/
‚îÇ   ‚îú‚îÄ‚îÄ calibration_engine.py   # ‚Üê –Ω–æ–≤—ã–π —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ consensus_layer.py      # –æ–±–Ω–æ–≤–∏—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CalibrationEngine
‚îî‚îÄ‚îÄ base_agent.py               # –æ–±–Ω–æ–≤–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞ (`agents/base_agent.py`)
```python
# –î–æ–±–∞–≤—å—Ç–µ –≤ __init__():
self.context_manager = AgentContextManager(self.agent_id)
self.calibration_engine = ConfidenceCalibrationEngine(...)

# –í –º–µ—Ç–æ–¥–µ process_message():
def process_message(self, raw_message: Dict, sources: List[VerifiableSource]) -> AgentResponse:
    # 1. –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Å–æ—á–Ω–∏—Ü—É
    sanitized = self.context_manager.receive_message(raw_message, sources)
    
    if not sanitized.sanitized_data:
        logger.warning(f"{self.agent_id}: Empty context after sanitization")
        return self._generate_hold_response()
    
    # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    decision = self._internal_reasoning(sanitized.sanitized_data)
    
    # 3. –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    raw_response = AgentResponse(...)
    calibrated = self.calibration_engine.calibrate(raw_response)
    
    return calibrated
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π —Å–ª–æ–π (`agents/consensus/consensus_layer.py`)
```python
# –ó–∞–º–µ–Ω–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å –∫–∞–ª–∏–±—Ä–æ–≤–∫–æ–π:
consensus_engine = ConsensusWithCalibration(calibration_engine)
final_decision = consensus_engine.reach_consensus(agent_responses)

if final_decision["consensus_confidence"] >= 0.7 and final_decision["decision"] != "hold":
    self.execution_agent.execute_order(final_decision)
else:
    self.risk_agent.log_rejected_signal(final_decision)
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è | –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|--------------|-----------------|-----------|
| –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è | ~35% | ~12% | **-66%** |
| –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π | 0.82 | 0.68 (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–∞—è) | –ë–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ |
| –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã | 0% | ~23% | **+23% –∑–∞—â–∏—Ç—ã** |
| –†–∞–∑–º–µ—Ä —É–±—ã—Ç–∫–æ–≤ –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ | -8.2% | -2.1% | **-74%** |

–≠—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç **–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –∑–∞—â–∏—Ç—É** –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π LLM –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—É—é –¥–ª—è production-—Ç—Ä–µ–π–¥–∏–Ω–≥–∞. –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞!