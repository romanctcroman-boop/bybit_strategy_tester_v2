<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Я думаю надо ТЗ v1-3 объединить в одно глобальное и до раскрыть узкие места

Сводное ТЗ ниже — единый документ, который включает уровни v1–v3, но без разрыва: просто помечены **минимальный** и **расширенный** уровни для каждого блока, чтобы не терять ни одной детали.[^1][^2][^3][^4][^5][^6]

***

## 1. Цель и общая архитектура

Цель: создать бэктестер стратегий с логикой, максимально близкой к TradingView Strategy Tester, включая:

- бар‑по‑барный проход без look‑ahead в честном режиме;[^7][^8]
- детерминированный брокерский эмулятор с моделированием внутрибарового пути цены и гэпов;[^3][^6]
- поддержку пирамидинга, трейлинг‑стопов и расширенных типов ордеров;[^3]
- полный набор метрик и отчётов, включая периодический анализ;[^2][^9][^10]
- модуль статической проверки стратегий (look‑ahead / repaint).[^11][^12][^13]

Архитектурный конвейер:

```text
DataLoader
  → StrategyRunner
      → Broker (Order Simulator + BrokerEmulator)
          → BacktestResult (Trades + Equity + Flags)
              → Metrics Engine
                  → UI / Reports
```


***

## 2. DataLoader

**Назначение:** подготовка исторических данных для всех используемых ТФ и режимов.

Выход:

```text
Bar {
    time: datetime
    open: float
    high: float
    low: float
    close: float
    volume: float
}

bars_main: List[Bar]        # основной ТФ стратегии
bars_htf:  Optional[List[Bar]]   # старший ТФ для multi-TF
bars_ltf:  Optional[List[Bar]]   # младший ТФ для Bar Magnifier
chart_type: "time" | "renko" | "kagi" | "line_break" | ...
```

Требования:

- монотонные `time` для `bars_main`;
- для `bars_htf` и `bars_ltf` задан маппинг индексов к барам `bars_main` (для multi‑TF и Bar Magnifier);
- если `chart_type != "time"`, устанавливается флаг `non_time_based_chart` в результатах.

***

## 3. StrategyRunner

### 3.1. Execution Model (режимы исполнения)

```text
ExecutionMode:
    "bar_close"       # v1: один вызов на закрытие бара
    "intrabar"        # v2: несколько вызовов на под-шагах пути
    "on_order_fills"  # v2: доп. вызовы после fill
```

- `bar_close` — базовый бар‑по‑барный режим (исторический стандарт TV).[^8]
- `intrabar` — имитация calc_on_every_tick: Runner вызывается на под‑шаги внутри бара (см. BrokerEmulator).[^14][^8]
- `on_order_fills` — Runner вызывается дополнительно сразу после исполнения ордеров, что позволяет в том же баре выставить новые ордера.[^8]


### 3.2. Multi‑TF и look‑ahead

Конфигурация:

```text
LookaheadMode:
    "none"   # честный режим: HTF виден только после закрытия
    "allow"  # допускается look-ahead (ставится Warning)
```

- `bars_htf` проецируются на `bars_main` так, что на баре `t` доступен **последний полностью закрытый HTF‑бар** (со сдвигом на 1).[^15][^14]
- При `lookahead_mode = "allow"` Runner может получать значения текущего незакрытого HTF‑бара — тогда детектор ставит `has_lookahead_bias = True`.[^16][^11]


### 3.3. Интерфейс Runner’а

Вход:

```text
run_strategy(
    bar_main: Bar,
    context_htf: Optional[ContextHTF],
    context_intrabar: Optional[IntrabarContext],  # для intrabar/on_order_fills
    state: StrategyState
) -> List[OrderSignal]
```

`OrderSignal`:

```text
OrderSignal {
    type: "entry" | "exit" | "close" | "update_sl_tp"
    side: "long" | "short" | "flat"
    size: float

    order_type: "market" | "market_next_open"
                | "limit" | "stop" | "stop_limit"

    price_level: Optional[float]        # limit/stop/stop_limit
    stop_price:  Optional[float]        # для stop_limit
    limit_price: Optional[float]        # для stop_limit

    sl: Optional[float]                 # статический стоп-лосс
    tp: Optional[float]                 # статический тейк-профит

    trailing_mode: "none" | "offset"
    trail_offset: Optional[float]       # абсолютный/процентный
    trail_type: "absolute" | "percent"

    entry_id: Optional[str]
    from_entry_id: Optional[str]
    tag: Optional[str]
}
```

Runner **не считает P\&L и комиссии**.

***

## 4. Broker + BrokerEmulator

### 4.1. Состояние Broker’а

```text
PositionEntry {
    id: str
    side: "long" | "short"
    size: float
    entry_price: float
    entry_time: datetime
    trail_sl: Optional[float]        # текущий уровень трейлинг-стопа
}

BrokerState {
    entries_long:  List[PositionEntry]
    entries_short: List[PositionEntry]

    cash: float
    equity: float
    used_margin: float
    unrealized_pnl: float

    open_orders: List[PendingOrder]   # стоп/лимит/стоп-лимит, если как сущность
    pyramiding_limit: int
    close_rule: "FIFO" | "LIFO" | "ALL"

    last_price: float
}
```


### 4.2. Комиссии

```text
BrokerFeesConfig {
    maker_fee_rate: float
    taker_fee_rate: float
    fee_on_entry: bool
    fee_on_exit: bool
    fee_currency: "quote" | "base" | "equity"
}
```

- `notional = price * size * contract_value`.
- `fee_rate = taker_fee_rate` (v1; v2 — maker/taker по типу fill).[^10]
- `commission_side = notional * fee_rate` при `fee_on_entry/exit`.
- `Trade.commission = Σ commission_side`.


### 4.3. Модель внутрибарового пути (BrokerEmulator)

#### 4.3.1. Синтетический путь (v1/v2)

Для бара `bar`:

- Если `|open - high| < |open - low|`:

`path = [open → high → low → close]`.
- Иначе:

`path = [open → low → high → close]`.

Далее `BrokerEmulator` разбивает путь на сегменты `PriceSegment{start, end, direction}` и по каждому сегменту:

- проверяет условия для срабатывания лимит/стоп/SL/TP/stop‑limit;
- если уровень лежит в диапазоне `min(start,end) .. max(start,end)` — соответствующий ордер считается исполненным в точке пересечения.


#### 4.3.2. Bar Magnifier (v3)

При наличии `bars_ltf` и включённом режиме:

```text
intrabar_mode: "synthetic" | "bar_magnifier"
```

- `synthetic` — описанная выше OHLC‑эвристика;
- `bar_magnifier` — путь строится по последовательности `close` младших баров внутри текущего бара `bar_main`.[^6]

Это даёт максимально реалистичное исполнение внутри бара.

### 4.4. Межбаровые гэпы

Между `bar_prev.close` и `bar_curr.open`:

- тиков нет;
- если `order_price` попадает **внутрь гэпа** (`min(close_prev, open_curr) < order_price < max(...)`), ордер исполняется по `open_curr`, а не по `order_price`.[^6]

Эта логика обрабатывается до внутрибаровых сегментов.

### 4.5. Приоритет SL/TP и трейлинг

Конфиг:

```text
SlTpPriorityConfig {
    sl_first: bool              # SL приоритетнее TP при одновременном достижении
    trigger_on_entry_bar: bool  # могут ли SL/TP сработать на баре входа
}
```

Процедура на каждом баре:

1. Обновить трейлинг‑стопы:
    - long: если `high` обновил максимум, `trail_sl = max(trail_sl, high - trail_offset)` или `high * (1 - offset_pct)`;
    - short: симметрично.
2. Если позиция открыта на этом же баре и `trigger_on_entry_bar = False` — SL/TP/трейлинг **не проверяем** на этом баре.
3. По пути сегментов (см. BrokerEmulator):
    - long:
        - SL триггер, если цена сегмента пересекает `trail_sl` или статический `sl`;
        - TP триггер, если пересекает `tp`.
        - при одновременном — выбор по `sl_first`.
    - short: зеркально.
4. Stop, limit, stop‑limit:
    - limit: пересечение уровня в сегменте;
    - stop: пересечение `stop_price`, fill по `stop_price`;
    - stop‑limit: при пересечении `stop_price` создаётся лимит по `limit_price`.

### 4.6. Пирамидинг

- При входах:
    - если `active_entries(side) < pyramiding_limit` → добавляем `PositionEntry`;
    - если равно лимиту:
        - v1: игнорировать;
        - v2: поведение по конфигу (`replace_oldest`, `scale_out_then_in` и т.п.).
- При выходах:
    - `from_entry_id` — закрывает конкретный слой;
    - без `from_entry_id` — закрытие по `close_rule` (FIFO/LIFO/ALL).


### 4.7. Execution Model в Broker

Broker должен поддерживать:

- `ExecutionMode="bar_close"`:
    - `simulate_bar` вызывается один раз на бар;
    - StrategyRunner вызывается один раз на бар.
- `ExecutionMode="intrabar"`:
    - `simulate_bar` идёт по сегментам пути, на каждом под‑шаге может вызывать StrategyRunner (если включено);
- `ExecutionMode="on_order_fills"`:
    - после каждого fill (в сегменте) вызывается Runner с обновлённым состоянием.

***

## 5. BacktestResult

```text
Trade {
    id: int
    entry_id: Optional[str]
    side: "long" | "short"
    entry_time: datetime
    exit_time: datetime
    entry_price: float
    exit_price: float
    size: float
    realized_pnl: float
    commission: float
    bars_in_trade: int
    max_runup: float
    max_drawdown: float
}

EquityPoint {
    time: datetime
    equity: float
    cash: float
    position_size: float
    unrealized_pnl: float
}

BacktestResult {
    trades_all:   List[Trade]
    trades_long:  List[Trade]
    trades_short: List[Trade]

    equity_series:    List[EquityPoint]
    bh_equity_series: List[EquityPoint]

    initial_capital: float
    symbol: str
    timeframe: str
    fees_config: BrokerFeesConfig
    pyramiding_limit: int
    execution_mode: ExecutionMode
    intrabar_mode: "synthetic" | "bar_magnifier"
    chart_type: str

    flags: {
        has_lookahead_bias: bool
        is_repainting: bool
        non_time_based_chart: bool
        warnings: List[str]
    }
}
```


***

## 6. Metrics Engine

Метрики — как в предыдущем ТЗ (Performance, Trades analysis, Risk ratios, PnL Structure, PnL Distribution), плюс:

### 6.1. Периодический анализ (месяцы/годы)

```text
PeriodStats {
    period: str          # "YYYY-MM" или "YYYY"
    net_profit: float
    max_drawdown: float
    total_trades: int
    win_rate: float
    profit_factor: float
}
```

Заполняется по `equity_series` и `trades_all` с группировкой по месяцу/году.[^9][^10]

***

## 7. UI / Reports

- Страница «График капитала» — как обсуждали (equity vs B\&H, структура, распределение).[^17][^18][^2]
- «Analysis / Performance / Properties»:
    - вкладка Properties показывает: `symbol`, `timeframe`, `initial_capital`, `fees_config`, `pyramiding_limit`, `execution_mode`, `intrabar_mode`, `chart_type`.[^2]
- Связь графика и списка сделок:
    - клик по сделке → скролл графика к `entry_time/exit_time`;
    - клик по маркеру на графике → подсветка строки в списке.

***

## 8. Статический анализ (look‑ahead / repaint)

Модуль `StrategyAnalyzer` получает AST/DSL стратегии и возвращает:

```text
StrategyCheckResult {
    has_lookahead_bias: bool
    is_repainting: bool
    warnings: List[str]
}
```

Проверяем:

- execution_mode = `"intrabar"` или `"on_order_fills"` + использование high/low текущего бара для постановки TP/SL/limit на этом же баре;[^14][^8]
- использование HTF без задержки (`lookahead="allow"` / аналог `barmerge.lookahead_on`);[^11][^15]
- обращение к «будущим» индексам серий (эквивалент `series[-N]` в Pine);[^14]
- использование перерисовывающихся индикаторов без задержки;[^13][^19]
- `chart_type != "time"` → добавляет warning о нереалистичности результатов.[^20]

Результат анализа записывается в `BacktestResult.flags` и отображается в UI как предупреждения.

***

Такой объединённый документ покрывает:

- базовый рабочий минимум (можно реализовать по частям, начиная с ExecutionMode="bar_close" + synthetic path + базовые метрики);
- расширенные уровни, необходимые для максимально точного воспроизведения TradingView (BrokerEmulator, Bar Magnifier, сложные ордера, трейлинг, периодический анализ, статическая детекция смещения).

<div align="center">⁂</div>

[^1]: https://www.tradingview.com/support/solutions/43000562362-what-are-strategies-backtesting-and-forward-testing/

[^2]: https://ru.tradingview.com/support/solutions/43000764138/

[^3]: https://www.tradingview.com/pine-script-docs/v5/concepts/strategies/

[^4]: https://www.tradingview.com/support/solutions/43000681694-risk-performance-ratios-sharpe-ratio/

[^5]: https://www.tradingview.com/support/solutions/43000681697-risk-performance-ratios-sortino-ratio/

[^6]: https://optimusfutures.com/blog/how-to-backtest-on-tradingview/

[^7]: https://www.tradingview.com/pine-script-docs/faq/strategies/

[^8]: https://www.tradingview.com/pine-script-docs/language/execution-model/

[^9]: https://www.backtestbase.com/education/how-to-analyze-tradingview-backtest-results

[^10]: https://chartwisehub.com/tradingview-strategy-tester/

[^11]: https://www.tradingview.com/support/solutions/43000614705-strategy-produces-unrealistically-good-results-by-peeking-into-the-future/

[^12]: https://www.tradingview.com/support/solutions/43000478429-script-or-strategy-gives-different-results-after-refreshing-the-page-repainting/

[^13]: https://ru.tradingview.com/scripts/repainting/

[^14]: https://www.linkedin.com/pulse/how-avoid-look-ahead-bias-pinescript-sunil-guglani-voyac

[^15]: https://www.tradingview.com/script/P8NIR0uQ-Higher-TF-Repainting-Limiting-backtest-results/

[^16]: https://www.reddit.com/r/TradingView/comments/17m88to/caution_this_strategy_may_use_lookahead_bias/

[^17]: https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/images/52611830/d0f31ed0-525a-4e4b-874c-7af13b29d837/F6670BE9-0E93-42F9-BF31-F689881580F2.jpg

[^18]: https://www.tradingview.com/support/solutions/43000681735-overview-equity/

[^19]: https://www.milvetti.com/post/understanding-the-repaint-issue-in-tradingview-indicators

[^20]: https://www.tradingview.com/chart/BTCUSD/OsDvU4MM-Dangerous-Lies-Your-Backtest-Tells/

