# Architecture

> Auto-generated by GSD Bootstrap — 2026-02-18

## System Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        External APIs                             │
│  Bybit REST API v5 ──────────────── Bybit WebSocket v5          │
│  (120 req/min rate limit)           (Real-time data)             │
└──────────────┬───────────────────────────┬──────────────────────┘
               │                           │
               ▼                           ▼
┌──────────────────────────────────────────────────────────────────┐
│  Adapters Layer (backend/services/adapters/)                      │
│  ├── bybit.py               Primary REST adapter                 │
│  ├── bybit_from_history.py  Historical data loader               │
│  ├── bybit_alembic.py       Bybit + migration support            │
│  └── binance.py             Binance adapter (secondary)          │
│  Rate limiting: exponential backoff on 429, retCode != 0 check   │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Data Layer                                                       │
│  ├── data.sqlite3           Main database (SQLAlchemy)            │
│  ├── bybit_klines_15m.db    Kline partition database              │
│  ├── backend/models/        SQLAlchemy models                     │
│  ├── backend/database/      DB session & connection               │
│  └── backend/migrations/    Alembic schema migrations             │
│  Policy: DATA_START_DATE=2025-01-01, RETENTION_YEARS=2            │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Strategy Layer                                                    │
│  ├── services/strategies/base.py    LibraryStrategy(BaseStrategy) │
│  ├── services/strategies/*.py       11 concrete strategies        │
│  │   ATRBreakout, DonchianBreakout, DCA, GridTrading,            │
│  │   RSIMeanReversion, BollingerBands, RSIMomentum,              │
│  │   StochasticMomentum, EMACrossover, MACDTrend, TripleEMA      │
│  └── backtesting/strategies/        Engine-coupled strategies     │
│  Contract: generate_signals(df) → DataFrame with 'signal' column  │
│  Signals: 1=long, -1=short, 0=no action                          │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Engine Layer (backend/backtesting/engines/)                       │
│  ├── fallback_engine_v4.py  ⭐ GOLD STANDARD — TradingView parity │
│  ├── fallback_engine_v3.py  Previous version                      │
│  ├── fallback_engine_v2.py  Deprecated (parity test reference)    │
│  ├── gpu_engine_v2.py       CUDA-accelerated                     │
│  ├── numba_engine_v2.py     JIT-compiled                         │
│  ├── dca_engine.py          Dollar-cost averaging                 │
│  └── event_driven_engine.py Event-driven simulation               │
│  Commission: 0.0007 (0.07%) — NEVER change                       │
│  Also: universal_engine/ (33 modules — experimental)              │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Metrics Layer (backend/core/)                                     │
│  ├── metrics_calculator.py  166 TradingView-parity metrics        │
│  ├── metrics.py             Base metric calculations              │
│  └── extended_metrics.py    Extended metric set                   │
│  Validation: Results must match TradingView within tolerance      │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Service Layer (backend/services/ — 52 files)                     │
│  ├── advanced_backtesting/  Walk-forward, Monte Carlo             │
│  ├── live_trading/          Paper/live trading                    │
│  ├── risk_management/       Position sizing, risk limits          │
│  ├── strategy_builder/      UI-driven strategy composition        │
│  └── unified_trading/       Unified trading interface             │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  API Layer (backend/api/)                                          │
│  ├── app.py                 FastAPI application factory           │
│  ├── routers/ (79 files)    753 total routes at /api/v1/         │
│  ├── middleware/             CORS, auth, rate limiting            │
│  └── Swagger UI at /docs                                          │
└──────────────┬───────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────────┐
│  Frontend Layer (frontend/)                                        │
│  ├── *.html (51 pages)       Static HTML                         │
│  ├── js/pages/               Page-specific JS                     │
│  │   └── strategy_builder.js ~3000 lines — main UI               │
│  ├── css/ (52 files)         Styling                             │
│  └── libs/                   Bundled JS libraries                 │
│  Served at: http://localhost:8000/frontend/                       │
└──────────────────────────────────────────────────────────────────┘
```

## Cross-Cutting Concerns

```
┌─────────────────────────────────────────────────────┐
│  AI Agent System (backend/agents/)                    │
│  LLM connections, autonomous operation                │
├─────────────────────────────────────────────────────┤
│  MCP Server (backend/mcp/ + mcp-server/)              │
│  6 registered tools: DB, API, backtest, strategy,     │
│  market data, metrics                                 │
├─────────────────────────────────────────────────────┤
│  Monitoring (backend/monitoring/)                      │
│  System health, performance profiling                 │
├─────────────────────────────────────────────────────┤
│  Queue (backend/queue/ + celery)                      │
│  Background tasks, async processing                   │
├─────────────────────────────────────────────────────┤
│  Security (backend/security/)                         │
│  Auth, vault integration                              │
├─────────────────────────────────────────────────────┤
│  Reliability (backend/reliability/)                    │
│  Circuit breaker, resilient HTTP client               │
└─────────────────────────────────────────────────────┘
```

## Component Dependencies (Import Direction)

```
Frontend → API → Services → Strategies → Engines → Metrics
                         ↘ Adapters → Bybit API
                         ↘ Database → Models
Core ←── (used by all backend layers)
Config ←── (used by all backend layers)
```

## Database Schema

- **Primary DB**: `data.sqlite3` — main application data
- **Kline DB**: `bybit_klines_15m.db` — market data partition
- **ORM**: SQLAlchemy with repository pattern
- **Async**: `asyncio.to_thread()` for blocking SQLite ops in async endpoints
- **Migrations**: Alembic (`alembic.ini` → `backend/migrations/`)

## Deployment Topologies

| Mode       | Components                                             |
| ---------- | ------------------------------------------------------ |
| Local dev  | uvicorn (4 workers) + SQLite + Redis                   |
| Docker     | Dockerfile → backend container                         |
| Kubernetes | helm/ + k8s/ manifests                                 |
| Services   | Redis, Kline DB Service, DB Maintenance, MCP, AI Agent |
