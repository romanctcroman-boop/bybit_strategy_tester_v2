{{- if .Values.workerHpaML.enabled }}
---
# CronJob for LSTM Model Auto-Retraining
# Runs every 6 hours to check model accuracy and retrain if needed

apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "bybit-strategy-tester.fullname" . }}-lstm-retrain
  labels:
    {{- include "bybit-strategy-tester.labels" . | nindent 4 }}
    app.kubernetes.io/component: lstm-retrain
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Don't run multiple retraining jobs concurrently
  
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      
      template:
        metadata:
          labels:
            {{- include "bybit-strategy-tester.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: lstm-retrain
        spec:
          restartPolicy: OnFailure
          
          serviceAccountName: {{ include "bybit-strategy-tester.fullname" . }}-worker
          
          containers:
            - name: lstm-retrain
              image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
              imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
              
              command:
                - python
                - -m
                - backend.services.ml_hpa_monitor
                - --check-interval=60
                - --retrain-interval=21600
                - --accuracy-threshold=0.8
              
              env:
                # Redis connection
                - name: REDIS_URL
                  value: "redis://{{ include "bybit-strategy-tester.fullname" . }}-redis:6379/0"
                
                # Kubernetes API
                - name: K8S_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                
                - name: HPA_NAME
                  value: "{{ include "bybit-strategy-tester.fullname" . }}-worker-hpa-ml"
                
                # LSTM configuration
                - name: LSTM_MODEL_DIR
                  value: "/models/lstm"
                
                - name: LSTM_CHECK_INTERVAL
                  value: "60"
                
                - name: LSTM_RETRAIN_INTERVAL
                  value: "21600"  # 6 hours
                
                - name: LSTM_ACCURACY_THRESHOLD
                  value: "0.8"
              
              resources:
                requests:
                  cpu: "500m"
                  memory: "1Gi"
                limits:
                  cpu: "2000m"
                  memory: "4Gi"
              
              volumeMounts:
                - name: models
                  mountPath: /models
          
          volumes:
            - name: models
              persistentVolumeClaim:
                claimName: {{ include "bybit-strategy-tester.fullname" . }}-lstm-models

---
# PersistentVolumeClaim for LSTM models
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "bybit-strategy-tester.fullname" . }}-lstm-models
  labels:
    {{- include "bybit-strategy-tester.labels" . | nindent 4 }}
    app.kubernetes.io/component: lstm-models
spec:
  accessModes:
    - ReadWriteMany  # Multiple pods can read model files
  storageClassName: {{ .Values.workerHpaML.modelStorageClass | default "standard" }}
  resources:
    requests:
      storage: {{ .Values.workerHpaML.modelStorageSize | default "5Gi" }}

{{- end }}
