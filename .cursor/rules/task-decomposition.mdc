---
description: Декомпозиция сложных задач, отслеживание переменных и зависимостей. Фазы АНАЛИЗ → ПЛАН → ВЫПОЛНЕНИЕ → ВАЛИДАЦИЯ.
alwaysApply: true
---

# Системный анализ и выполнение задач

## Обязательная декомпозиция сложных задач

- Перед началом любой сложной задачи: **остановись** и создай пошаговый план (используй TodoWrite для подзадач).
- Используй **LS** для понимания структуры директорий проекта.
- Используй **Grep** для точного поиска переменных, функций, импортов.
- Используй **SemanticSearch** для семантического поиска зависимостей и контекста.

## Отслеживание контекста

### Перед любым изменением

1. **Собери контекст переменных:**
   - Найди все определения: `Grep` по имени переменной/символа.
   - Найди все использования: `SemanticSearch` по смыслу (например: «где используется rsi_period»).
   - Просмотр файла с номерами строк: **Read** с `offset`/`limit` при необходимости.

2. **Карта зависимостей:**
   - Составь список импортов и зависимостей затронутых файлов.
   - Отследи цепочку вызовов функций (Grep по имени функции, SemanticSearch по сценарию).
   - Учитывай внешние API и библиотеки.

3. **Валидация перед действием:**
   - Пути — относительно корня проекта, без хардкода `d:\` (см. project.mdc).
   - Проверь существующие паттерны через SemanticSearch.
   - При работе в терминале — знай текущую директорию (например через `pwd`).

## Протокол выполнения задач

### ФАЗА 1: АНАЛИЗ

- Разбей задачу на минимум 3–5 подзадач (или используй TodoWrite).
- Определи входы/выходы каждой подзадачи.
- Выяви все значимые переменные и их области видимости.
- Построй граф зависимостей (модуль → функции → используемые сущности).

### ФАЗА 2: ПЛАН

- Сформируй детальный план выполнения.
- Укажи порядок изменений файлов.
- Определи точки проверки после каждого шага (линт, тесты, импорты).
- Для крупных изменений — кратко опиши план пользователю перед массовыми правками.

### ФАЗА 3: ВЫПОЛНЕНИЕ

- Выполняй по одной подзадаче за раз.
- После каждого изменения — быстрая валидация (импорты, синтаксис).
- Отслеживай затронутые переменные и модули.
- Обновляй список зависимостей при появлении новых связей.

### ФАЗА 4: ВАЛИДАЦИЯ

- Проверь импорты и экспорты (Grep по изменённым символам).
- Убедись, что переменные не потеряны при рефакторинге.
- При необходимости проверь типы (type hints, mypy).
- Запусти линтер (`ruff check`) и релевантные тесты (`pytest`).

## Отслеживание состояния

Для сложной задачи веди краткий лог:

- **Текущая задача:** [описание]
- **Подзадачи:** ☐ 1. … — переменные: [список]; ☐ 2. … — зависимости: [список]; ☑ 3. завершено
- **Активные переменные:** имя → тип, файл:строка, где используется
- **Зависимости:** модуль → функции/классы, от которых зависит изменение

## PROJECT_JOURNAL и сессии

- **В начале сессии:** прочитать `PROJECT_JOURNAL.md` (корень проекта), восстановить контекст и таблицу переменных (см. project-journal.mdc).
- **В конце сессии (сложная задача):** обновить таблицу переменных и решения в PROJECT_JOURNAL.md; оставить TODO для следующей сессии.
- **Текущая фаза/задача:** при длинной работе можно фиксировать в `.cursor/workflow_state.md`.

## Критические правила

- ❌ Не меняй код без понимания контекста (Grep/SemanticSearch/Read при необходимости).
- ❌ Не теряй существующие переменные при рефакторинге — проверь все использования.
- ❌ Не пропускай валидацию зависимостей после правок в нескольких файлах.
- ✅ Всегда используй пути относительно корня проекта (см. project.mdc).
- ✅ После изменений проверяй импорты и запускай линтер/тесты по затронутой области.
- ✅ Веди учёт изменённых переменных и модулей при многошаговых задачах.
