# üîß Engine Parity: –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –¥–≤–∏–∂–∫–æ–≤

## –î–∞—Ç–∞: 2026-01-27

## –°—Ç–∞—Ç—É—Å: ‚úÖ 5 –î–í–ò–ñ–ö–û–í –ì–û–¢–û–í–´ –ö –ü–†–û–î–ê–ö–®–ï–ù–£

---

## üìã –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—è—Ç–∏ –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–æ–≤—ã—Ö –¥–≤–∏–∂–∫–æ–≤ –∏ –∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–≤–∏–∂–∫–æ–≤

| –î–≤–∏–∂–æ–∫               | –Ø–∑—ã–∫      | –°–∫–æ—Ä–æ—Å—Ç—å | –¢–æ—á–Ω–æ—Å—Ç—å | Bar Magnifier | Pyramiding | Multi-TP | ATR SL/TP | Trailing |
| -------------------- | --------- | -------- | -------- | :-----------: | :--------: | :------: | :-------: | :------: |
| **FallbackEngineV2** | Python    | 1x       | 100%     |      ‚úÖ       |     ‚ùå     |    ‚ùå    |    ‚ùå     |    ‚ùå    |
| **FallbackEngineV3** | Python    | 1x       | 100%     |      ‚úÖ       |     ‚úÖ     |    ‚ùå    |    ‚ùå     |    ‚ùå    |
| **FallbackEngineV4** | Python    | 1x       | 100%     |      ‚úÖ       |     ‚úÖ     |    ‚úÖ    |    ‚úÖ     |    ‚úÖ    |
| **NumbaEngineV2**    | Numba JIT | 41x      | 100%     |      ‚úÖ       |     ‚ùå     |    ‚ùå    |    ‚ùå     |    ‚ùå    |
| **GPUEngineV2**      | CuPy/CUDA | 10-50x   | 100%     |      ‚úÖ       |     ‚ùå     |    ‚ùå    |    ‚ùå     |    ‚ùå    |

### –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å       | –û–ø–∏—Å–∞–Ω–∏–µ                                                            |
| ----------------- | ------------------------------------------------------------------- |
| **Bar Magnifier** | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 1M –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è SL/TP –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞   |
| **Pyramiding**    | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã –≤ –ø–æ–∑–∏—Ü–∏—é (N entries) —Å FIFO/LIFO/ALL –∑–∞–∫—Ä—ã—Ç–∏–µ–º |
| **Multi-TP**      | TP1/TP2/TP3/TP4 —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º (25%/25%/25%/25%)             |
| **ATR SL/TP**     | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ SL/TP –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)                    |
| **Trailing**      | Trailing Stop —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π –ø–æ % –ø—Ä–∏–±—ã–ª–∏                             |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É –¥–≤–∏–∂–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ö–ê–ö–û–ô –î–í–ò–ñ–û–ö –í–´–ë–†–ê–¢–¨?                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ùì –ù—É–∂–Ω—ã Multi-TP / DCA / ATR / Trailing?                      ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ –î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  FallbackEngineV4 (Gold Standard)             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ùì –ù—É–∂–µ–Ω Pyramiding (–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤)?                        ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ –î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  FallbackEngineV3                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ùì –ú–∞—Å—Å–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (10K+ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)?                     ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ –î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  GPUEngineV2 (–µ—Å–ª–∏ –µ—Å—Ç—å CUDA)                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ùì –ë—ã—Å—Ç—Ä–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (—Å–æ—Ç–Ω–∏ –ø—Ä–æ–≥–æ–Ω–æ–≤)?                       ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ –î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  NumbaEngineV2 (41x –±—ã—Å—Ç—Ä–µ–µ)                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ùì –ë–∞–∑–æ–≤—ã–π –±—ç–∫—Ç–µ—Å—Ç / –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è?                              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ –î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  FallbackEngineV2                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –¥–≤–∏–∂–∫–∞

### FallbackEngineV2 (–ë–∞–∑–æ–≤—ã–π —ç—Ç–∞–ª–æ–Ω)

- **–§–∞–π–ª**: `backend/backtesting/engines/fallback_engine_v2.py`
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~981
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
    - Pure Python —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    - 100% —Ç–æ—á–Ω–æ—Å—Ç—å (—ç—Ç–∞–ª–æ–Ω –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
    - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Bar Magnifier
    - –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ë–∞–∑–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### FallbackEngineV3 (Pyramiding)

- **–§–∞–π–ª**: `backend/backtesting/engines/fallback_engine_v3.py`
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~813
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
    - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∏—Ä–∞–º–∏–¥–∏–Ω–≥–∞ (pyramiding > 1)
    - –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ –¥–ª—è TP/SL
    - close_entries_rule: ALL, FIFO, LIFO
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤—Ö–æ–¥–∞–º–∏

### FallbackEngineV4 (Gold Standard) ‚≠ê

- **–§–∞–π–ª**: `backend/backtesting/engines/fallback_engine_v4.py`
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~2864
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
    - Multi-level TP (TP1, TP2, TP3, TP4) —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    - ATR-based TP/SL (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏)
    - Trailing Stop —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
    - –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å DCA (Safety Orders)
    - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ V2 –∏ V3
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: DCA —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, Multi-TP, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### NumbaEngineV2 (JIT-—É—Å–∫–æ—Ä–µ–Ω–∏–µ)

- **–§–∞–π–ª**: `backend/backtesting/engines/numba_engine_v2.py`
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~1277
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
    - 41x –±—ã—Å—Ç—Ä–µ–µ FallbackEngineV2
    - Numba JIT –∫–æ–º–ø–∏–ª—è—Ü–∏—è
    - 100% –ø–∞—Ä–∏—Ç–µ—Ç —Å Fallback
    - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Bar Magnifier
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –º–∞—Å—Å–æ–≤—ã–µ –ø—Ä–æ–≥–æ–Ω—ã

### GPUEngineV2 (CUDA —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

- **–§–∞–π–ª**: `backend/backtesting/engines/gpu_engine_v2.py`
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~912
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
    - 10-50x –±—ã—Å—Ç—Ä–µ–µ FallbackEngineV2
    - CuPy –¥–ª—è NVIDIA GPU
    - –¢—Ä–µ–±—É–µ—Ç CUDA-—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É
    - –ò–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (bit-level parity)
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ú–∞—Å—Å–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (10K+ –∏—Ç–µ—Ä–∞—Ü–∏–π)

---

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π –ü–∞—Ä–∏—Ç–µ—Ç

### BacktestMetrics (32 –º–µ—Ç—Ä–∏–∫–∏) ‚Äî 100% ‚úÖ

- `net_profit`, `total_return`, `gross_profit`, `gross_loss`
- `total_trades`, `winning_trades`, `losing_trades`, `win_rate`
- `max_drawdown`, `sharpe_ratio`, `sortino_ratio`, `calmar_ratio`
- `profit_factor`, `avg_win`, `avg_loss`, `avg_trade`
- `largest_win`, `largest_loss`, `expectancy`, `payoff_ratio`
- –ò –¥—Ä—É–≥–∏–µ...

### ExtendedMetrics (14 –º–µ—Ç—Ä–∏–∫) ‚Äî 100% ‚úÖ

- Omega Ratio, Ulcer Index, Gain-to-Pain Ratio
- Recovery Factor, Risk of Ruin, VaR/CVaR
- –ò –¥—Ä—É–≥–∏–µ...

### TradeRecord Fields ‚Äî 100% ‚úÖ

| –ü–æ–ª–µ            | –û–ø–∏—Å–∞–Ω–∏–µ             | –ü–∞—Ä–∏—Ç–µ—Ç |
| --------------- | -------------------- | :-----: |
| `entry_time`    | –í—Ä–µ–º—è –≤—Ö–æ–¥–∞          |   ‚úÖ    |
| `exit_time`     | –í—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞         |   ‚úÖ    |
| `direction`     | long/short           |   ‚úÖ    |
| `entry_price`   | –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞           |   ‚úÖ    |
| `exit_price`    | –¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞          |   ‚úÖ    |
| `size`          | –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏       |   ‚úÖ    |
| `pnl`           | Profit/Loss          |   ‚úÖ    |
| `pnl_pct`       | PnL –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö      |   ‚úÖ    |
| `fees`          | –ö–æ–º–∏—Å—Å–∏–∏ (exit only) |   ‚úÖ    |
| `exit_reason`   | SL/TP/Signal/EOD     |   ‚úÖ    |
| `duration_bars` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å         |   ‚úÖ    |

### Bar Magnifier (Intrabar) ‚Äî 100% ‚úÖ

- 60 subticks per 1H bar (1-minute data)
- Precise SL/TP detection within bar
- Sequential Inclusive Checks pattern

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      BacktestInput                               ‚îÇ
‚îÇ  (candles, signals, stop_loss, take_profit, Bar Magnifier...)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ                               ‚îÇ
              ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    FallbackEngineV2     ‚îÇ     ‚îÇ     NumbaEngineV2       ‚îÇ
‚îÇ    (Pure Python)        ‚îÇ     ‚îÇ     (Numba JIT)         ‚îÇ
‚îÇ                         ‚îÇ     ‚îÇ                         ‚îÇ
‚îÇ  ‚Ä¢ run()               ‚îÇ     ‚îÇ  ‚Ä¢ run()               ‚îÇ
‚îÇ  ‚Ä¢ _check_exit_cond()  ‚îÇ     ‚îÇ  ‚Ä¢ _simulate_trades()  ‚îÇ  ‚Üê @njit
‚îÇ  ‚Ä¢ _calculate_pnl()    ‚îÇ     ‚îÇ  ‚Ä¢ _simulate_with_bm() ‚îÇ  ‚Üê @njit
‚îÇ  ‚Ä¢ _calculate_metrics()‚îÇ     ‚îÇ  ‚Ä¢ _calculate_metrics()‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                               ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      BacktestOutput                             ‚îÇ
‚îÇ  (metrics, trades, equity_curve, timestamps...)                ‚îÇ
‚îÇ  ‚úÖ –ò–î–ï–ù–¢–ò–ß–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. LAER (Legacy Asset Equity Reconstruction)

```python
Equity = Cash + Notional_Value + Unrealized_PnL
```

### 2. Positional Epsilon ($1.00 USD)

```python
if allocated >= 1.0:  # Minimum $1.00 to open position
    open_position(...)
```

### 3. Last Bar Lockdown

```python
if entry_signal and (i < n - 1):  # No entry on last bar
    open_position(...)
```

### 4. Bar Magnifier Layering (Sequential Inclusive Checks)

1. **Phase 1 (Granular)**: Check 1-minute subticks for SL/TP
2. **Phase 2 (Fallback)**: If Phase 1 didn't trigger, check bar High/Low

### 5. Entry Bar Protection

- SL/TP checks start from **next bar** after entry (not same bar)

---

## üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è

### Test Script: `scripts/test_intrabar_engines_comparison.py`

```
   üî¨ INTRABAR –°–†–ê–í–ù–ï–ù–ò–ï: FallbackEngineV2 vs NumbaEngineV2

   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –ö–†–ò–¢–ï–†–ò–ô                        ‚îÇ –†–ï–ó–£–õ–¨–¢–ê–¢                ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç     ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îÇ Net Profit —Å–æ–≤–ø–∞–¥–∞–µ—Ç            ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îÇ Exit Reasons —Å–æ–≤–ø–∞–¥–∞—é—Ç          ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îÇ –í—Å–µ —Å–¥–µ–ª–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã (PnL)      ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îÇ Bar Magnifier –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1M     ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îÇ Intrabar SL/TP –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è    ‚îÇ           ‚úÖ –î–ê           ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Test Script: `scripts/test_147_metrics_full.py`

```
   üìã –ò–¢–û–ì–ò:
   ‚îú‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: 4
   ‚îú‚îÄ Core –º–µ—Ç—Ä–∏–∫–∏ (46):           100.00%
   ‚îî‚îÄ –ù–µ–Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:          490+
```

---

## üìÅ –§–∞–π–ª—ã

| –§–∞–π–ª                                                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                      |
| --------------------------------------------------- | ------------------------------- |
| `backend/backtesting/engines/fallback_engine_v2.py` | Reference Python implementation |
| `backend/backtesting/engines/numba_engine_v2.py`    | JIT-optimized implementation    |
| `backend/backtesting/interfaces.py`                 | Shared Input/Output dataclasses |
| `backend/core/extended_metrics.py`                  | Extended risk metrics           |
| `backend/core/metrics_calculator.py`                | Trade/Risk/LongShort metrics    |

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç 2026-01-18

### NumbaEngineV2 Updates:

1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –º–∞—Å—Å–∏–≤—ã `trade_sizes[]`, `trade_fees[]`** –≤ –æ–±–µ JIT-—Ñ—É–Ω–∫—Ü–∏–∏:
    - `_simulate_trades_numba`
    - `_simulate_with_bar_magnifier`

2. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è fees**: –¢–µ–ø–µ—Ä—å –æ–±–∞ –¥–≤–∏–∂–∫–∞ —Ö—Ä–∞–Ω—è—Ç —Ç–æ–ª—å–∫–æ `exit_fee` (–Ω–µ total)

3. **Entry fee tracking**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `long_entry_fee`, `short_entry_fee`

4. **`_build_trade_records`**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Numba –≤–º–µ—Å—Ç–æ –æ—Ü–µ–Ω–æ–∫

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ FallbackEngineV2 –∫–æ–≥–¥–∞:

- üß™ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞
- üìä –ù—É–∂–Ω—ã –≤—Å–µ –ø–æ–ª—è TradeRecord —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
- üîç –ù–µ–±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ (< 5000 –±–∞—Ä–æ–≤)

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NumbaEngineV2 –∫–æ–≥–¥–∞:

- üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Å–æ—Ç–Ω–∏ –ø—Ä–æ–≥–æ–Ω–æ–≤)
- üìà –ë–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ (> 10000 –±–∞—Ä–æ–≤)
- ‚è±Ô∏è –ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π                | FallbackEngineV2 | NumbaEngineV2 | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
| ----------------------- | :--------------: | :-----------: | :-------: |
| 500 –±–∞—Ä–æ–≤               |      ~0.02s      |    ~0.005s    |    4x     |
| 2000 –±–∞—Ä–æ–≤              |      ~0.08s      |    ~0.01s     |    8x     |
| 10000 –±–∞—Ä–æ–≤             |      ~0.4s       |    ~0.05s     |    8x     |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (1000 runs) |       ~80s       |     ~10s      |    8x     |

_–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ NumbaEngineV2 –≤–∫–ª—é—á–∞–µ—Ç JIT-–∫–æ–º–ø–∏–ª—è—Ü–∏—é (~1-3 —Å–µ–∫)_

---

## üèÜ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà                                                                  ‚ñà
‚ñà   ‚úÖ CERTIFIED: 100% BIT-LEVEL PARITY                           ‚ñà
‚ñà                                                                  ‚ñà
‚ñà   ‚Ä¢ FallbackEngineV2 = NumbaEngineV2                            ‚ñà
‚ñà   ‚Ä¢ All 46 core metrics match                                   ‚ñà
‚ñà   ‚Ä¢ All TradeRecord fields match                                ‚ñà
‚ñà   ‚Ä¢ Bar Magnifier fully operational                             ‚ñà
‚ñà                                                                  ‚ñà
‚ñà   Date: 2026-01-18                                              ‚ñà
‚ñà                                                                  ‚ñà
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
```
