# ‚úÖ Strategy Builder - Phase 2 Complete

> **–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 2026-01-29  
> **–°—Ç–∞—Ç—É—Å**: Phase 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ Phase 2

### ‚úÖ 1. StrategyBuilderAdapter

**–§–∞–π–ª**: `backend/backtesting/strategy_builder_adapter.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**:
- ‚úÖ –ö–ª–∞—Å—Å `StrategyBuilderAdapter` –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `BaseStrategy`
- ‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ graph (blocks + connections) –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
- ‚úÖ –¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–ª–æ–∫–æ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
  - Indicators (RSI, MACD, EMA, SMA, Bollinger, ATR, Stochastic, ADX)
  - Conditions (crossover, crossunder, greater_than, less_than, equals, between)
  - Logic (and, or, not, delay, filter)
  - Inputs (price, volume, constant, timeframe)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ (entries, exits, short_entries, short_exits)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç vectorbt –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –±–ª–æ–∫–æ–≤ –∏–∑ frontend
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `SignalResult` —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å –¥–≤–∏–∂–∫–∞–º–∏ –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞

---

### ‚úÖ 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BacktestEngine

**–§–∞–π–ª**: `backend/backtesting/engine.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `custom_strategy: Optional[BaseStrategy] = None` –≤ –º–µ—Ç–æ–¥ `run()`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è registry
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```python
engine = BacktestEngine()
result = engine.run(config, ohlcv, custom_strategy=adapter)
```

---

### ‚úÖ 3. –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Backtest Endpoint

**–§–∞–π–ª**: `backend/api/routers/strategy_builder.py`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç**: `POST /api/v1/strategy-builder/strategies/{id}/backtest`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**:
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑ –ë–î
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è –±–ª–æ–∫–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `StrategyBuilderAdapter` –∏–∑ graph
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –¥–≤–∏–∂–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ features —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
  - Multi-TP / ATR ‚Üí FallbackEngineV4
  - Pyramiding ‚Üí FallbackEngineV3
  - –ò–Ω–∞—á–µ ‚Üí NumbaEngineV2 (–±—ã—Å—Ç—Ä–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `BacktestService`
- ‚úÖ –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞ —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç `backtest_id` –∏ `redirect_url`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞**:
```json
{
  "start_date": "2024-01-01T00:00:00Z",
  "end_date": "2024-12-31T23:59:59Z",
  "engine": "auto",  // –∏–ª–∏ "fallback_v4", "numba_v2", etc.
  "commission": 0.0007,
  "slippage": 0.0005,
  "leverage": 10,
  "pyramiding": 1,
  "stop_loss": 0.02,
  "take_profit": 0.03
}
```

**–û—Ç–≤–µ—Ç**:
```json
{
  "backtest_id": "backtest_xyz789",
  "strategy_id": "strategy_abc123",
  "status": "completed",
  "results": {
    "total_return": 0.15,
    "sharpe_ratio": 1.2,
    "win_rate": 0.55,
    "total_trades": 120,
    "max_drawdown": 0.08
  },
  "redirect_url": "/frontend/backtest-results.html?backtest_id=backtest_xyz789"
}
```

---

### ‚úÖ 4. –¢–µ—Å—Ç—ã

**–§–∞–π–ª**: `tests/backend/api/test_strategy_builder.py`

**–°–æ–∑–¥–∞–Ω–æ**:
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è backtest endpoint

**–ü–æ–∫—Ä—ã—Ç–∏–µ**:
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (404, 400, 422)
- Pagination

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### StrategyBuilderAdapter Architecture

```
Strategy Graph (JSON)
  ‚Üì
StrategyBuilderAdapter.__init__()
  ‚Üì
_build_execution_order()  # Topological sort
  ‚Üì
generate_signals(ohlcv)
  ‚Üì
  For each block in execution_order:
    _execute_block()
      ‚Üì
    _execute_indicator() / _execute_condition() / etc.
      ‚Üì
    Cache outputs in _value_cache
  ‚Üì
Collect signals from main_strategy node
  ‚Üì
Return SignalResult
```

### Engine Selection Logic

```python
if has_multi_tp or has_atr:
    engine = "fallback_v4"  # Only V4 supports these
elif has_pyramiding:
    engine = "fallback_v3"  # V3 supports pyramiding
else:
    engine = "numba_v2"  # Fast optimization
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **StrategyBuilderAdapter**:
   - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–∞ –∏–∑ –ø—Ä–æ—Å—Ç–æ–≥–æ graph (RSI strategy)
   - [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
   - [ ] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
   - [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

2. **Backtest Integration**:
   - [ ] –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ API
   - [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î
   - [ ] –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)

3. **End-to-End**:
   - [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —á–µ—Ä–µ–∑ UI
   - [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
   - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫—Ç–µ—Å—Ç
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Phase 2

- **–°–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 2
  - `backend/backtesting/strategy_builder_adapter.py` (~400 —Å—Ç—Ä–æ–∫)
  - `tests/backend/api/test_strategy_builder.py` (~300 —Å—Ç—Ä–æ–∫)
- **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 2
  - `backend/backtesting/engine.py` (+custom_strategy parameter)
  - `backend/api/routers/strategy_builder.py` (–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è backtest)
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ**: ~700

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (Phase 3)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. ‚è≥ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ flow**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

2. ‚è≥ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases
   - –£–ª—É—á—à–µ–Ω–∏–µ error messages

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
3. ‚è≥ **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–ª–æ–∫–æ–≤**
   - –ë–æ–ª—å—à–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –ë–æ–ª—å—à–µ —É—Å–ª–æ–≤–∏–π
   - –ë–æ–ª—å—à–µ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

4. ‚è≥ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
5. ‚è≥ **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**
6. ‚è≥ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**
7. ‚è≥ **Undo/Redo**

---

## üìù –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ù–µ –≤—Å–µ –±–ª–æ–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è** - –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ —É—Å–ª–æ–≤–∏—è
2. **–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π** (buy/sell –±–ª–æ–∫–∏ –ø–æ–∫–∞ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞–ø—Ä—è–º—É—é)
3. **–ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞** - –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –µ—Å—Ç—å, –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
4. **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤ –ø–æ—Ä—Ç–æ–≤ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –∞–¥–∞–ø—Ç–µ—Ä–µ

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](./architecture/STRATEGY_BUILDER_ARCHITECTURE.md)
- [AI Guide](../.agent/docs/STRATEGY_BUILDER_AI_GUIDE.md)
- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ](./STRATEGY_BUILDER_TECHNICAL_SPECIFICATION.md)
- [Phase 1 Complete](./STRATEGY_BUILDER_PHASE1_COMPLETE.md)

---

**Phase 2 Status**: ‚úÖ **COMPLETE**  
**Ready for**: Testing & Bug Fixes
