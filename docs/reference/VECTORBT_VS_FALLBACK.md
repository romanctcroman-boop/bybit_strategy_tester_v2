# VectorBT vs Fallback Engine: Полное сравнение

## 🎯 Краткий ответ

**VectorBT нельзя использовать без Fallback по нескольким причинам:**

1. **Нет тиковых данных** — VectorBT работает только с OHLC свечами
2. **Нет точного SL/TP** — VectorBT не может проверять SL/TP внутри бара
3. **Quick Reversals** — VectorBT может открыть позицию на том же баре, где закрыл предыдущую
4. **Fixed Position Sizing** — VectorBT не пересчитывает размер позиции по текущему капиталу
5. **Параллельная обработка** — VectorBT обрабатывает все сигналы одновременно, а не последовательно

---

## 📊 Детальное сравнение

| Функция | VectorBT | Fallback |
|---------|----------|----------|
| **Скорость** | ⚡ 5-10x быстрее | 🐢 Стандартная |
| **Точность** | ~85% | ✅ 100% |
| **Intrabar SL/TP** | ❌ Нет (только Close) | ✅ Да (High/Low) |
| **MAE/MFE** | ❌ Нет | ✅ Полный расчёт |
| **Trailing Stop** | ❌ Нет | ✅ Да |
| **Equity-Based Sizing** | ❌ Fixed order_value | ✅ Пересчёт по капиталу |
| **Quick Reversals** | ⚠️ Разрешено | ✅ Блокировано |
| **Bar Magnifier (1m)** | ❌ Нет | ✅ Поддержка |
| **Tick Data** | ❌ Нет | ⚠️ OHLC симуляция |
| **GPU Acceleration** | ✅ Если доступно | ❌ CPU only |
| **Parallelization** | ✅ Векторизация | ❌ Последовательно |

---

## ❌ Что VectorBT НЕ может

### 1. Intrabar Stop Loss / Take Profit
```
VectorBT: SL/TP проверяется только по CLOSE цене бара
Fallback: SL/TP проверяется по HIGH/LOW внутри бара

Пример:
  Открыли лонг по 100
  SL = 97 (3%)
  
  Бар: Open=100, High=105, Low=96, Close=104
  
  VectorBT: Позиция ОТКРЫТА (Close > SL)
  Fallback: Позиция ЗАКРЫТА (Low < SL = сработал стоп)
```

### 2. MAE/MFE (Maximum Adverse/Favorable Excursion)
```
VectorBT: Не рассчитывает MAE/MFE
Fallback: Для каждой сделки отслеживает:
  - MFE = максимальная нереализованная прибыль
  - MAE = максимальный нереализованный убыток
```

### 3. Equity-Based Position Sizing
```
VectorBT: order_value = FIXED (например 1000 USD)
Fallback: order_value = equity * position_pct

Пример:
  Стартовый капитал: 10000
  Position size: 10%
  
  После прибыли +20%:
  VectorBT: order = 1000 USD (не изменился)
  Fallback: order = 12000 * 0.1 = 1200 USD (вырос с капиталом)
```

### 4. Quick Reversals Prevention
```
VectorBT: Может открыть новую позицию на том же баре, где закрыл предыдущую
Fallback: Блокирует открытие на том же баре (имитирует реальный трейдинг)

Результат: VectorBT генерирует больше сделок (иногда +25%)
```

### 5. Bar Magnifier (1-minute resolution)
```
VectorBT: Работает только с основным таймфреймом
Fallback: Может использовать 1-минутные свечи для симуляции внутрибаровых движений

Это даёт:
  - Более точное срабатывание SL/TP
  - Реалистичное заполнение ордеров
  - Правильный порядок High/Low
```

### 6. Trailing Stop
```
VectorBT: Не поддерживает
Fallback: Полная поддержка trailing stop с настраиваемым шагом
```

---

## ✅ Когда использовать VectorBT

### Только для оптимизации:
- Сотни тысяч комбинаций параметров
- Важен **относительный рейтинг**, не абсолютные значения
- Two-Stage: VectorBT отсеивает плохие комбинации, Fallback валидирует лучшие

### НЕ использовать для:
- Финального бэктеста
- Когда важна точность метрик
- Для стратегий с SL/TP
- Для сохранения результатов в БД

---

## 📈 Two-Stage Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  STAGE 1: VectorBT Screening                                │
│  ───────────────────────────────                            │
│  - Тестирует ВСЕ комбинации (например 10,000)              │
│  - Быстро (~5,000 комб/сек)                                 │
│  - Отбирает TOP-N кандидатов (например 50)                 │
│  - Точность: ~85% (достаточно для ранжирования)            │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  STAGE 2: Fallback Validation                               │
│  ────────────────────────────────                           │
│  - Тестирует только TOP-N кандидатов                       │
│  - Медленно (~1 комб/сек)                                   │
│  - Полная точность (100%)                                   │
│  - Intrabar SL/TP, MAE/MFE, все метрики                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌───────────────────────┐
              │  FINAL RESULT         │
              │  ─────────────        │
              │  Best Params + Metrics│
              │  Saved to Database    │
              └───────────────────────┘
```

---

## 🔬 Эмпирические различия

Тесты показали следующие расхождения:

| Направление | VectorBT сделок | Fallback сделок | Разница |
|-------------|-----------------|-----------------|---------|
| LONG only   | 5               | 4               | +25%    |
| SHORT only  | 6               | 6               | 0%      |
| BOTH        | 10              | 8               | +25%    |

| Метрика      | VectorBT | Fallback | Разница |
|--------------|----------|----------|---------|
| Net Profit   | -8,500   | -9,200   | ~8%     |
| Sharpe Ratio | -1.2     | -1.4     | ~15%    |
| Win Rate     | 28%      | 25%      | ~12%    |

---

## 📝 Заключение

**VectorBT — это инструмент для БЫСТРОГО скрининга, не для точного тестирования.**

Правильная архитектура:
1. VectorBT отсеивает 99% плохих комбинаций параметров
2. Fallback финально тестирует оставшиеся 1%
3. Все метрики берутся из Fallback (authoritative source)
