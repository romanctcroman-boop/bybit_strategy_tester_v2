# VectorBT vs Fallback Engine: –ü–ª–∞–Ω –£–ª—É—á—à–µ–Ω–∏–π

## –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π

| AI Agent | –°—Ç–∞—Ç—É—Å | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|--------|-----------|
| **DeepSeek** | ‚úÖ –£—Å–ø–µ—à–Ω–æ | 34 KB, 649 —Å—Ç—Ä–æ–∫, 8507 —Ç–æ–∫–µ–Ω–æ–≤ |
| **Perplexity** | ‚ùå –ö–ª—é—á–∏ –∏—Å—Ç–µ–∫–ª–∏ | 401 Unauthorized –Ω–∞ –≤—Å–µ—Ö –∫–ª—é—á–∞—Ö |

---

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –æ—Ç DeepSeek

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç |
|-----------|--------|-----------|------------------|
| üî¥ **–í—ã—Å–æ–∫–∏–π** | Quick Reversals Prevention | –õ—ë–≥–∫–∞—è | –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ 25% |
| üî¥ **–í—ã—Å–æ–∫–∏–π** | Numba JIT –¥–ª—è Fallback | –°—Ä–µ–¥–Ω—è—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ 10-100x |
| üî¥ **–í—ã—Å–æ–∫–∏–π** | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | –°—Ä–µ–¥–Ω—è—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ N —Ä–∞–∑ (N = CPU —è–¥—Ä–∞) |
| üü° **–°—Ä–µ–¥–Ω–∏–π** | Equity-Based Sizing –≤ VectorBT | –°—Ä–µ–¥–Ω—è—è | –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ |
| üü° **–°—Ä–µ–¥–Ω–∏–π** | –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è SL/TP | –°—Ä–µ–¥–Ω—è—è | ~5% —É–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ |
| üü¢ **–ù–∏–∑–∫–∏–π** | –ü–æ–ª–Ω–∞—è —ç–º—É–ª—è—Ü–∏—è intrabar –≤ VectorBT | –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç |

---

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: Quick Wins (1-2 –¥–Ω—è)

#### 1.1 Quick Reversals Prevention –≤ VectorBT

```python
# –¢–ï–ö–£–©–ò–ô –ö–û–î (–ø—Ä–æ–±–ª–µ–º–∞)
portfolio = vbt.Portfolio.from_signals(close, entries, exits)

# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
portfolio = vbt.Portfolio.from_signals(
    close=df['close'],
    entries=entries,
    exits=exits,
    delay=1,  # –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 1 –±–∞—Ä
    min_duration=1,  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏
    upon_long_conflict='ignore',
    upon_short_conflict='ignore',
)
```

#### 1.2 –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è SL/TP

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ VectorBT preprocessing
def conservative_sl_check(entries, exits, low, sl_prices):
    """–°—á–∏—Ç–∞–µ–º —á—Ç–æ —Å—Ç–æ–ø —Å—Ä–∞–±–æ—Ç–∞–ª –µ—Å–ª–∏ Low <= SL"""
    sl_hits = low <= sl_prices
    exits_adjusted = exits | sl_hits
    return exits_adjusted
```

### –§–∞–∑–∞ 2: –£—Å–∫–æ—Ä–µ–Ω–∏–µ Fallback (3-5 –¥–Ω–µ–π)

#### 2.1 Numba JIT –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–∏–∫–ª–æ–≤

```python
from numba import njit, prange

@njit(parallel=True)
def backtest_core_nb(open, high, low, close, signals, sl_pct, tp_pct, initial_capital):
    """–Ø–¥—Ä–æ –±—ç–∫—Ç–µ—Å—Ç–µ—Ä–∞, –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º–æ–µ Numba"""
    n = len(close)
    equity = np.full(n, initial_capital)
    
    for i in prange(1, n):
        # –ò–Ω—Ç—Ä–∞–±–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SL/TP
        if position[i-1] > 0:  # Long
            sl_price = entry_price * (1 - sl_pct)
            if low[i] <= sl_price:
                # –°—Ç–æ–ø —Å—Ä–∞–±–æ—Ç–∞–ª
                exit_price = sl_price
                equity[i] = equity[i-1] + (exit_price - entry_price) * position
    
    return equity
```

#### 2.2 –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π

```python
from concurrent.futures import ProcessPoolExecutor

def parallel_backtest(param_list, data, n_workers=8):
    with ProcessPoolExecutor(max_workers=n_workers) as executor:
        results = list(executor.map(run_single_backtest, param_list))
    return results
```

### –§–∞–∑–∞ 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1 –Ω–µ–¥–µ–ª—è)

#### 3.1 –£–ª—É—á—à–µ–Ω–Ω–∞—è Two-Stage –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
STAGE 1: VectorBT (–±—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–Ω–∏–Ω–≥)
  + delay=1, min_duration=1
  + –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏–∏ SL/TP
  + –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π equity sizing
  ‚Üí Output: Top 100-200 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤

STAGE 2: Numba-—É—Å–∫–æ—Ä–µ–Ω–Ω—ã–π Fallback
  + JIT –∫–æ–º–ø–∏–ª—è—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
  + –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  + –ü–æ–ª–Ω–∞—è –∏–Ω—Ç—Ä–∞–±–∞—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  ‚Üí Output: Top 10-20 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

STAGE 3: –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  + Out-of-sample —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  + –†–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –¶–µ–ª—å |
|---------|---------|------|
| –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ —Å–¥–µ–ª–∫–∞–º | +25% | <5% |
| –°–∫–æ—Ä–æ—Å—Ç—å Fallback | 1 –∫–æ–º–±/—Å–µ–∫ | 50+ –∫–æ–º–±/—Å–µ–∫ |
| –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ Sharpe | 15% | <3% |
| –í—Ä–µ–º—è –ø–æ–ª–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (10,000 –∫–æ–º–±) | ~3 —á–∞—Å–∞ | ~30 –º–∏–Ω—É—Ç |

---

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **`backend/backtesting/engine.py`** ‚Äî Numba JIT –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Fallback
2. **`backend/backtesting/two_stage_optimizer.py`** ‚Äî Quick reversals fix –¥–ª—è VectorBT
3. **`backend/backtesting/gpu_optimizer.py`** ‚Äî –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å Quick Reversals fix –∫ VectorBT
2. [ ] –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å Fallback (–Ω–∞–π—Ç–∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞)
3. [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å Numba JIT –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ü–∏–∫–ª–∞–º
4. [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
5. [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–æ/–ø–æ—Å–ª–µ

---

## –°—Å—ã–ª–∫–∏

- DeepSeek –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: `deepseek_vectorbt_full_consultation.md`
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–≤–∏–∂–∫–æ–≤: `docs/ENGINE_ARCHITECTURE.md`
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤–∏–∂–∫–æ–≤: `docs/VECTORBT_VS_FALLBACK.md`
