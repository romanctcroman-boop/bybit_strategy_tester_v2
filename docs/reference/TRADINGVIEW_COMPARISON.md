# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—ç–∫—Ç–µ—Å—Ç–µ—Ä–∞ —Å TradingView Strategy Tester

## üìä –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞—à–µ–≥–æ –±—ç–∫—Ç–µ—Å—Ç-–¥–≤–∏–∂–∫–∞ –ª–æ–≥–∏–∫–µ TradingView Strategy Tester –∏ –≤—ã—è–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è.

---

## ‚úÖ –ß—Ç–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å TradingView

### 1. –†–∞—Å—á–µ—Ç –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –ü/–£ (Unrealized P&L)

**TradingView —Ñ–æ—Ä–º—É–ª–∞:**
```
Unrealized P&L = (–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞) √ó –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
```

**–ù–∞—à –¥–≤–∏–∂–æ–∫ (`engine.py`, —Å—Ç—Ä–æ–∫–∏ 647-654):**
```python
if position > 0:
    if is_long:
        unrealized_pnl = (price - entry_price) * position * leverage
    else:
        unrealized_pnl = (entry_price - price) * position * leverage
    current_equity = cash + entry_price * position + unrealized_pnl
```

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** - —Ä–∞—Å—á–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω

### 2. –û—Ü–µ–Ω–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ü–µ–Ω–µ –∑–∞–∫—Ä—ã—Ç–∏—è (close)

**TradingView:** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `close` –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏

**–ù–∞—à –¥–≤–∏–∂–æ–∫:**
```python
close = ohlcv["close"].values
price = close[i]  # –ò—Å–ø–æ–ª—å–∑—É–µ–º close –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
```

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**

### 3. MFE/MAE (Maximum Favorable/Adverse Excursion)

**TradingView:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç high/low –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–ù–∞—à –¥–≤–∏–∂–æ–∫ (`engine.py`, —Å—Ç—Ä–æ–∫–∏ 553-558):**
```python
if is_long:
    max_favorable_price = max(max_favorable_price, current_high)
    max_adverse_price = min(max_adverse_price, current_low)
else:
    max_favorable_price = min(max_favorable_price, current_low)
    max_adverse_price = max(max_adverse_price, current_high)
```

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** - –∏—Å–ø–æ–ª—å–∑—É–µ–º high/low –¥–ª—è MFE/MAE

### 4. –ö–æ–º–∏—Å—Å–∏—è –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ü/–£

**TradingView:** –ö–æ–º–∏—Å—Å–∏—è —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏

**–ù–∞—à –¥–≤–∏–∂–æ–∫:**
```python
# –ü—Ä–∏ –≤—Ö–æ–¥–µ: –±–µ—Ä–µ–º –∫–æ–º–∏—Å—Å–∏—é
fees = position_value * config.taker_fee
cash -= position_value + fees

# Unrealized P&L –ù–ï –≤–∫–ª—é—á–∞–µ—Ç fees
unrealized_pnl = (price - entry_price) * position * leverage

# –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ: –≤—ã—á–∏—Ç–∞–µ–º –æ–±–µ –∫–æ–º–∏—Å—Å–∏–∏
pnl = (price - entry_price) * entry_size * leverage - fees * 2
```

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** - –∫–æ–º–∏—Å—Å–∏—è –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —á–∏—Å—Ç—É—é –ø—Ä–∏–±—ã–ª—å

### 5. Equity Curve (–∫—Ä–∏–≤–∞—è —ç–∫–≤–∏—Ç–∏)

**TradingView:** –°—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∏ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –±–∞—Ä–µ

**–ù–∞—à –¥–≤–∏–∂–æ–∫:**
```python
for i in range(len(close)):
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ ...
    # Update equity –Ω–∞ –ö–ê–ñ–î–û–ú –±–∞—Ä–µ
    current_equity = cash + entry_price * position + unrealized_pnl
    equity.append(current_equity)
```

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** - —ç–∫–≤–∏—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –±–∞—Ä

---

## ‚ö†Ô∏è –û—Ç–ª–∏—á–∏—è –æ—Ç TradingView

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–µ–¥–∞ Bid/Ask

**TradingView:** –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–ø—Ä–µ–¥ (–ø–æ–∫—É–ø–∫–∞ –∏ –ø—Ä–æ–¥–∞–∂–∞ –ø–æ `close`)

**–ù–∞—à –¥–≤–∏–∂–æ–∫:** –¢–∞–∫–∂–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–ø—Ä–µ–¥

‚ö†Ô∏è **–û–¥–∏–Ω–∞–∫–æ–≤–æ –∏–¥–µ–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ** - —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±–æ–∏—Ö –¥–≤–∏–∂–∫–æ–≤

### 2. –ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (Slippage)

**TradingView:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `strategy()` –ø–∞—Ä–∞–º–µ—Ç—Ä

**–ù–∞—à –¥–≤–∏–∂–æ–∫ (vectorbt path):**
```python
pf = vbt.Portfolio.from_signals(
    ...
    slippage=0.0001,  # 0.01% slippage
)
```

**–ù–∞—à –¥–≤–∏–∂–æ–∫ (fallback path):**
```python
# –ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ
price = close[i]  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
```

‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** - slippage —Ç–æ–ª—å–∫–æ –≤ vectorbt, –Ω–µ –≤ fallback

### 3. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞ (process_orders_on_close)

**TradingView v5:** –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª–Ω—è—Ç—å –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞ —Å `process_orders_on_close = false`

**–ù–∞—à –¥–≤–∏–∂–æ–∫:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª–Ω—è–µ—Ç –ø–æ `close` –±–∞—Ä–∞

‚ö†Ô∏è **–£–ø—Ä–æ—â–µ–Ω–∏–µ** - –º—ã —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å close, –Ω–µ —Å —Ç–∏–∫–æ–≤–æ–π –º–æ–¥–µ–ª—å—é

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ TP/SL –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞

**TradingView:** –ú–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å TP/SL –Ω–∞ high/low –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞

**–ù–∞—à –¥–≤–∏–∂–æ–∫:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º TP/SL –ø–æ close —Ü–µ–Ω–µ, –∞ –Ω–µ –ø–æ high/low
if is_long:
    pnl_pct = (price - entry_price) / entry_price * leverage  # price = close
else:
    pnl_pct = (entry_price - price) / entry_price * leverage

# Check Stop Loss
if stop_loss and pnl_pct <= -stop_loss:
    should_exit = True
```

‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ** - TP/SL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ close, –∞ –Ω–µ –ø–æ high/low!

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–ª–∏—á–∏—è, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è

### 1. TP/SL –ø–æ Close –≤–º–µ—Å—Ç–æ High/Low

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–∞ –±–∞—Ä–µ –¥–æ—Å—Ç–∏–≥–ª–∞ —É—Ä–æ–≤–Ω—è SL (–ø–æ low), –Ω–æ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤—ã—à–µ, –Ω–∞—à –¥–≤–∏–∂–æ–∫ –ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç SL.

**–ü—Ä–∏–º–µ—Ä:**
- Entry LONG @ $100
- SL = 5%
- –ë–∞—Ä: High=$102, Low=$94, Close=$99
- **TradingView:** SL —Å—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∏ Low=$94 (-6%)
- **–ù–∞—à –¥–≤–∏–∂–æ–∫:** SL –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª, —Ç.–∫. Close=$99 (-1%)

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å TP/SL –ø–æ high/low:

```python
# –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
if is_long:
    # –î–ª—è –ª–æ–Ω–≥–∞: SL –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ low, TP –ø–æ high
    worst_price = current_low
    best_price = current_high
else:
    # –î–ª—è —à–æ—Ä—Ç–∞: SL –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ high, TP –ø–æ low
    worst_price = current_high
    best_price = current_low

worst_pnl_pct = (worst_price - entry_price) / entry_price * leverage if is_long else (entry_price - worst_price) / entry_price * leverage
best_pnl_pct = (best_price - entry_price) / entry_price * leverage if is_long else (entry_price - best_price) / entry_price * leverage

# Check Stop Loss by worst price
if stop_loss and worst_pnl_pct <= -stop_loss:
    should_exit = True
    exit_price = entry_price * (1 - stop_loss/leverage)  # SL price
    exit_reason = "stop_loss"

# Check Take Profit by best price
if not should_exit and take_profit and best_pnl_pct >= take_profit:
    should_exit = True
    exit_price = entry_price * (1 + take_profit/leverage)  # TP price
    exit_reason = "take_profit"
```

### 2. –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ TP/SL –Ω–∞ –æ–¥–Ω–æ–º –±–∞—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –Ω–∞ –æ–¥–Ω–æ–º –±–∞—Ä–µ –∏ TP, –∏ SL –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã, –∫–∞–∫–æ–π —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–≤—ã–º?

**TradingView:** –ò–º–µ–µ—Ç –ª–æ–≥–∏–∫—É "—á—Ç–æ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ" (–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏–±–∞—Ä–æ–≤–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)

**–ù–∞—à –¥–≤–∏–∂–æ–∫:** –°–Ω–∞—á–∞–ª–∞ SL, –ø–æ—Ç–æ–º TP (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: TP/SL –ø–æ High/Low
–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É TP/SL, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å high/low –≤–º–µ—Å—Ç–æ close.

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Slippage –≤ Fallback
–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä slippage –≤ fallback implementation.

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –í–Ω—É—Ç—Ä–∏–±–∞—Ä–æ–≤–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è TV –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º —Å –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞ TP/SL.

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

| –§—É–Ω–∫—Ü–∏—è | TradingView | –ù–∞—à –¥–≤–∏–∂–æ–∫ | –°—Ç–∞—Ç—É—Å |
|---------|-------------|------------|--------|
| Unrealized P&L —Ñ–æ—Ä–º—É–ª–∞ | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| –û—Ü–µ–Ω–∫–∞ –ø–æ close | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| Equity curve –Ω–∞ –∫–∞–∂–¥–æ–º –±–∞—Ä–µ | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| MFE/MAE –ø–æ high/low | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| –ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–µ–¥–∞ | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–æ |
| Slippage | ‚úÖ | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ vbt | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ–µ |
| TP/SL –ø–æ high/low | ‚úÖ | ‚úÖ | ‚úÖ –ü–æ–ª–Ω–æ–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) |
| process_orders_on_close | ‚úÖ –û–ø—Ü–∏—è | ‚ùå –¢–æ–ª—å–∫–æ close | ‚ö†Ô∏è –£–ø—Ä–æ—â–µ–Ω–∏–µ |
| –ú–∞–∫—Å. —Ä–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ | ‚úÖ | ‚úÖ max_runup | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| –°—Ä–µ–¥. —Ä–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ | ‚úÖ | ‚úÖ avg_runup | ‚úÖ –ü–æ–ª–Ω–æ–µ |
| –ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞ (–≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞) | ‚úÖ | ‚úÖ max_drawdown_intrabar | ‚úÖ –ü–æ–ª–Ω–æ–µ |

---

## üîß –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1. **–°–î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É TP/SL –Ω–∞ high/low
2. **–°–î–ï–õ–ê–¢–¨ –ü–û–ó–ñ–ï:** –î–æ–±–∞–≤–∏—Ç—å slippage –≤ fallback
3. **–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û:** –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º –≤–Ω—É—Ç—Ä–∏–±–∞—Ä–æ–≤–æ–≥–æ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è
