"""
–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ó–ê–ü–†–û–°: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek –±–µ–∑ –æ–±—Ä—ã–≤–æ–≤

–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π max_tokens: 16000 (–º–∞–∫—Å–∏–º—É–º –¥–ª—è deepseek-chat)
Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –æ–±—Ä—ã–≤–∞—Ö
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
"""

import asyncio
import json
import os
from datetime import datetime
from pathlib import Path
from dotenv import load_dotenv
import httpx

load_dotenv()

DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
OUTPUT_DIR = Path(__file__).parent / "ai_audit_results"
OUTPUT_DIR.mkdir(exist_ok=True)


async def ask_deepseek_with_retry(prompt: str, max_retries: int = 3) -> dict:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ DeepSeek API —Å retry –ª–æ–≥–∏–∫–æ–π"""
    
    for attempt in range(max_retries):
        try:
            async with httpx.AsyncClient(timeout=600.0) as client:  # –£–≤–µ–ª–∏—á–∏–ª–∏ —Ç–∞–π–º–∞—É—Ç –¥–æ 10 –º–∏–Ω—É—Ç
                print(f"\nüîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}...")
                print(f"‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)")
                
                response = await client.post(
                    "https://api.deepseek.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "model": "deepseek-chat",
                        "messages": [
                            {
                                "role": "system",
                                "content": "–¢—ã - senior –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ Python –ø—Ä–æ–µ–∫—Ç–æ–≤, CI/CD –∏ —Ñ–æ–Ω–æ–≤—ã–º –∞–≥–µ–Ω—Ç–∞–º. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–õ–ù–´–ô –æ—Ç–≤–µ—Ç, –≤–∫–ª—é—á–∞—è –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ –∫–æ–Ω—Ü–∞."
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        "temperature": 0.7,
                        "max_tokens": 16000,  # –ú–ê–ö–°–ò–ú–£–ú –¥–ª—è deepseek-chat
                        "stream": False
                    }
                )
                
                response.raise_for_status()
                result = response.json()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                finish_reason = result.get("choices", [{}])[0].get("finish_reason")
                content = result.get("choices", [{}])[0].get("message", {}).get("content", "")
                
                print(f"\n‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω!")
                print(f"üìä –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
                print(f"üèÅ –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {finish_reason}")
                
                if finish_reason == "length":
                    print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤!")
                    print("üí° –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ...")
                    
                    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
                    continuation = await get_continuation(content)
                    if continuation:
                        result["choices"][0]["message"]["content"] = content + "\n\n" + continuation
                        result["choices"][0]["finish_reason"] = "stop"
                        print(f"‚úÖ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: {len(result['choices'][0]['message']['content'])} —Å–∏–º–≤–æ–ª–æ–≤")
                
                return result
                
        except httpx.TimeoutException:
            print(f"‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}")
            if attempt < max_retries - 1:
                wait_time = (attempt + 1) * 30
                print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...")
                await asyncio.sleep(wait_time)
            else:
                raise
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}: {e}")
            if attempt < max_retries - 1:
                wait_time = (attempt + 1) * 20
                print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...")
                await asyncio.sleep(wait_time)
            else:
                raise
    
    raise Exception("–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã")


async def get_continuation(previous_content: str) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω"""
    
    continuation_prompt = f"""
–ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –ü–†–ï–î–´–î–£–©–ï–ì–û –û–¢–í–ï–¢–ê:

–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –Ω–∞:
---
{previous_content[-500:]}
---

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–æ–¥–æ–ª–∂–∏ —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ–±–æ—Ä–≤–∞–ª—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç.
–ù–∞—á–Ω–∏ —Å —Ä–∞–∑–¥–µ–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ "–û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢ –ò –†–ò–°–ö–û–í").

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
1. –ü–æ–ª–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ (—á–∞—Å—ã)
2. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤
3. –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
4. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ù–ï –ø–æ–≤—Ç–æ—Ä—è–π —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–¥–æ–ª–∂–∏ —Å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞.
"""
    
    try:
        async with httpx.AsyncClient(timeout=600.0) as client:
            print(f"\nüîÑ –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")
            
            response = await client.post(
                "https://api.deepseek.com/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": "–¢—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç. –ù–∞—á–Ω–∏ —Å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞."
                        },
                        {
                            "role": "user",
                            "content": continuation_prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 8000
                }
            )
            
            response.raise_for_status()
            result = response.json()
            continuation = result.get("choices", [{}])[0].get("message", {}).get("content", "")
            
            return continuation
            
    except Exception as e:
        print(f"‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ: {e}")
        return ""


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    
    print("=" * 80)
    print("ü§ñ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ó–ê–ü–†–û–° –ö DEEPSEEK")
    print("=" * 80)
    print("\nüìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:")
    print("   - max_tokens: 16000 (–º–∞–∫—Å–∏–º—É–º)")
    print("   - timeout: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)")
    print("   - retry: 3 –ø–æ–ø—ã—Ç–∫–∏")
    print("   - continuation: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ")
    print()
    
    prompt = """
# –ó–ê–î–ê–ß–ê: –†–ê–ó–†–ê–ë–û–¢–ö–ê –°–ò–°–¢–ï–ú–´ –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò –î–õ–Ø BYBIT STRATEGY TESTER V2

–ú–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–º–æ—â—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Ç—Ä–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: 
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–õ–ù–´–ô –æ—Ç–≤–µ—Ç —Å–æ –í–°–ï–ú–ò —Ä–∞–∑–¥–µ–ª–∞–º–∏ –¥–æ –∫–æ–Ω—Ü–∞
- –í–∫–ª—é—á–∏ —Ä–∞–∑–¥–µ–ª "–û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢ –ò –†–ò–°–ö–û–í" –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ù–µ –æ–±—Ä—ã–≤–∞–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ
- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –±–µ–∑ TODO –∏ –∑–∞–≥–ª—É—à–µ–∫!

---

## üéØ –ó–ê–î–ê–ß–ê 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞/—Ñ—É–Ω–∫—Ü–∏–π/—Ç–µ—Å—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å pytest —Å coverage
- –°–æ–±–∏—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ (coverage, passed/failed, errors)
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ DeepSeek API –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- DeepSeek –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
  - –ö–∞—á–µ—Å—Ç–≤–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
  - –ü–æ–ª–Ω–æ—Ç—É –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏
  - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
  - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Ç—á–µ—Ç DeepSeek –≤ ai_audit_results/

**–í–æ–ø—Ä–æ—Å—ã:**
1. –ö–∞–∫ –ª—É—á—à–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤? (watchdog, git hooks, CI/CD webhook?)
2. –ù—É–∂–µ–Ω –ª–∏ —Ñ–æ–Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ pre-commit hook?
3. –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞ –ª—É—á—à–µ –¥–ª—è DeepSeek (JSON, Markdown, XML)?
4. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Å–ø–∞–º–∞ –æ—Ç –º–µ–ª–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π?
5. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π –∫–æ–¥ Python —Å–∫—Ä–∏–ø—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –†–∞–±–æ—á–∏–π Python —Å–∫—Ä–∏–ø—Ç/–∞–≥–µ–Ω—Ç
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üîê –ó–ê–î–ê–ß–ê 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API –∫–ª—é—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ MCP —Å–µ—Ä–≤–µ—Ä–∞

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ MCP —Å–µ—Ä–≤–µ—Ä–∞ (mcp-server/server.py)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–æ–¥—É–ª—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–ª—é—á–µ–π
- –ó–∞–≥—Ä—É–∂–∞—Ç—å PERPLEXITY_API_KEY –∏ DEEPSEEK_API_KEY –∏–∑ encrypted_secrets.json
- –î–µ–ª–∞—Ç—å –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ—Ö MCP tools —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º
- –ù–ï –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```
mcp-server/
  server.py          # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª MCP —Å–µ—Ä–≤–µ—Ä–∞
  utils/
    key_manager.py   # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–ª—é—á–µ–π
encrypted_secrets.json  # –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏
.env                    # ENCRYPTION_KEY –∑–¥–µ—Å—å
```

**–í–æ–ø—Ä–æ—Å—ã:**
1. –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ mcp-server/server.py –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ?
2. Singleton pattern –¥–ª—è KeyManager –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥?
3. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ—Ö @mcp.tool() —Ñ—É–Ω–∫—Ü–∏–π?
4. –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏?
5. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π –∫–æ–¥ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ú–æ–¥—É–ª—å key_manager.py
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π server.py —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## ‚è∞ –ó–ê–î–ê–ß–ê 3: –§–æ–Ω–æ–≤—ã–π –∞—É–¥–∏—Ç-–∞–≥–µ–Ω—Ç (—Ç–∞–π–º–µ—Ä) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –§–æ–Ω–æ–≤—ã–π Python —Å–∫—Ä–∏–ø—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π 24/7
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –º–∞—Ä–∫–µ—Ä—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
  - –§–∞–π–ª—ã –≤–∏–¥–∞ *_COMPLETE.md
  - –§–∞–π–ª—ã –≤–∏–¥–∞ PHASE_*.md
  - –§–∞–π–ª—ã –≤–∏–¥–∞ MILESTONE_*.md
- –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∞–ø–∞:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç full_ai_audit_deepseek_perplexity_deepseek.py
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í–æ–ø—Ä–æ—Å—ã:**
1. Polling (–∫–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç) –∏–ª–∏ event-driven (watchdog)?
2. –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞"? (—Ñ–∞–π–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã, git tags, –¥—Ä—É–≥–æ–µ?)
3. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏—Ç–æ–≤?
4. –ö—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å (Windows PowerShell + Linux bash)?
5. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π –∫–æ–¥ –∞–≥–µ–Ω—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–∫—Ä–∏–ø—Ç —Ñ–æ–Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
- –°–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞ –¥–ª—è Windows –∏ Linux
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üìã –û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö–û –í–°–ï–ú –†–ï–®–ï–ù–ò–Ø–ú:

1. **–ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–¥** - –Ω–µ –ø—Å–µ–≤–¥–æ–∫–æ–¥, –Ω–µ –∑–∞–≥–ª—É—à–∫–∏ —Å TODO!
2. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - graceful degradation
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —á—Ç–æ, –∫–æ–≥–¥–∞, –ø–æ—á–µ–º—É –ø—Ä–æ–∏–∑–æ—à–ª–æ
5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - —á–µ—Ä–µ–∑ .env —Ñ–∞–π–ª—ã
6. **–¢–µ—Å—Ç—ã** - —Ö–æ—Ç—è –±—ã –±–∞–∑–æ–≤—ã–µ unit-—Ç–µ—Å—Ç—ã
7. **–ö—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å** - Windows 11 + Linux

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å:

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** (–¥–∏–∞–≥—Ä–∞–º–º—ã, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
2. **–ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π –∫–æ–¥** –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** (.env –ø—Ä–∏–º–µ—Ä—ã, YAML –∫–æ–Ω—Ñ–∏–≥–∏)
4. **–°–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞** (Windows .ps1, Linux .sh)
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**
6. **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**
7. **–û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢** (—á–∞—Å—ã –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é)
8. **–ê–ù–ê–õ–ò–ó –†–ò–°–ö–û–í** (—á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ –∏ –∫–∞–∫ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:

- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –±–µ–∑ TODO –∏ –∑–∞–≥–ª—É—à–µ–∫!
- –í—Å–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π - –≤ –ø–∞–ø–∫—É ai_audit_results/
- API –∫–ª—é—á–∏ - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã
- –ù–∏–∫–∞–∫–æ–≥–æ —Ö–∞—Ä–¥–∫–æ–¥–∞!

---

**–í–ê–ñ–ù–û**: –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –í–°–ï —Ä–∞–∑–¥–µ–ª—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ—Å–æ–±–µ–Ω–Ω–æ:
- –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö –∑–∞–¥–∞—á
- –†–∞–∑–¥–µ–ª "–û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢ –ò –†–ò–°–ö–û–í" —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏
- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ù–µ –æ–±—Ä—ã–≤–∞–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ä–∞–∑–¥–µ–ª–∞. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º —è–≤–Ω–æ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞.
"""
    
    try:
        print("üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ DeepSeek...")
        print("‚è±Ô∏è  –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 3-10 –º–∏–Ω—É—Ç\n")
        
        result = await ask_deepseek_with_retry(prompt)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        json_file = OUTPUT_DIR / f"deepseek_automation_FULL_{timestamp}.json"
        with open(json_file, 'w', encoding='utf-8') as f:
            json.dump(result, f, indent=2, ensure_ascii=False)
        
        # Markdown —Å –æ—Ç–≤–µ—Ç–æ–º
        content = result.get("choices", [{}])[0].get("message", {}).get("content", "")
        md_file = OUTPUT_DIR / f"deepseek_automation_FULL_{timestamp}.md"
        
        with open(md_file, 'w', encoding='utf-8') as f:
            f.write(f"# ü§ñ –ü–û–õ–ù–û–ï –†–ï–®–ï–ù–ò–ï DEEPSEEK: –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò\n\n")
            f.write(f"**–î–∞—Ç–∞**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  \n")
            f.write(f"**–ó–∞–ø—Ä–æ—Å**: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∫–ª—é—á–µ–π, —Ñ–æ–Ω–æ–≤—ã–π –∞—É–¥–∏—Ç-–∞–≥–µ–Ω—Ç\n")
            f.write(f"**–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤\n")
            f.write(f"**–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: {result.get('choices', [{}])[0].get('finish_reason')}\n\n")
            f.write("---\n\n")
            f.write(content)
        
        print("\n" + "=" * 80)
        print("‚úÖ –û–¢–í–ï–¢ –ü–û–õ–£–ß–ï–ù –ò –°–û–•–†–ê–ù–ï–ù!")
        print("=" * 80)
        print(f"\nüìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {md_file.name}")
        print(f"üìä –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(content):,} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üèÅ –°—Ç–∞—Ç—É—Å: {result.get('choices', [{}])[0].get('finish_reason')}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–±—Ä—ã–≤
        finish_reason = result.get("choices", [{}])[0].get("finish_reason")
        if finish_reason == "length":
            print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–≤–µ—Ç –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω!")
            print("üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü–æ–ø—Ä–æ—Å–∏—Ç–µ DeepSeek —Ä–∞–∑–¥–µ–ª–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏")
        else:
            print("\n‚úÖ –û—Ç–≤–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (finish_reason: stop)")
        
        print("\n" + "=" * 80)
        print("–ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê –û–¢–í–ï–¢–ê:")
        print("=" * 80)
        print(content[:1000])
        print("\n... (–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Ñ–∞–π–ª–µ) ...\n")
        
        # –í—ã–≤–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        print("=" * 80)
        print("–ö–û–ù–ï–¶ –û–¢–í–ï–¢–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):")
        print("=" * 80)
        print(content[-500:])
        print("\n")
        
        return result
        
    except Exception as e:
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        raise


if __name__ == "__main__":
    asyncio.run(main())
