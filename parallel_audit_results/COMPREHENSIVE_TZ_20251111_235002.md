```markdown
# Техническое задание (ТЗ) для проекта **bybit_strategy_tester_v2**

**Дата:** 11 ноября 2025  
**Версия:** 1.0

---

## 1. Executive Summary

- **Текущее состояние проекта:** 6/10  
  *Основано на стабильной работе отдельных агентов и наличии критических проблем в инфраструктуре.*

- **Ключевые достижения:**
  - Успешная интеграция и стабильная работа **DeepSeek Agent** (93% uptime)
  - Надежная работа **Perplexity Agent** (90% uptime)
  - Исправлены проблемы с использованием `datetime.utcnow()`
  - Внедрено 16 API ключей для гибкой работы агентов
  - Стабильная база тестов (163 файла)

- **TOP-5 критических проблем:**
  1. **MCP Server: 0% доступности**
  2. **Недостаточное покрытие тестами основной логики**
  3. **Устаревшие или неиспользуемые зависимости в backend**
  4. **Отсутствие единой системы мониторинга инфраструктуры**
  5. **Неэффективное управление API ключами и секретами**

- **Рекомендуемые приоритеты:**
  - Немедленное восстановление MCP Server
  - Повышение надежности критических компонентов (P0)
  - Расширение покрытия тестами бизнес-логики
  - Актуализация и оптимизация backend-архитектуры
  - Пересмотр политики безопасности и управления API ключами

---

## 2. Critical Issues (Требуют немедленного внимания)

| Название                          | Описание                                                                 | Impact   | Effort        | Priority |
|------------------------------------|--------------------------------------------------------------------------|----------|---------------|----------|
| MCP Server Downtime                | MCP Server недоступен, что блокирует запуск стратегий и синхронизацию    | HIGH     | 1-2 дня       | P0       |
| Тесты: Отсутствие критических кейсов| Недостаточное покрытие тестами ядра backend и агентов                    | HIGH     | 1-2 недели    | P0       |
| Устаревшие зависимости backend     | Используются устаревшие библиотеки, риск уязвимостей                     | MEDIUM   | 1-2 дня       | P1       |
| Мониторинг инфраструктуры          | Нет системы централизованного мониторинга и алертинга                    | MEDIUM   | 1-2 недели    | P1       |
| Управление API ключами             | Ключи хранятся небезопасно, нет ротации                                  | HIGH     | 1-2 дня       | P0       |

---

## 3. Architecture Improvements

### Backend

- **Refactoring tasks**
  - Переписать устаревшие модули MCP Server.
  - Провести аудит зависимостей и удалить неиспользуемые библиотеки.
  - Разделить бизнес-логику и инфраструктурный код по слоям.

- **Code quality improvements**
  - Внедрить статический анализ кода (mypy, pylint).
  - Ввести code review по ключевым модулям.

- **Database optimization**
  - Провести аудит индексов и оптимизировать запросы к БД.
  - Добавить миграции для актуализации схемы.

### Frontend

- **UI/UX improvements**
  - Провести юзабилити-тестирование и обновить спорные элементы интерфейса.
  - Добавить визуальные алерты для ошибок агентов.

- **Performance optimization**
  - Аудит bundle size, внедрение code-splitting.
  - Использование lazy loading для тяжелых компонентов.

- **TypeScript migration status**
  - Оценить текущий прогресс миграции; завершить перевод всех компонентов на TypeScript.

### AI Agents

- **MCP Server восстановление**
  - Немедленная диагностика причин 0% uptime, план восстановления, тестирование.

- **DeepSeek integration enhancements**
  - Обновить SDK, реализовать обработку edge-cases и fallback-механизмы.

- **Perplexity usage optimization**
  - Перевести неиспользуемые вызовы на асинхронные.
  - Внедрить лимитирование и мониторинг использования API.

---

## 4. Testing & Quality Assurance

- **Current test coverage analysis**
  - Покрытие тестами — низкое в ядре backend, удовлетворительное в обертках агентов и API.

- **Missing test scenarios**
  - Критические сценарии MCP Server.
  - Интеграционные тесты взаимодействия агентов.
  - Проверка отказоустойчивости при сбоях инфраструктуры.

- **CI/CD recommendations**
  - Внедрить обязательный запуск тестов и статических анализаторов на каждом pull request.
  - Автоматизировать деплой с rollback при неуспехе.

- **Code quality metrics**
  - Target: минимум 80% покрытие тестами.
  - Ошибки статического анализа на уровне не выше warning.

---

## 5. Performance Optimization

- **Bottlenecks identified**
  - MCP Server — главная точка отказа, задержки синхронизации.
  - Долгие SQL-запросы при больших объемах данных.

- **Caching strategies**
  - Использование Redis/Memcached для кэширования результатов запросов агентов.
  - Кэширование статических данных и метаданных.

- **Query optimization**
  - Переписать тяжелые join-запросы.
  - Введение пагинации/лимитов на больших выборках.

- **Async/await best practices**
  - Перевести блокирующие операции на асинхронные (особенно API вызовы).
  - Применить asyncio для работы с внешними сервисами.

---

## 6. Security Hardening

- **Vulnerabilities assessment**
  - Провести аудит зависимостей на CVE.
  - Провести пен-тест API.

- **API keys management review**
  - Перевести хранение секретов в Vault/Secret Manager.
  - Ввести регулярную ротацию ключей.

- **Input validation gaps**
  - Усилить проверку данных на входе во всех endpoint-ах.
  - Внедрить валидацию схем через Pydantic/Marshmallow.

- **Secure coding practices**
  - Внедрить обучение команды по безопасному программированию.
  - Использовать linters с security rules.

---

## 7. Implementation Roadmap

### Phase 1 (1-2 недели): Critical Fixes

- Восстановление MCP Server (диагностика, патч, тестирование)
- Решение P0 проблем (тесты для критических путей, ротация ключей)

### Phase 2 (2-4 недели): Major Improvements

- Рефакторинг архитектуры backend
- Увеличение покрытия тестами до 80%
- Оптимизация производительности (кэширование, асинхронность)

### Phase 3 (1-2 месяца): Long-term Enhancements

- Разработка новых функций (по roadmap)
- Глубокая оптимизация инфраструктуры
- Завершение документации (технической, пользовательской)

---

## 8. Success Metrics & KPIs

| Метрика                    | Целевое значение                 |
|----------------------------|----------------------------------|
| Uptime MCP Server          | ≥ 99%                            |
| Uptime AI Agents           | ≥ 95%                            |
| Покрытие тестами           | ≥ 80%                            |
| Среднее время ответа API   | ≤ 300 мс                         |
| Кол-во критических инцидентов в месяц | 0                 |
| Время восстановления после сбоя (MTTR) | ≤ 30 мин         |

---

## 9. Dependencies & Risks

- **External dependencies**
  - DeepSeek, Perplexity API
  - Сторонние библиотеки Python

- **Technical debt assessment**
  - Устаревшие модули MCP Server
  - Неоптимизированные SQL-запросы
  - Частично не типизированный frontend

- **Risk mitigation strategies**
  - Снижение bus factor через документацию и code review
  - Внедрение мониторинга и резервного копирования

---

## 10. Estimated Resources

- **Developer hours required**
  - Phase 1: ~80 часов (2-3 разработчика)
  - Phase 2: ~200 часов (3-4 разработчика)
  - Phase 3: ~300 часов (2-3 разработчика + 1 технический писатель)

- **Infrastructure costs**
  - Серверы (cloud, managed DB): $500–$1000/мес
  - Мониторинг и CI/CD: $100–$200/мес

- **Third-party services**
  - DeepSeek API: согласно тарифу
  - Perplexity API: согласно тарифу
  - Vault/Secret Manager: $50–$100/мес

---

*Документ составлен в соответствии с лучшими практиками технического задания для IT-проектов[1][2][3].*
```
