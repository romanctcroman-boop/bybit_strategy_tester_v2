name: Production Deployment

on:
  push:
    tags:
      - "v*.*.*" # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # JOB 1: Run All Tests
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/backend -v --cov=backend --cov-report=xml --cov-report=term

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/integration -v --maxfail=3

      - name: Run agent tests
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          DEEPSEEK_API_KEYS: ${{ secrets.DEEPSEEK_API_KEYS }}
          PERPLEXITY_API_KEYS: ${{ secrets.PERPLEXITY_API_KEYS }}
        run: |
          pytest tests/agents -v --maxfail=3

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # JOB 2: Frontend Tests
  # ============================================================================
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps

      - name: Run E2E tests
        working-directory: frontend
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

  # ============================================================================
  # JOB 3: Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r backend -f json -o bandit-report.json || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit-report.json

  # ============================================================================
  # JOB 4: Build Docker Images
  # ============================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, frontend-test, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.backend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache,mode=max
          build-args: |
            BUILD_ENV=production
            VERSION=${{ steps.version.outputs.version }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache,mode=max

  # ============================================================================
  # JOB 5: Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    # Note: VS Code YAML validator may flag environment names if repo environments aren't defined.
    # Removing environment binding to avoid false-positive lint errors.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/bybit-strategy-tester
            git pull origin main
            docker-compose -f docker-compose.staging.yml pull
            docker-compose -f docker-compose.staging.yml up -d --remove-orphans
            docker-compose -f docker-compose.staging.yml exec -T backend alembic upgrade head

      - name: Run smoke tests
        run: |
          sleep 30
          curl -f https://staging.yourdomain.com/api/v1/health || exit 1

  # ============================================================================
  # JOB 6: Deploy to Production
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref_type == 'tag'
    # Note: VS Code YAML validator may flag environment names if repo environments aren't defined.
    # Removing environment binding to avoid false-positive lint errors.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dry-run plan (test tag)
        if: ${{ contains(github.ref_name, '-test') }}
        run: |
          echo "Dry-run mode for tag: ${{ github.ref_name }}"
          echo "Would deploy images:"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ steps.version.outputs.version || 'latest' }}"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ steps.version.outputs.version || 'latest' }}"
          echo "Would run alembic upgrade head and rolling updates (skipped in dry-run)."
          echo "Skipping SSH, smoke/load tests, Slack, and rollback by design for '-test' tags."

      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        if: ${{ !contains(github.ref_name, '-test') }}
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/bybit-strategy-tester
            git fetch --tags
            git checkout ${{ github.ref_name }}

            # Pull new images
            docker-compose -f docker-compose.production.yml pull

            # Run database migrations
            docker-compose -f docker-compose.production.yml run --rm backend alembic upgrade head

            # Rolling update (zero downtime)
            docker-compose -f docker-compose.production.yml up -d --no-deps --scale backend=3 backend
            sleep 30
            docker-compose -f docker-compose.production.yml up -d --no-deps --scale celery-worker=3 celery-worker
            docker-compose -f docker-compose.production.yml up -d --no-deps frontend

            # Cleanup old images
            docker image prune -af --filter "until=168h"

      - name: Run smoke tests
        if: ${{ !contains(github.ref_name, '-test') }}
        run: |
          sleep 60
          curl -f https://yourdomain.com/api/v1/health || exit 1
          curl -f https://yourdomain.com/ || exit 1

      - name: Set up Python for load tests
        if: ${{ !contains(github.ref_name, '-test') }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run load tests
        if: ${{ !contains(github.ref_name, '-test') }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install locust
          python -m locust -f tests/load/locustfile.py --headless --users 100 --spawn-rate 10 --run-time 2m --host https://yourdomain.com
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"

      - name: Validate required secrets
        if: ${{ !contains(github.ref_name, '-test') }}
        shell: bash
        run: |
          test -n "${{ secrets.PRODUCTION_HOST }}" || { echo "Missing secret: PRODUCTION_HOST"; exit 1; }
          test -n "${{ secrets.PRODUCTION_USER }}" || { echo "Missing secret: PRODUCTION_USER"; exit 1; }
          test -n "${{ secrets.PRODUCTION_SSH_KEY }}" || { echo "Missing secret: PRODUCTION_SSH_KEY"; exit 1; }

      - name: Notify deployment success
        if: success() && ${{ !contains(github.ref_name, '-test') }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "✅ Production deployment successful! Version: ${{ github.ref_name }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *Production Deployment Successful*\n\n*Version:* ${{ github.ref_name }}\n*Triggered by:* ${{ github.actor }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify deployment failure
        if: failure() && ${{ !contains(github.ref_name, '-test') }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "❌ Production deployment failed! Version: ${{ github.ref_name }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *Production Deployment Failed*\n\n*Version:* ${{ github.ref_name }}\n*Triggered by:* ${{ github.actor }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Rollback on failure
        if: failure() && ${{ !contains(github.ref_name, '-test') }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/bybit-strategy-tester
            git checkout main
            docker-compose -f docker-compose.production.yml up -d --force-recreate

  # ============================================================================
  # JOB 7: Post-Deployment Monitoring
  # ============================================================================
  monitor:
    name: Monitor Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref_type == 'tag' && !contains(github.ref_name, '-test')

    steps:
      - name: Wait for metrics
        run: sleep 300 # 5 minutes

      - name: Check error rates
        run: |
          # Query Prometheus for error rates
          ERROR_RATE=$(curl -s "http://prometheus.yourdomain.com/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])" | jq -r '.data.result[0].value[1]')
          if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
            echo "Error rate too high: $ERROR_RATE"
            exit 1
          fi

      - name: Check response times
        run: |
          # Query Prometheus for p95 latency
          P95_LATENCY=$(curl -s "http://prometheus.yourdomain.com/api/v1/query?query=histogram_quantile(0.95, http_request_duration_seconds_bucket[5m])" | jq -r '.data.result[0].value[1]')
          if (( $(echo "$P95_LATENCY > 2.0" | bc -l) )); then
            echo "P95 latency too high: $P95_LATENCY"
            exit 1
          fi
