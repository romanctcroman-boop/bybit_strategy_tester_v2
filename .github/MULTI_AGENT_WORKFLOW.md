# Multi-Agent Workflow: Copilot + Research Assistant

## ÔøΩ DECISION MATRIX: –ö—Ç–æ –¥–µ–ª–∞–µ—Ç —á—Ç–æ?

### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Copilot** ‚úÖ
| –ó–∞–¥–∞—á–∞ | –î–µ–π—Å—Ç–≤–∏–µ | –ü—Ä–∏–º–µ—Ä—ã |
|--------|----------|---------|
| **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤** | Copilot: –∞–Ω–∞–ª–∏–∑ ‚Üí —Ñ–∏–∫—Å ‚Üí —Ç–µ—Å—Ç—ã | `TypeError`, `None`, –∏–Ω–¥–µ–∫—Å—ã |
| **–ü—Ä–æ—Å—Ç–æ–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** | Copilot: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è | –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–æ–¥–∞ |
| **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** | Copilot: React/TypeScript –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º | –ö–Ω–æ–ø–∫–∏, —Ñ–æ—Ä–º—ã, —Ç–∞–±–ª–∏—Ü—ã |
| **–ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç—ã** | Copilot: unit-—Ç–µ—Å—Ç—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ | `test_function_returns_value()` |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–æ–¥–∞** | Copilot: docstrings, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ | `"""Calculate position size."""` |
| **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–ª–∏–Ω—Ç–∏–Ω–≥** | Copilot: `black`, `eslint`, `prettier` | –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |

**–ö—Ä–∏—Ç–µ—Ä–∏–π**: –ó–∞–¥–∞—á–∞ **–æ—á–µ–≤–∏–¥–Ω–∞** –∏ –∏–º–µ–µ—Ç **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**.

---

### **–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å Perplexity** üîç
| –ó–∞–¥–∞—á–∞ | –ü–æ—á–µ–º—É Perplexity | –ß—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å |
|--------|-------------------|----------------|
| **–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º** | –ù—É–∂–Ω–∞ —Ç–µ–æ—Ä–∏—è + best practices | "Kelly Criterion –¥–ª—è –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–µ–π–¥–∏–Ω–≥–∞" |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** | Benchmarking, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | "FastAPI vs Flask –¥–ª—è WebSocket" |
| **–í—ã–±–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏** | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ | "pandas vs polars –¥–ª—è 1M+ —Å—Ç—Ä–æ–∫" |
| **–û—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã** | –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ 2024-2025 | "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã React Hooks" |
| **API –¥–∏–∑–∞–π–Ω** | REST/GraphQL best practices | "Pagination –¥–ª—è large datasets" |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã)** | CVE, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ OWASP | "SQL injection –∑–∞—â–∏—Ç–∞ FastAPI" |

**–ö—Ä–∏—Ç–µ—Ä–∏–π**: –ù—É–∂–Ω–∞ **–∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** –∏–ª–∏ **—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤**.

---

### **–ö–æ–≥–¥–∞ –ø–∏—Å–∞—Ç—å –∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é** üõ†Ô∏è
| –°—Ü–µ–Ω–∞—Ä–∏–π | –ö–æ–≥–¥–∞ | –ü—Ä–∏–º–µ—Ä—ã |
|----------|-------|---------|
| **–ü—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–∏ | `temp_test.py` |
| **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** | –ü—Ä–æ—Å—Ç—ã–µ —Ñ–∞–π–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ | `.env`, `config.json` |
| **–°–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏** | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ | SQL DDL, `alembic` |
| **Hotfix –≤ –ø—Ä–æ–¥–µ** | –°—Ä–æ—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á |

**–ö—Ä–∏—Ç–µ—Ä–∏–π**: –ù—É–∂–Ω–∞ **—Å–∫–æ—Ä–æ—Å—Ç—å**, –∫–æ–¥ **–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π** –∏–ª–∏ **—Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π**.

---

## ÔøΩüèóÔ∏è Architecture

```mermaid
graph TD
    A[User Task Request] --> B[Copilot: Create GitHub Issue]
    B --> C{Complex Decision?}
    C -->|Yes| D[User: Consult Perplexity/GPT-4]
    C -->|No| E[Copilot: Implement Solution]
    D --> F[User: Provide Research Summary]
    F --> E
    E --> G[Copilot: Write Tests]
    G --> H[Copilot: Run Tests]
    H --> I{Tests Pass?}
    I -->|No| J[Copilot: Debug & Fix]
    J --> H
    I -->|Yes| K[Copilot: Create PR]
    K --> L[User: Review & Merge]
```

---

## üìã Workflow Steps

### **Phase 1: Task Creation (Copilot)**
```markdown
User: "Fix position sizing - positions too large"

Copilot:
1. Create GitHub Issue #123: "Bug: Position sizes exceed risk tolerance"
2. Add labels: `bug`, `high-priority`, `backtesting`
3. Assign to milestone: "High Priority Anomalies"
4. Set description:
   ```
   **Problem**: Backtest positions are 50%+ of capital, causing liquidations
   **Expected**: Max 10% per position
   **Files**: backend/core/backtest_engine.py, backend/core/position_sizing.py
   **Tests needed**: test_position_sizing.py
   ```
```

### **Phase 2: Research (User + Perplexity/GPT-4)**

**When to request research:**
- ‚ùì New algorithm/pattern needed
- ‚ùì Security/performance critical decisions
- ‚ùì Multiple implementation approaches exist
- ‚ùì Industry best practices unclear

**User action:**
```markdown
User copies issue to Perplexity:
> "What are the best practices for position sizing in crypto trading backtests?
> Context: Python backtesting system, need to prevent liquidations.
> Current problem: positions are 50%+ of capital"

Perplexity responds with:
1. Kelly Criterion (optimal growth, aggressive)
2. Fixed Fractional (2-5% per trade, conservative)
3. Volatility-based (ATR-adjusted, adaptive)

User provides summary to Copilot:
"Use Fixed Fractional (3% default) with Kelly Criterion as option for advanced users.
ATR-based sizing for volatile markets."
```

### **Phase 3: Implementation (Copilot)**
```python
# Copilot implements based on research
class PositionSizer:
    """Position sizing strategies for risk management."""
    
    def __init__(self, method: str = "fixed_fractional"):
        self.method = method
    
    def calculate(
        self,
        capital: float,
        price: float,
        risk_pct: float = 0.03  # Research: 3% default
    ) -> float:
        """Calculate position size based on strategy."""
        if self.method == "fixed_fractional":
            return self._fixed_fractional(capital, risk_pct)
        elif self.method == "kelly":
            return self._kelly_criterion(capital, price)
        else:
            raise ValueError(f"Unknown method: {self.method}")
```

### **Phase 4: Testing (Copilot)**
```python
# tests/test_position_sizing.py
def test_fixed_fractional_sizing():
    """Test that fixed fractional sizing caps at 3% of capital."""
    sizer = PositionSizer(method="fixed_fractional")
    capital = 10000
    price = 50
    
    position = sizer.calculate(capital, price, risk_pct=0.03)
    
    assert position <= capital * 0.03 / price  # Max 3% of capital
    assert position > 0  # Always positive
```

### **Phase 5: Validation & PR (Copilot)**
```markdown
Copilot:
1. Run tests: `pytest tests/test_position_sizing.py -v`
2. Check coverage: `pytest --cov=backend/core/position_sizing.py`
3. Create PR: "feat: Implement risk-based position sizing (Fixes #123)"
4. Link PR to issue
5. Request user review
```

---

## üîÑ Decision Matrix: When to Research

| Scenario | Copilot Solo | Research Required |
|----------|--------------|-------------------|
| Bug fix (obvious logic error) | ‚úÖ | ‚ùå |
| New algorithm (position sizing) | ‚ùå | ‚úÖ Perplexity |
| UI component (standard pattern) | ‚úÖ | ‚ùå |
| Security critical (auth, RBAC) | ‚ùå | ‚úÖ GPT-4 + Docs |
| Performance optimization | ‚ùå | ‚úÖ Perplexity |
| Database schema change | ‚ùå | ‚úÖ PostgreSQL docs |
| Simple refactoring | ‚úÖ | ‚ùå |
| API design (new endpoint) | ‚ùå | ‚úÖ FastAPI best practices |

---

## üéØ Current High Priority Tasks

### **Task #1: Position Sizing (Issue #4)**
**Status**: Ready for Research
**Research Query**: 
```
"Best practices for position sizing in crypto backtesting systems.
Requirements:
- Prevent liquidations (max loss tolerance)
- Support multiple strategies (Kelly, Fixed %, ATR-based)
- Python implementation with type hints
- Suitable for FastAPI backend"
```

**Expected Research Output**:
- Algorithm comparison table
- Recommended default values
- Edge case handling (zero volatility, negative returns)
- Code examples

---

### **Task #2: Signal Exit Logic (Issue #5)**
**Status**: Ready for Research
**Research Query**:
```
"How to prevent premature exits in trend-following strategies?
Problem: Strategy exits on small pullbacks during strong trends
Context: Bybit perpetual futures, 1-minute to daily timeframes
Need: Exit rules that distinguish pullback vs reversal"
```

---

### **Task #3: Buy & Hold Benchmark (Issue #6)**
**Status**: Implementation Ready (No research needed)
**Rationale**: Standard calculation, well-documented

---

### **Task #4: Margin Call Simulation (Issue #7)**
**Status**: Ready for Research
**Research Query**:
```
"How to accurately simulate margin calls and liquidations in crypto backtests?
Exchange: Bybit
Leverage: 1-100x
Margin mode: Cross margin and isolated margin
Need: Realistic liquidation price calculation"
```

---

## üìù Communication Templates

### **Template 1: Request Research**
```markdown
@User - Research needed for Issue #123

**Question**: [Specific technical question]
**Context**: [Current implementation, constraints]
**Options considered**: [If any]
**Decision impact**: [Performance/Security/UX]

Please consult Perplexity/GPT-4 and provide summary with:
- Recommended approach
- Trade-offs
- Code examples (if available)
```

### **Template 2: Research Summary (User provides)**
```markdown
Research Summary for Issue #123

**Source**: Perplexity AI / GPT-4 / Official Docs
**Recommendation**: [Chosen approach]
**Rationale**: [Why this is best for our use case]
**Implementation notes**: 
- [Key point 1]
- [Key point 2]
**References**: [Links if available]

@Copilot - Proceed with implementation
```

### **Template 3: Implementation Complete**
```markdown
‚úÖ Issue #123 - Implementation Complete

**Files changed**:
- backend/core/position_sizing.py (new file)
- tests/test_position_sizing.py (new file)
- backend/core/backtest_engine.py (updated)

**Tests**: 15/15 passing (100%)
**Coverage**: 95% (position_sizing.py)

**PR**: #456 "feat: Implement risk-based position sizing"
**Ready for review**
```

---

## üõ°Ô∏è Safety Rules

1. **Never implement complex algorithms without research**
2. **Never skip tests** - minimum 80% coverage
3. **Never commit untested code**
4. **Always link commits to issues** - use `Fixes #123`
5. **Always request review for security-critical changes**

---

## üöÄ Quick Start

### **Starting a new task:**
```bash
# User provides task
User: "Implement position sizing with risk management"

# Copilot creates issue
Copilot: "Created Issue #123 - Awaiting research on position sizing algorithms"

# User researches
User: [Consults Perplexity, provides summary]

# Copilot implements
Copilot: "Implementing Fixed Fractional sizing based on research..."

# Tests pass
Copilot: "Tests passing, PR #456 ready for review"

# User merges
User: "Merged PR #456, closing Issue #123"
```

---

## üìä Metrics

Track effectiveness:
- **Issues created**: Auto-tracked in GitHub
- **Research requests**: Tag with `needs-research` label
- **Implementation time**: Track from research ‚Üí PR
- **Test coverage**: Target 95%+
- **Bug regression**: Track reopened issues

---

**Remember**: This is a **cooperative system**. Copilot handles execution, User handles strategic research. Together we build better software! üöÄ
