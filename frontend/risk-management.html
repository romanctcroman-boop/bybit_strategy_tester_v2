<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Security Headers -->
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; connect-src 'self' https://cdn.jsdelivr.net https://api.bybit.com wss://stream.bybit.com ws://localhost:* http://localhost:*; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'"
        />
        <meta http-equiv="X-Content-Type-Options" content="nosniff" />
        <meta name="referrer" content="strict-origin-when-cross-origin" />

        <title>Risk Management - Bybit Strategy Tester v2</title>
        <!-- Production Init (must load before all other scripts) -->
        <script src="js/init-production.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
            integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4"
            crossorigin="anonymous"
        ></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- External CSS (Phase 1) -->
        <link rel="stylesheet" href="./css/variables.css" />
        <link rel="stylesheet" href="./css/components.css" />
        <link rel="stylesheet" href="./css/common.css" />
        <link rel="stylesheet" href="./css/risk_management.css" />

        <script src="js/core/auto-event-binding.js"></script>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar">
            <div class="d-flex align-items-center gap-4">
                <a href="dashboard.html" class="navbar-brand">
                    <i class="bi bi-graph-up-arrow"></i> Bybit Strategy Tester
                </a>
                <div class="nav-links">
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="strategy-builder.html" class="nav-link">Strategies</a>
                    <a href="portfolio.html" class="nav-link">Portfolio</a>
                    <a href="risk-management.html" class="nav-link active">Risk</a>
                    <a href="ml-models.html" class="nav-link">ML Models</a>
                </div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="text-secondary"> <i class="bi bi-shield-check"></i> Risk Engine Active </span>
            </div>
        </nav>

        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title"><i class="bi bi-shield-exclamation"></i> Risk Management</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary" onclick="exportReport()">
                        <i class="bi bi-file-earmark-pdf"></i> Export Report
                    </button>
                    <button class="btn btn-primary" onclick="openSettingsModal()">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </div>
            </div>

            <!-- Risk Overview Cards -->
            <div class="risk-overview">
                <div class="risk-card good">
                    <div class="risk-icon good">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="risk-label">Overall Risk Score</div>
                    <div class="risk-value good">72</div>
                </div>
                <div class="risk-card warning">
                    <div class="risk-icon warning">
                        <i class="bi bi-graph-down-arrow"></i>
                    </div>
                    <div class="risk-label">Max Drawdown</div>
                    <div class="risk-value warning">-15.3%</div>
                </div>
                <div class="risk-card good">
                    <div class="risk-icon good">
                        <i class="bi bi-percent"></i>
                    </div>
                    <div class="risk-label">Risk/Reward Ratio</div>
                    <div class="risk-value good">1:2.4</div>
                </div>
                <div class="risk-card">
                    <div class="risk-icon neutral">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <div class="risk-label">Leverage Used</div>
                    <div class="risk-value">3.2x</div>
                </div>
                <div class="risk-card good">
                    <div class="risk-icon good">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="risk-label">Available Margin</div>
                    <div class="risk-value good">68%</div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="main-grid">
                <!-- Drawdown Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Drawdown History</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="drawdownChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- VaR Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Value at Risk (VaR)</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="varChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Position Limits -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Position Limits</span>
                    </div>
                    <div class="card-body">
                        <div class="limit-item">
                            <div class="limit-info">
                                <div class="limit-name">Max Position Size</div>
                                <div class="limit-desc">Maximum single position relative to portfolio</div>
                            </div>
                            <div class="limit-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill medium" id="positionSizeBar"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Current: 18%</span>
                                    <span>Limit: 25%</span>
                                </div>
                            </div>
                            <div class="limit-value">72%</div>
                        </div>
                        <div class="limit-item">
                            <div class="limit-info">
                                <div class="limit-name">Daily Loss Limit</div>
                                <div class="limit-desc">Maximum allowed loss per day</div>
                            </div>
                            <div class="limit-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill low" id="dailyLossBar"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Current: $1,250</span>
                                    <span>Limit: $5,000</span>
                                </div>
                            </div>
                            <div class="limit-value">25%</div>
                        </div>
                        <div class="limit-item">
                            <div class="limit-info">
                                <div class="limit-name">Max Leverage</div>
                                <div class="limit-desc">Maximum allowed leverage across all positions</div>
                            </div>
                            <div class="limit-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill medium" id="leverageBar"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Current: 3.2x</span>
                                    <span>Limit: 5x</span>
                                </div>
                            </div>
                            <div class="limit-value">64%</div>
                        </div>
                        <div class="limit-item">
                            <div class="limit-info">
                                <div class="limit-name">Correlation Limit</div>
                                <div class="limit-desc">Maximum correlation between positions</div>
                            </div>
                            <div class="limit-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill high" id="correlationBar"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Current: 0.72</span>
                                    <span>Limit: 0.80</span>
                                </div>
                            </div>
                            <div class="limit-value">90%</div>
                        </div>
                    </div>
                </div>

                <!-- Correlation Matrix -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Asset Correlation Matrix</span>
                    </div>
                    <div class="card-body">
                        <div class="correlation-matrix" id="correlationMatrix">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Active Alerts - Full Width -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Active Risk Alerts</span>
                        <span class="text-secondary" id="alertCount">3 Active</span>
                    </div>
                    <div class="card-body card-body-flush">
                        <table class="alerts-table">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Alert</th>
                                    <th>Asset</th>
                                    <th>Details</th>
                                    <th>Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Risk Settings -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Risk Controls</span>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Auto Stop Loss</div>
                                        <div class="toggle-desc">Automatically set stop loss for new positions</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            checked
                                            title="Toggle Auto Stop Loss"
                                            aria-label="Toggle Auto Stop Loss"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Position Size Limits</div>
                                        <div class="toggle-desc">Enforce maximum position size rules</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            checked
                                            title="Toggle Position Size Limits"
                                            aria-label="Toggle Position Size Limits"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Daily Loss Circuit Breaker</div>
                                        <div class="toggle-desc">Halt trading when daily loss limit is reached</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            checked
                                            title="Toggle Daily Loss Circuit Breaker"
                                            aria-label="Toggle Daily Loss Circuit Breaker"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Correlation Monitoring</div>
                                        <div class="toggle-desc">Alert when asset correlations exceed threshold</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            checked
                                            title="Toggle Correlation Monitoring"
                                            aria-label="Toggle Correlation Monitoring"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Volatility Alerts</div>
                                        <div class="toggle-desc">Notify when market volatility spikes</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            checked
                                            title="Toggle Volatility Alerts"
                                            aria-label="Toggle Volatility Alerts"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-switch">
                                    <div>
                                        <div class="toggle-label">Margin Call Protection</div>
                                        <div class="toggle-desc">Auto-reduce positions before margin call</div>
                                    </div>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            title="Toggle Margin Call Protection"
                                            aria-label="Toggle Margin Call Protection"
                                        />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="module" src="./js/pages/risk_management.js"></script>
    </body>
</html>
