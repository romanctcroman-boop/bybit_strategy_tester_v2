<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; connect-src 'self' https://api.bybit.com wss://stream.bybit.com ws://localhost:* http://localhost:*; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <title>Strategy Builder - Bybit Strategy Tester v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- External CSS (Phase 1) -->
    <link rel="stylesheet" href="/frontend/css/variables.css">
    <link rel="stylesheet" href="/frontend/css/components.css">
    <link rel="stylesheet" href="/frontend/css/common.css">
    <link rel="stylesheet" href="/frontend/css/strategy_builder.css">

    </head>
<body>
    <div class="app-layout">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-left">
                <a href="dashboard.html" class="navbar-brand" title="Back to Dashboard" aria-label="Back to Dashboard">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div class="strategy-name">
                    <i class="bi bi-diagram-3"></i>
                    <label for="strategyName" class="visually-hidden">Strategy name</label>
                    <input type="text" id="strategyName" value="New Strategy" placeholder="Strategy name..." title="Strategy name">
                </div>
                <span class="text-secondary text-sm">
                    <i class="bi bi-clock"></i> Last saved: Never
                </span>
            </div>
            <div class="navbar-actions">
                <button class="btn btn-secondary" onclick="openTemplatesModal()">
                    <i class="bi bi-collection"></i> Templates
                </button>
                <button class="btn btn-secondary" onclick="validateStrategy()">
                    <i class="bi bi-check-circle"></i> Validate
                </button>
                <button class="btn btn-secondary" onclick="generateCode()">
                    <i class="bi bi-code-slash"></i> Generate Code
                </button>
                <button class="btn btn-primary" onclick="saveStrategy()">
                    <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-success" onclick="runBacktest()">
                    <i class="bi bi-play-fill"></i> Backtest
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Block Library -->
            <div class="sidebar-left">
                <div class="sidebar-header">
                    <span class="sidebar-title">Block Library</span>
                    <button class="btn btn-icon btn-secondary btn-sm" title="Collapse sidebar" aria-label="Collapse sidebar">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>
                <div class="sidebar-search">
                    <label for="blockSearch" class="visually-hidden">Search blocks</label>
                    <input type="text" class="search-input" id="blockSearch" placeholder="Search blocks..." title="Search blocks">
                </div>
                <div class="block-categories" id="blockCategories">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="canvas-toolbar">
                    <div class="toolbar-group">
                        <button class="btn btn-icon btn-secondary" onclick="undo()" title="Undo">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="redo()" title="Redo">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn btn-icon btn-secondary" onclick="deleteSelected()" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="duplicateSelected()" title="Duplicate">
                            <i class="bi bi-copy"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn btn-icon btn-secondary" onclick="alignBlocks('left')" title="Align Left">
                            <i class="bi bi-align-start"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="alignBlocks('center')" title="Align Center">
                            <i class="bi bi-align-center"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="alignBlocks('right')" title="Align Right">
                            <i class="bi bi-align-end"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn btn-icon btn-secondary" onclick="autoLayout()" title="Auto Layout">
                            <i class="bi bi-grid-3x3"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="fitToScreen()" title="Fit to Screen">
                            <i class="bi bi-fullscreen"></i>
                        </button>
                    </div>
                </div>

                <div class="canvas-container" id="canvasContainer">
                    <svg class="canvas" id="connectionsCanvas">
                        <!-- Connection lines rendered here -->
                    </svg>
                    <div id="blocksContainer">
                        <!-- Strategy blocks rendered here -->
                    </div>

                    <!-- Zoom Controls -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()" title="Zoom out" aria-label="Zoom out">
                            <i class="bi bi-dash"></i>
                        </button>
                        <span class="zoom-level" id="zoomLevel">100%</span>
                        <button class="zoom-btn" onclick="zoomIn()" title="Zoom in" aria-label="Zoom in">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button class="zoom-btn" onclick="resetZoom()" title="Reset zoom" aria-label="Reset zoom">
                            <i class="bi bi-arrows-angle-expand"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Properties -->
            <div class="sidebar-right">
                <div class="sidebar-header">
                    <span class="sidebar-title">Properties</span>
                </div>
                <div class="properties-panel" id="propertiesPanel">
                    <div class="properties-section">
                        <div class="properties-section-header">
                            <span class="properties-section-title">Block Properties</span>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="properties-section-content" id="blockProperties">
                            <p class="text-secondary text-center py-3">
                                Select a block to view its properties
                            </p>
                        </div>
                    </div>
                    <div class="properties-section">
                        <div class="properties-section-header">
                            <span class="properties-section-title">Strategy Settings</span>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="properties-section-content">
                            <div class="property-row">
                                <span class="property-label">Timeframe</span>
                                <select class="property-select" id="strategyTimeframe" title="Strategy Timeframe">
                                    <option value="1m">1 minute</option>
                                    <option value="5m">5 minutes</option>
                                    <option value="15m" selected>15 minutes</option>
                                    <option value="1h">1 hour</option>
                                    <option value="4h">4 hours</option>
                                    <option value="1d">1 day</option>
                                </select>
                            </div>
                            <div class="property-row">
                                <span class="property-label">Symbol</span>
                                <select class="property-select" id="strategySymbol" title="Strategy Symbol">
                                    <option value="BTCUSDT">BTCUSDT</option>
                                    <option value="ETHUSDT">ETHUSDT</option>
                                    <option value="SOLUSDT">SOLUSDT</option>
                                </select>
                            </div>
                            <div class="property-row">
                                <label for="initialCapital" class="property-label">Initial Capital</label>
                                <input type="number" class="property-input" id="initialCapital" value="10000" title="Initial capital for backtesting">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation Panel -->
                <div class="validation-panel">
                    <div class="validation-header">
                        <span class="validation-title">Validation</span>
                        <span class="validation-status valid" id="validationStatus">
                            <i class="bi bi-check-circle-fill"></i> Valid
                        </span>
                    </div>
                    <div class="validation-list" id="validationList">
                        <div class="validation-item info">
                            <i class="bi bi-info-circle"></i>
                            <span>Add blocks to start building your strategy</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Strategy Templates</h3>
                <button class="modal-close" onclick="closeTemplatesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="templates-grid" id="templatesGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplatesModal()">Cancel</button>
                <button class="btn btn-primary" onclick="loadSelectedTemplate()">
                    <i class="bi bi-check-lg"></i> Use Template
                </button>
            </div>
        </div>
    </div>

    <script>
        // Block Library Data
        const blockLibrary = {
            indicators: [
                { id: 'rsi', name: 'RSI', desc: 'Relative Strength Index', icon: 'graph-up' },
                { id: 'macd', name: 'MACD', desc: 'Moving Average Convergence Divergence', icon: 'bar-chart' },
                { id: 'ema', name: 'EMA', desc: 'Exponential Moving Average', icon: 'graph-up-arrow' },
                { id: 'sma', name: 'SMA', desc: 'Simple Moving Average', icon: 'graph-up-arrow' },
                { id: 'bollinger', name: 'Bollinger Bands', desc: 'Volatility indicator', icon: 'distribute-vertical' },
                { id: 'atr', name: 'ATR', desc: 'Average True Range', icon: 'arrows-expand' },
                { id: 'stochastic', name: 'Stochastic', desc: 'Stochastic Oscillator', icon: 'percent' },
                { id: 'adx', name: 'ADX', desc: 'Average Directional Index', icon: 'activity' }
            ],
            conditions: [
                { id: 'crossover', name: 'Crossover', desc: 'When value A crosses above B', icon: 'intersect' },
                { id: 'crossunder', name: 'Crossunder', desc: 'When value A crosses below B', icon: 'intersect' },
                { id: 'greater_than', name: 'Greater Than', desc: 'When value A > B', icon: 'chevron-double-up' },
                { id: 'less_than', name: 'Less Than', desc: 'When value A < B', icon: 'chevron-double-down' },
                { id: 'equals', name: 'Equals', desc: 'When value A equals B', icon: 'dash' },
                { id: 'between', name: 'Between', desc: 'When value is in range', icon: 'arrows-collapse' }
            ],
            actions: [
                { id: 'buy', name: 'Buy', desc: 'Open long position', icon: 'arrow-up-circle' },
                { id: 'sell', name: 'Sell', desc: 'Open short position', icon: 'arrow-down-circle' },
                { id: 'close', name: 'Close Position', desc: 'Close current position', icon: 'x-circle' },
                { id: 'stop_loss', name: 'Stop Loss', desc: 'Set stop loss level', icon: 'shield-x' },
                { id: 'take_profit', name: 'Take Profit', desc: 'Set take profit level', icon: 'trophy' },
                { id: 'trailing_stop', name: 'Trailing Stop', desc: 'Set trailing stop', icon: 'arrow-bar-down' }
            ],
            logic: [
                { id: 'and', name: 'AND', desc: 'All conditions must be true', icon: 'union' },
                { id: 'or', name: 'OR', desc: 'Any condition must be true', icon: 'exclude' },
                { id: 'not', name: 'NOT', desc: 'Inverse condition', icon: 'slash-circle' },
                { id: 'delay', name: 'Delay', desc: 'Wait N bars', icon: 'clock-history' },
                { id: 'filter', name: 'Filter', desc: 'Filter signals', icon: 'funnel' }
            ],
            inputs: [
                { id: 'price', name: 'Price', desc: 'OHLCV price data', icon: 'currency-dollar' },
                { id: 'volume', name: 'Volume', desc: 'Trading volume', icon: 'bar-chart-steps' },
                { id: 'constant', name: 'Constant', desc: 'Fixed numeric value', icon: 'hash' },
                { id: 'timeframe', name: 'Timeframe', desc: 'Chart timeframe', icon: 'calendar' }
            ]
        };

        // Strategy Templates
        const templates = [
            {
                id: 'rsi_oversold',
                name: 'RSI Oversold Strategy',
                desc: 'Buy when RSI is oversold, sell when overbought',
                icon: 'graph-up',
                iconColor: 'var(--accent-blue)',
                blocks: 4,
                connections: 3,
                category: 'Mean Reversion'
            },
            {
                id: 'macd_crossover',
                name: 'MACD Crossover',
                desc: 'Trade MACD line crossovers with signal line',
                icon: 'bar-chart',
                iconColor: 'var(--accent-purple)',
                blocks: 5,
                connections: 4,
                category: 'Trend Following'
            },
            {
                id: 'bollinger_bounce',
                name: 'Bollinger Bounce',
                desc: 'Trade bounces off Bollinger Band boundaries',
                icon: 'distribute-vertical',
                iconColor: 'var(--accent-yellow)',
                blocks: 6,
                connections: 5,
                category: 'Mean Reversion'
            },
            {
                id: 'ema_crossover',
                name: 'EMA Crossover',
                desc: 'Classic dual EMA crossover strategy',
                icon: 'graph-up-arrow',
                iconColor: 'var(--accent-green)',
                blocks: 4,
                connections: 3,
                category: 'Trend Following'
            },
            {
                id: 'breakout',
                name: 'Breakout Strategy',
                desc: 'Trade breakouts from consolidation ranges',
                icon: 'arrows-expand',
                iconColor: 'var(--accent-orange)',
                blocks: 7,
                connections: 6,
                category: 'Momentum'
            },
            {
                id: 'multi_indicator',
                name: 'Multi-Indicator Confluence',
                desc: 'Combine multiple indicators for confirmation',
                icon: 'layers',
                iconColor: 'var(--accent-red)',
                blocks: 10,
                connections: 9,
                category: 'Advanced'
            }
        ];

        // State
        let strategyBlocks = [];
        let connections = [];
        let selectedBlockId = null;
        let selectedTemplate = null;
        let zoom = 1;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderBlockLibrary();
            renderTemplates();
            setupEventListeners();
        });

        function renderBlockLibrary() {
            const container = document.getElementById('blockCategories');
            container.innerHTML = '';

            const categories = [
                { key: 'indicators', name: 'Indicators', iconType: 'indicator' },
                { key: 'conditions', name: 'Conditions', iconType: 'condition' },
                { key: 'actions', name: 'Actions', iconType: 'action' },
                { key: 'logic', name: 'Logic', iconType: 'logic' },
                { key: 'inputs', name: 'Inputs', iconType: 'input' }
            ];

            categories.forEach(cat => {
                const blocks = blockLibrary[cat.key];
                const html = `
                    <div class="block-category">
                        <div class="category-header" onclick="toggleCategory(this)">
                            <i class="bi bi-chevron-down"></i>
                            <span>${cat.name}</span>
                            <span class="text-secondary">(${blocks.length})</span>
                        </div>
                        <div class="block-list">
                            ${blocks.map(block => `
                                <div class="block-item" 
                                     draggable="true" 
                                     data-block-id="${block.id}"
                                     data-block-type="${cat.iconType}"
                                     ondragstart="onBlockDragStart(event, '${block.id}', '${cat.iconType}')"
                                     onclick="addBlockToCanvas('${block.id}', '${cat.iconType}')">
                                    <div class="block-icon ${cat.iconType}">
                                        <i class="bi bi-${block.icon}"></i>
                                    </div>
                                    <div class="block-info">
                                        <div class="block-name">${block.name}</div>
                                        <div class="block-desc">${block.desc}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderTemplates() {
            const container = document.getElementById('templatesGrid');
            container.innerHTML = templates.map(template => `
                <div class="template-card ${selectedTemplate === template.id ? 'selected' : ''}" 
                     onclick="selectTemplate('${template.id}')">
                    <div class="template-icon" style="background: ${template.iconColor}15; color: ${template.iconColor}">
                        <i class="bi bi-${template.icon}"></i>
                    </div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.desc}</div>
                    <div class="template-meta">
                        <span><i class="bi bi-box"></i> ${template.blocks} blocks</span>
                        <span><i class="bi bi-link"></i> ${template.connections} connections</span>
                        <span><i class="bi bi-tag"></i> ${template.category}</span>
                    </div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            // Canvas drop zone
            const canvas = document.getElementById('canvasContainer');
            canvas.addEventListener('dragover', e => e.preventDefault());
            canvas.addEventListener('drop', onCanvasDrop);

            // Block search
            document.getElementById('blockSearch').addEventListener('input', filterBlocks);
        }

        function toggleCategory(header) {
            const category = header.parentElement;
            const list = category.querySelector('.block-list');
            const icon = header.querySelector('i');
            
            list.style.display = list.style.display === 'none' ? 'flex' : 'none';
            icon.classList.toggle('bi-chevron-down');
            icon.classList.toggle('bi-chevron-right');
        }

        function filterBlocks() {
            const search = document.getElementById('blockSearch').value.toLowerCase();
            const items = document.querySelectorAll('.block-item');
            
            items.forEach(item => {
                const name = item.querySelector('.block-name').textContent.toLowerCase();
                const desc = item.querySelector('.block-desc').textContent.toLowerCase();
                item.style.display = name.includes(search) || desc.includes(search) ? 'flex' : 'none';
            });
        }

        function onBlockDragStart(event, blockId, blockType) {
            event.dataTransfer.setData('blockId', blockId);
            event.dataTransfer.setData('blockType', blockType);
        }

        function onCanvasDrop(event) {
            event.preventDefault();
            const blockId = event.dataTransfer.getData('blockId');
            const blockType = event.dataTransfer.getData('blockType');
            
            if (blockId && blockType) {
                const rect = event.currentTarget.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                addBlockToCanvas(blockId, blockType, x, y);
            }
        }

        function addBlockToCanvas(blockId, blockType, x = null, y = null) {
            // Find block definition
            let blockDef = null;
            Object.values(blockLibrary).forEach(category => {
                const found = category.find(b => b.id === blockId);
                if (found) blockDef = found;
            });

            if (!blockDef) return;

            // Create block
            const block = {
                id: `block_${Date.now()}`,
                type: blockId,
                category: blockType,
                name: blockDef.name,
                icon: blockDef.icon,
                x: x || 100 + strategyBlocks.length * 50,
                y: y || 100 + strategyBlocks.length * 30,
                params: getDefaultParams(blockId)
            };

            strategyBlocks.push(block);
            renderBlocks();
            selectBlock(block.id);
        }

        function getDefaultParams(blockType) {
            const params = {
                rsi: { period: 14, overbought: 70, oversold: 30 },
                macd: { fast: 12, slow: 26, signal: 9 },
                ema: { period: 20 },
                sma: { period: 50 },
                bollinger: { period: 20, stdDev: 2 },
                atr: { period: 14 },
                stochastic: { k: 14, d: 3 },
                adx: { period: 14 },
                crossover: {},
                crossunder: {},
                greater_than: { value: 0 },
                less_than: { value: 0 },
                buy: { quantity: 100, orderType: 'market' },
                sell: { quantity: 100, orderType: 'market' },
                stop_loss: { percent: 2 },
                take_profit: { percent: 5 },
                delay: { bars: 1 },
                constant: { value: 0 }
            };
            return params[blockType] || {};
        }

        function renderBlocks() {
            const container = document.getElementById('blocksContainer');
            container.innerHTML = strategyBlocks.map(block => `
                <div class="strategy-block ${selectedBlockId === block.id ? 'selected' : ''}"
                     id="${block.id}"
                     style="left: ${block.x}px; top: ${block.y}px"
                     onmousedown="startDragBlock(event, '${block.id}')"
                     onclick="selectBlock('${block.id}')">
                    <div class="port input"></div>
                    <div class="block-header">
                        <div class="block-header-icon ${block.category}">
                            <i class="bi bi-${block.icon}"></i>
                        </div>
                        <span class="block-header-title">${block.name}</span>
                        <button class="block-header-menu" onclick="event.stopPropagation(); showBlockMenu('${block.id}')">
                            <i class="bi bi-three-dots"></i>
                        </button>
                    </div>
                    <div class="block-body">
                        ${renderBlockParams(block)}
                    </div>
                    <div class="port output"></div>
                </div>
            `).join('');
        }

        function renderBlockParams(block) {
            const params = block.params;
            if (Object.keys(params).length === 0) {
                return '<span class="text-secondary" style="font-size: 11px">No parameters</span>';
            }

            return Object.entries(params).map(([key, value]) => `
                <div class="block-param">
                    <span class="block-param-label">${formatParamName(key)}</span>
                    <input type="text" 
                           class="block-param-input" 
                           value="${value}"
                           onchange="updateBlockParam('${block.id}', '${key}', this.value)"
                           onclick="event.stopPropagation()">
                </div>
            `).join('');
        }

        function formatParamName(name) {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function selectBlock(blockId) {
            selectedBlockId = blockId;
            renderBlocks();
            renderBlockProperties();
        }

        function renderBlockProperties() {
            const container = document.getElementById('blockProperties');
            const block = strategyBlocks.find(b => b.id === selectedBlockId);

            if (!block) {
                container.innerHTML = '<p class="text-secondary" style="font-size: 13px; text-align: center; padding: 20px 0">Select a block to view its properties</p>';
                return;
            }

            container.innerHTML = `
                <div class="property-row">
                    <span class="property-label">Name</span>
                    <span class="property-value">${block.name}</span>
                </div>
                <div class="property-row">
                    <span class="property-label">Type</span>
                    <span class="property-value">${block.type}</span>
                </div>
                <div class="property-row">
                    <span class="property-label">Category</span>
                    <span class="property-value">${block.category}</span>
                </div>
                <hr style="border-color: var(--border-color); margin: 12px 0">
                ${Object.entries(block.params).map(([key, value]) => `
                    <div class="property-row">
                        <span class="property-label">${formatParamName(key)}</span>
                        <input type="text" class="property-input" value="${value}" 
                               onchange="updateBlockParam('${block.id}', '${key}', this.value)">
                    </div>
                `).join('')}
            `;
        }

        function updateBlockParam(blockId, param, value) {
            const block = strategyBlocks.find(b => b.id === blockId);
            if (block) {
                block.params[param] = isNaN(value) ? value : parseFloat(value);
                renderBlocks();
            }
        }

        function startDragBlock(event, blockId) {
            if (event.target.closest('.block-param-input')) return;
            
            isDragging = true;
            const block = document.getElementById(blockId);
            const rect = block.getBoundingClientRect();
            dragOffset = {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const container = document.getElementById('canvasContainer').getBoundingClientRect();
                const x = e.clientX - container.left - dragOffset.x;
                const y = e.clientY - container.top - dragOffset.y;
                
                block.style.left = `${Math.max(0, x)}px`;
                block.style.top = `${Math.max(0, y)}px`;
                
                // Update state
                const blockData = strategyBlocks.find(b => b.id === blockId);
                if (blockData) {
                    blockData.x = Math.max(0, x);
                    blockData.y = Math.max(0, y);
                }
            };

            const onMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Modal functions
        function openTemplatesModal() {
            document.getElementById('templatesModal').classList.add('active');
        }

        function closeTemplatesModal() {
            document.getElementById('templatesModal').classList.remove('active');
        }

        function selectTemplate(templateId) {
            selectedTemplate = templateId;
            renderTemplates();
        }

        function loadSelectedTemplate() {
            if (!selectedTemplate) {
                alert('Please select a template');
                return;
            }

            const template = templates.find(t => t.id === selectedTemplate);
            if (template) {
                document.getElementById('strategyName').value = template.name;
                // Would load template blocks here
                alert(`Loading template: ${template.name}`);
                closeTemplatesModal();
            }
        }

        // Toolbar functions
        function undo() {
            console.log('Undo');
        }

        function redo() {
            console.log('Redo');
        }

        function deleteSelected() {
            if (selectedBlockId) {
                strategyBlocks = strategyBlocks.filter(b => b.id !== selectedBlockId);
                selectedBlockId = null;
                renderBlocks();
                renderBlockProperties();
            }
        }

        function duplicateSelected() {
            if (selectedBlockId) {
                const block = strategyBlocks.find(b => b.id === selectedBlockId);
                if (block) {
                    const newBlock = {
                        ...block,
                        id: `block_${Date.now()}`,
                        x: block.x + 30,
                        y: block.y + 30,
                        params: { ...block.params }
                    };
                    strategyBlocks.push(newBlock);
                    renderBlocks();
                    selectBlock(newBlock.id);
                }
            }
        }

        function alignBlocks(direction) {
            console.log(`Align ${direction}`);
        }

        function autoLayout() {
            console.log('Auto layout');
        }

        function fitToScreen() {
            resetZoom();
        }

        function zoomIn() {
            zoom = Math.min(zoom + 0.1, 2);
            updateZoom();
        }

        function zoomOut() {
            zoom = Math.max(zoom - 0.1, 0.5);
            updateZoom();
        }

        function resetZoom() {
            zoom = 1;
            updateZoom();
        }

        function updateZoom() {
            document.getElementById('zoomLevel').textContent = `${Math.round(zoom * 100)}%`;
            document.getElementById('blocksContainer').style.transform = `scale(${zoom})`;
            document.getElementById('blocksContainer').style.transformOrigin = '0 0';
        }

        // Strategy actions
        async function validateStrategy() {
            const result = {
                valid: strategyBlocks.length > 0,
                errors: [],
                warnings: []
            };

            if (strategyBlocks.length === 0) {
                result.errors.push('Strategy has no blocks');
            }

            const hasEntry = strategyBlocks.some(b => b.type === 'buy' || b.type === 'sell');
            if (!hasEntry) {
                result.warnings.push('Strategy has no entry signals');
            }

            updateValidationPanel(result);
        }

        function updateValidationPanel(result) {
            const status = document.getElementById('validationStatus');
            const list = document.getElementById('validationList');

            if (result.valid && result.errors.length === 0) {
                status.className = 'validation-status valid';
                status.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valid';
            } else {
                status.className = 'validation-status invalid';
                status.innerHTML = '<i class="bi bi-x-circle-fill"></i> Invalid';
            }

            let html = '';
            result.errors.forEach(err => {
                html += `<div class="validation-item error"><i class="bi bi-x-circle"></i><span>${err}</span></div>`;
            });
            result.warnings.forEach(warn => {
                html += `<div class="validation-item warning"><i class="bi bi-exclamation-triangle"></i><span>${warn}</span></div>`;
            });

            if (html === '') {
                html = '<div class="validation-item info"><i class="bi bi-info-circle"></i><span>Strategy is ready for backtesting</span></div>';
            }

            list.innerHTML = html;
        }

        async function generateCode() {
            const name = document.getElementById('strategyName').value;
            alert(`Generating Python code for strategy: ${name}\n\nBlocks: ${strategyBlocks.length}\nConnections: ${connections.length}`);
        }

        async function saveStrategy() {
            const strategy = {
                name: document.getElementById('strategyName').value,
                timeframe: document.getElementById('strategyTimeframe').value,
                symbol: document.getElementById('strategySymbol').value,
                initialCapital: parseFloat(document.getElementById('initialCapital').value),
                blocks: strategyBlocks,
                connections: connections
            };

            try {
                const response = await fetch('/api/strategy-builder/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(strategy)
                });

                if (response.ok) {
                    alert('Strategy saved successfully!');
                } else {
                    alert('Strategy saved (demo mode)');
                }
            } catch (err) {
                alert('Strategy saved (demo mode)');
            }
        }

        async function runBacktest() {
            const name = document.getElementById('strategyName').value;
            if (strategyBlocks.length === 0) {
                alert('Please add blocks to your strategy before backtesting');
                return;
            }
            
            alert(`Starting backtest for: ${name}\n\nTimeframe: ${document.getElementById('strategyTimeframe').value}\nSymbol: ${document.getElementById('strategySymbol').value}`);
        }

        function showBlockMenu(blockId) {
            // Would show context menu
            console.log('Show menu for', blockId);
        }
    </script>
    <script type="module" src="/frontend/js/pages/strategy_builder.js"></script>
</body>
</html>
