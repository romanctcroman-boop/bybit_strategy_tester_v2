<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; connect-src 'self' https://api.bybit.com wss://stream.bybit.com ws://localhost:* http://localhost:*; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <title>Backtest Results | Bybit Strategy Tester</title>
    
    <!-- Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- External CSS (Phase 1) -->
    <link rel="stylesheet" href="/frontend/css/variables.css">
    <link rel="stylesheet" href="/frontend/css/components.css">
    <link rel="stylesheet" href="/frontend/css/common.css">
    <link rel="stylesheet" href="/frontend/css/backtest_results.css">

    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    
    </head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-graph-up-arrow me-2"></i>Bybit Strategy Tester
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" title="Toggle navigation" aria-label="Toggle navigation menu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="strategies.html">
                            <i class="bi bi-diagram-3 me-1"></i>Strategies
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="backtest-results.html">
                            <i class="bi bi-bar-chart-line me-1"></i>Backtest Results
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">
                            <i class="bi bi-pie-chart me-1"></i>Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="market-chart.html">
                            <i class="bi bi-graph-up me-1"></i>Market Data
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="streaming-chat.html">
                            <i class="bi bi-robot me-1"></i>AI Studio
                        </a>
                    </li>
                </ul>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshData()" title="Refresh data" aria-label="Refresh backtest data">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="showNewBacktestModal()">
                        <i class="bi bi-plus-lg me-1"></i>New Backtest
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-1">Backtest Results</h4>
                <p class="text-secondary mb-0">Analyze and compare your strategy backtests</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" id="btnCompare" onclick="toggleCompareMode()" disabled>
                    <i class="bi bi-columns-gap me-1"></i>Compare Selected
                </button>
                <button class="btn btn-outline-secondary" onclick="exportResults()">
                    <i class="bi bi-download me-1"></i>Export
                </button>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Panel - Results List -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="card-title">
                            <i class="bi bi-list-ul me-2"></i>Results
                            <span class="badge bg-secondary ms-2" id="resultsCount">0</span>
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()" title="Toggle filters" aria-label="Toggle filter panel">
                            <i class="bi bi-funnel"></i>
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filter-bar p-3 border-bottom d-none" id="filtersPanel">
                        <select class="form-select form-select-sm filter-select-auto" id="filterStrategy" title="Filter by strategy" aria-label="Filter by strategy">
                            <option value="">All Strategies</option>
                        </select>
                        <select class="form-select form-select-sm filter-select-auto" id="filterSymbol" title="Filter by symbol" aria-label="Filter by symbol">
                            <option value="">All Symbols</option>
                        </select>
                        <select class="form-select form-select-sm filter-select-auto" id="filterPnL" title="Filter by P&L" aria-label="Filter by profit/loss">
                            <option value="">All P&L</option>
                            <option value="profit">Profitable</option>
                            <option value="loss">Loss</option>
                        </select>
                        <input type="text" class="form-control form-control-sm filter-search-input" id="filterSearch" placeholder="Search..." title="Search backtests" aria-label="Search backtests">
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="results-list" id="resultsList">
                            <!-- Results will be loaded here -->
                        </div>
                        
                        <div class="empty-state d-none" id="emptyState">
                            <i class="bi bi-inbox"></i>
                            <h5>No Backtest Results</h5>
                            <p>Run a backtest from the Strategies page to see results here.</p>
                            <a href="strategies.html" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-lg me-1"></i>Create Strategy
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Details -->
            <div class="col-lg-8">
                <!-- Metrics Overview -->
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="bi bi-speedometer me-2"></i>Performance Metrics
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="metrics-grid" id="metricsGrid">
                            <div class="metric-card">
                                <div class="metric-label">Total Return</div>
                                <div class="metric-value neutral" id="metricReturn">--</div>
                                <div class="metric-subtitle">vs Initial Capital</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Win Rate</div>
                                <div class="metric-value neutral" id="metricWinRate">--</div>
                                <div class="metric-subtitle">Winning Trades</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Profit Factor</div>
                                <div class="metric-value neutral" id="metricProfitFactor">--</div>
                                <div class="metric-subtitle">Gross Profit / Loss</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Sharpe Ratio</div>
                                <div class="metric-value neutral" id="metricSharpe">--</div>
                                <div class="metric-subtitle">Risk-Adjusted Return</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Max Drawdown</div>
                                <div class="metric-value neutral" id="metricDrawdown">--</div>
                                <div class="metric-subtitle">Peak to Trough</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total Trades</div>
                                <div class="metric-value neutral" id="metricTrades">--</div>
                                <div class="metric-subtitle">Executed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Tabs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="chartTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tabEquity">
                                    <i class="bi bi-graph-up me-1"></i>Equity Curve
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabDrawdown">
                                    <i class="bi bi-graph-down me-1"></i>Drawdown
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabReturns">
                                    <i class="bi bi-bar-chart me-1"></i>Returns Distribution
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabMonthly">
                                    <i class="bi bi-calendar3 me-1"></i>Monthly P&L
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tabEquity">
                                <div class="chart-container">
                                    <canvas id="equityChart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tabDrawdown">
                                <div class="chart-container">
                                    <canvas id="drawdownChart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tabReturns">
                                <div class="chart-container">
                                    <canvas id="returnsChart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tabMonthly">
                                <div class="chart-container">
                                    <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trades Table -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="card-title">
                            <i class="bi bi-table me-2"></i>Trade History
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTrades()">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="tradesTable"></div>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="bi bi-robot me-2"></i>AI Analysis
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="ai-analysis" id="aiAnalysis">
                            <div class="ai-analysis-header">
                                <i class="bi bi-stars"></i>
                                <strong>Strategy Insights</strong>
                            </div>
                            <p class="mb-0 text-secondary" id="aiAnalysisContent">
                                Select a backtest result to get AI-powered analysis and recommendations.
                            </p>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="requestAIAnalysis()" id="btnAIAnalysis" disabled>
                                <i class="bi bi-magic me-1"></i>Generate Detailed Analysis
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="compareWithAI()" id="btnAICompare" disabled>
                                <i class="bi bi-columns-gap me-1"></i>AI Compare Strategies
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Backtest Modal -->
    <div class="modal fade" id="newBacktestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-play-circle me-2"></i>Run New Backtest
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close" aria-label="Close modal"></button>
                </div>
                <div class="modal-body">
                    <form id="backtestForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="btStrategy">Strategy</label>
                                <select class="form-select bg-dark text-light border-secondary" id="btStrategy" required aria-label="Select strategy">
                                    <option value="">Select strategy...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="btSymbol">Symbol</label>
                                <select class="form-select bg-dark text-light border-secondary" id="btSymbol" required aria-label="Select trading symbol">
                                    <option value="BTCUSDT">BTCUSDT</option>
                                    <option value="ETHUSDT">ETHUSDT</option>
                                    <option value="BNBUSDT">BNBUSDT</option>
                                    <option value="SOLUSDT">SOLUSDT</option>
                                    <option value="XRPUSDT">XRPUSDT</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="btInterval">Interval</label>
                                <select class="form-select bg-dark text-light border-secondary" id="btInterval" required aria-label="Select timeframe interval">
                                    <option value="15m">15 Minutes</option>
                                    <option value="1h" selected>1 Hour</option>
                                    <option value="4h">4 Hours</option>
                                    <option value="1d">Daily</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="btCapital">Initial Capital</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="btCapital" value="10000" min="100" required aria-label="Initial capital amount">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="btStartDate">Start Date</label>
                                <input type="date" class="form-control bg-dark text-light border-secondary" id="btStartDate" required aria-label="Backtest start date">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="btEndDate">End Date</label>
                                <input type="date" class="form-control bg-dark text-light border-secondary" id="btEndDate" required aria-label="Backtest end date">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="runBacktest()">
                        <i class="bi bi-play-fill me-1"></i>Run Backtest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    
    <script>
        // ============================
        // Configuration
        // ============================
        const API_BASE = '/api/v1';
        let currentBacktest = null;
        let allResults = [];
        let selectedForCompare = [];
        let compareMode = false;
        
        // Charts
        let equityChart = null;
        let drawdownChart = null;
        let returnsChart = null;
        let monthlyChart = null;
        
        // Trades Table
        let tradesTable = null;

        // ============================
        // Initialization
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            initTradesTable();
            loadBacktestResults();
            loadStrategies();
            setDefaultDates();
            setupFilters();
        });

        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#8b949e' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#30363d' },
                        ticks: { color: '#8b949e' }
                    },
                    y: {
                        grid: { color: '#30363d' },
                        ticks: { color: '#8b949e' }
                    }
                }
            };

            // Equity Chart
            equityChart = new Chart(document.getElementById('equityChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Equity',
                        data: [],
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Drawdown Chart
            drawdownChart = new Chart(document.getElementById('drawdownChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Drawdown %',
                        data: [],
                        borderColor: '#f85149',
                        backgroundColor: 'rgba(248, 81, 73, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Returns Distribution
            returnsChart = new Chart(document.getElementById('returnsChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Trade Returns',
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: false }
                    }
                }
            });

            // Monthly P&L
            monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly P&L',
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: chartOptions
            });
        }

        function initTradesTable() {
            tradesTable = new Tabulator("#tradesTable", {
                height: 300,
                layout: "fitColumns",
                placeholder: "No trades to display",
                columns: [
                    { title: "#", field: "id", width: 50 },
                    { title: "Entry Time", field: "entry_time", sorter: "datetime" },
                    { title: "Exit Time", field: "exit_time", sorter: "datetime" },
                    { title: "Side", field: "side", width: 80, 
                        formatter: (cell) => {
                            const val = cell.getValue();
                            const color = val === 'long' ? '#3fb950' : '#f85149';
                            return `<span style="color: ${color}">${val?.toUpperCase()}</span>`;
                        }
                    },
                    { title: "Entry Price", field: "entry_price", formatter: "money", formatterParams: { precision: 2 } },
                    { title: "Exit Price", field: "exit_price", formatter: "money", formatterParams: { precision: 2 } },
                    { title: "Size", field: "size", formatter: "money", formatterParams: { precision: 4 } },
                    { title: "P&L", field: "pnl", 
                        formatter: (cell) => {
                            const val = cell.getValue();
                            const color = val >= 0 ? '#3fb950' : '#f85149';
                            return `<span style="color: ${color}">$${val?.toFixed(2)}</span>`;
                        }
                    },
                    { title: "Return %", field: "return_pct",
                        formatter: (cell) => {
                            const val = cell.getValue();
                            const color = val >= 0 ? '#3fb950' : '#f85149';
                            return `<span style="color: ${color}">${val?.toFixed(2)}%</span>`;
                        }
                    }
                ]
            });
        }

        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            
            document.getElementById('btEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('btStartDate').value = startDate.toISOString().split('T')[0];
        }

        function setupFilters() {
            ['filterStrategy', 'filterSymbol', 'filterPnL', 'filterSearch'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            document.getElementById('filterSearch').addEventListener('input', applyFilters);
        }

        // ============================
        // Data Loading
        // ============================
        async function loadBacktestResults() {
            try {
                const response = await fetch(`${API_BASE}/backtests?limit=100`);
                const data = await response.json();
                
                allResults = data.items || [];
                document.getElementById('resultsCount').textContent = allResults.length;
                
                if (allResults.length === 0) {
                    document.getElementById('emptyState').classList.remove('d-none');
                    document.getElementById('resultsList').innerHTML = '';
                } else {
                    document.getElementById('emptyState').classList.add('d-none');
                    renderResultsList(allResults);
                    
                    // Auto-select first result
                    if (allResults.length > 0) {
                        selectBacktest(allResults[0].backtest_id);
                    }
                }
                
                populateFilters();
            } catch (error) {
                console.error('Failed to load backtest results:', error);
                showToast('Failed to load backtest results', 'error');
            }
        }

        async function loadStrategies() {
            try {
                const response = await fetch(`${API_BASE}/strategies`);
                const strategies = await response.json();
                
                const select = document.getElementById('btStrategy');
                strategies.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load strategies:', error);
            }
        }

        function populateFilters() {
            const strategies = [...new Set(allResults.map(r => r.strategy_type))];
            const symbols = [...new Set(allResults.map(r => r.symbol))];
            
            const strategySelect = document.getElementById('filterStrategy');
            strategies.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                strategySelect.appendChild(option);
            });
            
            const symbolSelect = document.getElementById('filterSymbol');
            symbols.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                symbolSelect.appendChild(option);
            });
        }

        // ============================
        // Rendering
        // ============================
        function renderResultsList(results) {
            const container = document.getElementById('resultsList');
            container.innerHTML = results.map(r => {
                const isProfitable = (r.metrics?.total_return || 0) >= 0;
                const isSelected = currentBacktest?.backtest_id === r.backtest_id;
                const isCompareSelected = selectedForCompare.includes(r.backtest_id);
                
                return `
                    <div class="result-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectBacktest('${r.backtest_id}')"
                         data-id="${r.backtest_id}">
                        ${compareMode ? `
                            <input type="checkbox" class="form-check-input me-2" 
                                   ${isCompareSelected ? 'checked' : ''}
                                   onclick="toggleCompareSelect(event, '${r.backtest_id}')">
                        ` : ''}
                        <div class="result-icon ${isProfitable ? 'profit' : 'loss'}">
                            <i class="bi bi-${isProfitable ? 'graph-up-arrow' : 'graph-down-arrow'}"></i>
                        </div>
                        <div class="result-info">
                            <div class="result-name">${r.strategy_type || 'Unknown'}</div>
                            <div class="result-meta">
                                ${r.symbol} â€¢ ${r.interval} â€¢ ${formatDate(r.config?.start_date)}
                            </div>
                        </div>
                        <div class="result-pnl">
                            <div class="result-pnl-value ${isProfitable ? 'text-success' : 'text-danger'}">
                                ${isProfitable ? '+' : ''}${(r.metrics?.total_return || 0).toFixed(2)}%
                            </div>
                            <div class="result-meta">${r.metrics?.total_trades || 0} trades</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectBacktest(backtestId) {
            try {
                // Mark as selected in list
                document.querySelectorAll('.result-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.id === backtestId);
                });
                
                // Fetch full details
                const response = await fetch(`${API_BASE}/backtests/${backtestId}`);
                currentBacktest = await response.json();
                
                // Update UI
                updateMetrics(currentBacktest.metrics);
                updateCharts(currentBacktest);
                updateTradesTable(currentBacktest.trades);
                updateAIAnalysis(currentBacktest);
                
                // Enable AI buttons
                document.getElementById('btnAIAnalysis').disabled = false;
                document.getElementById('btnAICompare').disabled = selectedForCompare.length < 2;
                
            } catch (error) {
                console.error('Failed to load backtest details:', error);
                showToast('Failed to load backtest details', 'error');
            }
        }

        function updateMetrics(metrics) {
            if (!metrics) return;
            
            const setMetric = (id, value, format = 'number', threshold = 0) => {
                const el = document.getElementById(id);
                let formatted = '--';
                let className = 'neutral';
                
                if (value !== null && value !== undefined) {
                    if (format === 'percent') {
                        formatted = `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
                    } else if (format === 'ratio') {
                        formatted = value.toFixed(2);
                    } else {
                        formatted = value.toLocaleString();
                    }
                    
                    if (typeof threshold === 'number') {
                        className = value >= threshold ? 'positive' : 'negative';
                    }
                }
                
                el.textContent = formatted;
                el.className = `metric-value ${className}`;
            };
            
            setMetric('metricReturn', metrics.total_return, 'percent', 0);
            setMetric('metricWinRate', metrics.win_rate, 'percent', 50);
            setMetric('metricProfitFactor', metrics.profit_factor, 'ratio', 1);
            setMetric('metricSharpe', metrics.sharpe_ratio, 'ratio', 1);
            setMetric('metricDrawdown', metrics.max_drawdown, 'percent', -20);
            setMetric('metricTrades', metrics.total_trades, 'number');
        }

        function updateCharts(backtest) {
            if (!backtest) return;
            
            // Equity Chart
            if (backtest.equity_curve) {
                const labels = backtest.equity_curve.timestamps?.map(t => formatDate(t)) || [];
                const values = backtest.equity_curve.equity || [];
                
                equityChart.data.labels = labels;
                equityChart.data.datasets[0].data = values;
                equityChart.update();
                
                // Drawdown
                const drawdown = backtest.equity_curve.drawdown || [];
                drawdownChart.data.labels = labels;
                drawdownChart.data.datasets[0].data = drawdown.map(d => d * 100);
                drawdownChart.update();
            }
            
            // Returns Distribution
            if (backtest.trades) {
                const returns = backtest.trades.map(t => t.return_pct || 0);
                const colors = returns.map(r => r >= 0 ? '#3fb950' : '#f85149');
                
                returnsChart.data.labels = returns.map((_, i) => `Trade ${i + 1}`);
                returnsChart.data.datasets[0].data = returns;
                returnsChart.data.datasets[0].backgroundColor = colors;
                returnsChart.update();
            }
            
            // Monthly P&L (simplified)
            if (backtest.trades) {
                const monthlyPnL = {};
                backtest.trades.forEach(t => {
                    const month = t.exit_time?.substring(0, 7) || 'Unknown';
                    monthlyPnL[month] = (monthlyPnL[month] || 0) + (t.pnl || 0);
                });
                
                const months = Object.keys(monthlyPnL).sort();
                const values = months.map(m => monthlyPnL[m]);
                const colors = values.map(v => v >= 0 ? '#3fb950' : '#f85149');
                
                monthlyChart.data.labels = months;
                monthlyChart.data.datasets[0].data = values;
                monthlyChart.data.datasets[0].backgroundColor = colors;
                monthlyChart.update();
            }
        }

        function updateTradesTable(trades) {
            if (!trades) {
                tradesTable.setData([]);
                return;
            }
            
            const formattedTrades = trades.map((t, i) => ({
                id: i + 1,
                entry_time: formatDateTime(t.entry_time),
                exit_time: formatDateTime(t.exit_time),
                side: t.side || 'long',
                entry_price: t.entry_price,
                exit_price: t.exit_price,
                size: t.size,
                pnl: t.pnl,
                return_pct: t.return_pct
            }));
            
            tradesTable.setData(formattedTrades);
        }

        function updateAIAnalysis(backtest) {
            const content = document.getElementById('aiAnalysisContent');
            
            if (!backtest || !backtest.metrics) {
                content.textContent = 'Select a backtest result to get AI-powered analysis and recommendations.';
                return;
            }
            
            const m = backtest.metrics;
            const insights = [];
            
            // Generate quick insights
            if (m.total_return > 20) {
                insights.push('âœ… Excellent returns! Strategy shows strong profitability.');
            } else if (m.total_return > 0) {
                insights.push('ðŸ”¶ Positive returns, but there may be room for optimization.');
            } else {
                insights.push('âš ï¸ Negative returns. Consider adjusting strategy parameters.');
            }
            
            if (m.win_rate >= 60) {
                insights.push('âœ… High win rate indicates consistent signal quality.');
            } else if (m.win_rate < 40) {
                insights.push('âš ï¸ Low win rate. Review entry/exit conditions.');
            }
            
            if (m.profit_factor >= 2) {
                insights.push('âœ… Strong profit factor (> 2x) shows good risk/reward.');
            } else if (m.profit_factor < 1) {
                insights.push('ðŸ”´ Profit factor below 1 means losses exceed gains.');
            }
            
            if (m.max_drawdown < -30) {
                insights.push('âš ï¸ High drawdown risk. Consider tighter stop losses.');
            }
            
            if (m.sharpe_ratio >= 2) {
                insights.push('âœ… Excellent risk-adjusted returns (Sharpe > 2).');
            } else if (m.sharpe_ratio < 1) {
                insights.push('ðŸ”¶ Consider reducing volatility for better risk-adjusted returns.');
            }
            
            content.innerHTML = insights.join('<br>');
        }

        // ============================
        // Actions
        // ============================
        function toggleFilters() {
            document.getElementById('filtersPanel').classList.toggle('d-none');
        }

        function applyFilters() {
            const strategy = document.getElementById('filterStrategy').value;
            const symbol = document.getElementById('filterSymbol').value;
            const pnl = document.getElementById('filterPnL').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();
            
            let filtered = allResults.filter(r => {
                if (strategy && r.strategy_type !== strategy) return false;
                if (symbol && r.symbol !== symbol) return false;
                if (pnl === 'profit' && (r.metrics?.total_return || 0) < 0) return false;
                if (pnl === 'loss' && (r.metrics?.total_return || 0) >= 0) return false;
                if (search && !JSON.stringify(r).toLowerCase().includes(search)) return false;
                return true;
            });
            
            renderResultsList(filtered);
        }

        function toggleCompareMode() {
            compareMode = !compareMode;
            selectedForCompare = [];
            
            const btn = document.getElementById('btnCompare');
            btn.classList.toggle('btn-primary', compareMode);
            btn.classList.toggle('btn-outline-secondary', !compareMode);
            btn.innerHTML = compareMode ? 
                '<i class="bi bi-x-lg me-1"></i>Cancel Compare' :
                '<i class="bi bi-columns-gap me-1"></i>Compare Selected';
            
            renderResultsList(allResults);
        }

        function toggleCompareSelect(event, backtestId) {
            event.stopPropagation();
            
            if (selectedForCompare.includes(backtestId)) {
                selectedForCompare = selectedForCompare.filter(id => id !== backtestId);
            } else if (selectedForCompare.length < 3) {
                selectedForCompare.push(backtestId);
            }
            
            document.getElementById('btnCompare').disabled = selectedForCompare.length < 2;
            document.getElementById('btnAICompare').disabled = selectedForCompare.length < 2;
        }

        function showNewBacktestModal() {
            new bootstrap.Modal(document.getElementById('newBacktestModal')).show();
        }

        async function runBacktest() {
            const strategyId = document.getElementById('btStrategy').value;
            const symbol = document.getElementById('btSymbol').value;
            const interval = document.getElementById('btInterval').value;
            const capital = document.getElementById('btCapital').value;
            const startDate = document.getElementById('btStartDate').value;
            const endDate = document.getElementById('btEndDate').value;
            
            if (!strategyId) {
                showToast('Please select a strategy', 'error');
                return;
            }
            
            try {
                showToast('Running backtest...', 'info');
                
                const response = await fetch(`${API_BASE}/backtests/run-from-strategy/${strategyId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        interval,
                        initial_capital: parseFloat(capital),
                        start_date: new Date(startDate).toISOString(),
                        end_date: new Date(endDate).toISOString(),
                        save_result: true
                    })
                });
                
                if (!response.ok) throw new Error('Backtest failed');
                
                const result = await response.json();
                bootstrap.Modal.getInstance(document.getElementById('newBacktestModal')).hide();
                
                showToast('Backtest completed successfully!', 'success');
                loadBacktestResults();
                
            } catch (error) {
                console.error('Backtest error:', error);
                showToast('Backtest failed: ' + error.message, 'error');
            }
        }

        async function requestAIAnalysis() {
            if (!currentBacktest) return;
            
            try {
                showToast('Generating AI analysis...', 'info');
                
                const response = await fetch(`${API_BASE}/agents/backtest/ai-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([currentBacktest])
                });
                
                const analysis = await response.json();
                
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <strong>AI Recommendation:</strong><br>
                    ${analysis.recommendation || analysis.analysis || 'No detailed analysis available.'}
                `;
                
                showToast('AI analysis complete', 'success');
                
            } catch (error) {
                console.error('AI analysis failed:', error);
                showToast('AI analysis failed', 'error');
            }
        }

        async function compareWithAI() {
            if (selectedForCompare.length < 2) {
                showToast('Select at least 2 backtests to compare', 'warning');
                return;
            }
            
            try {
                showToast('Comparing strategies with AI...', 'info');
                
                const results = await Promise.all(
                    selectedForCompare.map(id => 
                        fetch(`${API_BASE}/backtests/${id}`).then(r => r.json())
                    )
                );
                
                const response = await fetch(`${API_BASE}/agents/backtest/ai-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(results)
                });
                
                const analysis = await response.json();
                
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <strong>Comparison Result:</strong><br>
                    ${analysis.recommendation || analysis.comparison || 'Comparison complete.'}
                `;
                
                showToast('AI comparison complete', 'success');
                
            } catch (error) {
                console.error('AI comparison failed:', error);
                showToast('AI comparison failed', 'error');
            }
        }

        function exportResults() {
            if (allResults.length === 0) {
                showToast('No results to export', 'warning');
                return;
            }
            
            const csv = [
                ['ID', 'Strategy', 'Symbol', 'Interval', 'Return %', 'Win Rate', 'Sharpe', 'Trades', 'Date'].join(','),
                ...allResults.map(r => [
                    r.backtest_id,
                    r.strategy_type,
                    r.symbol,
                    r.interval,
                    r.metrics?.total_return?.toFixed(2) || 0,
                    r.metrics?.win_rate?.toFixed(2) || 0,
                    r.metrics?.sharpe_ratio?.toFixed(2) || 0,
                    r.metrics?.total_trades || 0,
                    r.config?.start_date || ''
                ].join(','))
            ].join('\n');
            
            downloadFile(csv, 'backtest_results.csv', 'text/csv');
        }

        function exportTrades() {
            if (!currentBacktest?.trades) {
                showToast('No trades to export', 'warning');
                return;
            }
            
            const csv = [
                ['#', 'Entry Time', 'Exit Time', 'Side', 'Entry Price', 'Exit Price', 'Size', 'P&L', 'Return %'].join(','),
                ...currentBacktest.trades.map((t, i) => [
                    i + 1,
                    t.entry_time,
                    t.exit_time,
                    t.side,
                    t.entry_price,
                    t.exit_price,
                    t.size,
                    t.pnl?.toFixed(2),
                    t.return_pct?.toFixed(2)
                ].join(','))
            ].join('\n');
            
            downloadFile(csv, `trades_${currentBacktest.backtest_id}.csv`, 'text/csv');
        }

        function refreshData() {
            loadBacktestResults();
            showToast('Data refreshed', 'success');
        }

        // ============================
        // Utilities
        // ============================
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 250px;';
            toast.innerHTML = `
                <i class="bi bi-${type === 'error' ? 'x-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
    <script type="module" src="/frontend/js/pages/backtest_results.js"></script>
</body>
</html>
