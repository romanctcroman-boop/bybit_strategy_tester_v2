<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Diagnostics - market-chart.html</title>
    <style>
        body { font-family: monospace; background: #1a1a2e; color: #eee; padding: 20px; }
        h1 { color: #00c853; }
        .section { background: #16213e; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .issue { color: #ff1744; }
        .fix { color: #00c853; }
        pre { background: #0f0f23; padding: 10px; border-radius: 4px; overflow-x: auto; }
        code { color: #58a6ff; }
    </style>
</head>
<body>
    <h1>üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –∑–∞–≤–∏—Å–∞–Ω–∏—è market-chart.html</h1>
    
    <div class="section">
        <h2>üìå –î–∏–∞–≥–Ω–æ–∑: –í–µ—Ä–æ—è—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–≤–∏—Å–∞–Ω–∏—è –Ω–∞ 150+ —Å–µ–∫—É–Ω–¥</h2>
        <ol>
            <li class="issue"><strong>Memory Leak –≤ –º–∞—Å—Å–∏–≤–∞—Ö currentCandles/currentVolumes</strong>
                <p>–ü—Ä–∏ –¥–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç–µ –º–∞—Å—Å–∏–≤—ã –º–æ–≥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –≤—ã–∑—ã–≤–∞—è GC –ø–∞—É–∑—ã</p>
            </li>
            <li class="issue"><strong>WebSocket reconnect loop</strong>
                <p>–ï—Å–ª–∏ WS –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, attemptReconnect –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</p>
            </li>
            <li class="issue"><strong>candleSeries.update() –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö</strong>
                <p>TradingView –º–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–∏ >2000 —Å–≤–µ—á–µ–π</p>
            </li>
            <li class="issue"><strong>Infinity scroll loading (loadMoreHistory)</strong>
                <p>–ú–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–≥—Ä–æ–º–Ω—ã–µ –æ–±—ä—ë–º—ã –¥–∞–Ω–Ω—ã—Ö</p>
            </li>
        </ol>
    </div>
    
    <div class="section">
        <h2>‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é</h2>
        
        <h3>1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ handleBybitKline</h3>
        <pre><code>function handleBybitKline(data) {
    const start = performance.now();
    
    // ... existing code ...
    
    const elapsed = performance.now() - start;
    if (elapsed > 16) {  // More than 1 frame
        console.warn('[Perf] handleBybitKline took', elapsed.toFixed(1), 'ms');
    }
}</code></pre>

        <h3>2. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä currentCandles (—É–∂–µ –µ—Å—Ç—å MAX_CANDLES = 2000)</h3>
        <p class="fix">‚úì –≠—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ handleBybitKline</p>

        <h3>3. –î–æ–±–∞–≤–∏—Ç—å –¥–µ–±–∞—É–Ω—Å –Ω–∞ candleSeries.update()</h3>
        <pre><code>let pendingCandleUpdate = null;
let candleUpdateScheduled = false;

function handleBybitKline(data) {
    // ... parse kline ...
    
    // Batch updates using requestAnimationFrame
    pendingCandleUpdate = candle;
    if (!candleUpdateScheduled) {
        candleUpdateScheduled = true;
        requestAnimationFrame(() => {
            if (pendingCandleUpdate) {
                candleSeries.update(pendingCandleUpdate);
                // ... update arrays ...
            }
            candleUpdateScheduled = false;
        });
    }
}</code></pre>

        <h3>4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å infinite scroll</h3>
        <pre><code>// –í loadMoreHistory –¥–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –≥–æ–Ω–∫–∏
if (isLoadingHistory) {
    console.log('[History] Already loading, skipping');
    return;
}

// –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000);
try {
    const response = await fetch(url, { signal: controller.signal });
    // ...
} finally {
    clearTimeout(timeoutId);
    isLoadingHistory = false;
}</code></pre>

        <h3>5. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏</h3>
        <pre><code>// –í initStallDiagnostics –¥–æ–±–∞–≤–∏—Ç—å:
setInterval(() => {
    if (performance.memory) {
        const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
        const total = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
        console.log('[Memory]', used, 'MB /', total, 'MB');
        if (used > 500) {
            console.warn('[Memory] High memory usage!');
        }
    }
}, 10000);</code></pre>

        <h3>6. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ WebSocket</h3>
        <pre><code>let wsMessageCount = 0;
let wsLastSecondCount = 0;

// –í onmessage:
wsMessageCount++;

// –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É:
setInterval(() => {
    if (wsMessageCount !== wsLastSecondCount) {
        console.log('[WS] Messages/sec:', wsMessageCount - wsLastSecondCount);
        wsLastSecondCount = wsMessageCount;
    }
}, 1000);</code></pre>
    </div>
    
    <div class="section">
        <h2>üõ†Ô∏è –ö–∞–∫ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å –≤ Chrome DevTools</h2>
        <ol>
            <li>–û—Ç–∫—Ä—ã—Ç—å DevTools (F12)</li>
            <li>–í–∫–ª–∞–¥–∫–∞ <strong>Performance</strong></li>
            <li>–ù–∞–∂–∞—Ç—å <strong>Record</strong> (‚óè)</li>
            <li>–î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–∏—Å–∞–Ω–∏—è</li>
            <li>–ù–∞–∂–∞—Ç—å <strong>Stop</strong></li>
            <li>–ò—Å–∫–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –∂—ë–ª—Ç—ã–µ –±–ª–æ–∫–∏ (JavaScript) –∏–ª–∏ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ (Layout/Paint)</li>
        </ol>
        <p>–¢–∞–∫–∂–µ –ø–æ–ª–µ–∑–Ω–æ:</p>
        <ul>
            <li><strong>Memory</strong> –≤–∫–ª–∞–¥–∫–∞ ‚Üí Take heap snapshot ‚Üí –ò—Å–∫–∞—Ç—å —É—Ç–µ—á–∫–∏</li>
            <li><strong>Console</strong> ‚Üí –§–∏–ª—å—Ç—Ä –ø–æ "[Perf]" –∏–ª–∏ "[Diag]"</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>üéØ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –û—Ç–∫–ª—é—á–∏—Ç—å trades –∏ orderbook</h2>
        <p>–î–ª—è —Ç–µ—Å—Ç–∞ –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ connectWebSocket:</p>
        <pre><code>// –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
// bybitWs.send(JSON.stringify({ op: 'subscribe', args: [`orderbook.50.${currentSymbol}`] }));
// bybitWs.send(JSON.stringify({ op: 'subscribe', args: [`publicTrade.${currentSymbol}`] }));</code></pre>
        <p>–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è –ø—Ä–æ–ø–∞–¥—É—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ orderbook/trades</p>
    </div>
</body>
</html>
</code></pre>
