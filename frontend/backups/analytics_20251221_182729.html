<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Bybit Strategy Tester v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --border-color: #30363d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.connected {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .status-badge.disconnected {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .text-secondary-sm {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .chart-card-mb {
            margin-bottom: 24px;
        }

        .legend-small {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-low {
            color: var(--accent-green);
        }

        .legend-medium {
            color: var(--accent-yellow);
        }

        .legend-high {
            color: var(--accent-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Risk Level Indicator */
        .risk-level-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .risk-level-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .risk-gauge {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .risk-gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                var(--accent-green) 0deg 72deg,
                var(--accent-yellow) 72deg 144deg,
                var(--accent-red) 144deg 360deg
            );
            position: relative;
        }

        .risk-gauge-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .risk-score {
            font-size: 28px;
            font-weight: 700;
        }

        .risk-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .risk-details h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .risk-details p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .risk-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #4393e6;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #2d333b;
        }

        /* Grid Layout */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .metric-card h3 {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .metric-value.positive {
            color: var(--accent-green);
        }

        .metric-value.negative {
            color: var(--accent-red);
        }

        .metric-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--accent-green);
        }

        .metric-change.negative {
            color: var(--accent-red);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .chart-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Risk Metrics Table */
        .risk-metrics-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .metrics-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 16px;
            font-weight: 600;
        }

        .table-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: var(--bg-tertiary);
        }

        .table-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .table-value {
            font-weight: 500;
            font-size: 14px;
        }

        /* Alerts Section */
        .alerts-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .alerts-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .alert-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .alert-badge.critical {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .alert-icon.warning {
            background: rgba(210, 153, 34, 0.15);
            color: var(--accent-yellow);
        }

        .alert-icon.critical {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .alert-icon.info {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent-blue);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .alert-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .alert-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Position Heatmap */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            padding: 16px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
        }

        .heatmap-cell.high-risk {
            background: rgba(248, 81, 73, 0.3);
            border: 1px solid var(--accent-red);
        }

        .heatmap-cell.medium-risk {
            background: rgba(210, 153, 34, 0.3);
            border: 1px solid var(--accent-yellow);
        }

        .heatmap-cell.low-risk {
            background: rgba(63, 185, 80, 0.3);
            border: 1px solid var(--accent-green);
        }

        .heatmap-symbol {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .heatmap-value {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .risk-metrics-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .risk-level-container {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            .risk-actions {
                flex-direction: column;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                üìä Analytics Dashboard
                <span class="status-badge connected" id="connectionStatus">
                    <span class="status-dot"></span>
                    Connected
                </span>
            </h1>
            <div>
                <span id="lastUpdate" class="text-secondary-sm">
                    Last update: --
                </span>
            </div>
        </header>

        <!-- Risk Level Overview -->
        <div class="risk-level-container">
            <div class="risk-level-info">
                <div class="risk-gauge">
                    <div class="risk-gauge-circle">
                        <div class="risk-gauge-inner">
                            <span class="risk-score" id="riskScore">--</span>
                            <span class="risk-label">Risk Score</span>
                        </div>
                    </div>
                </div>
                <div class="risk-details">
                    <h2 id="riskLevel">Loading...</h2>
                    <p id="riskDescription">Analyzing portfolio risk metrics...</p>
                </div>
            </div>
            <div class="risk-actions">
                <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="exportReport()">üì• Export Report</button>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Value at Risk (95%)</h3>
                <div class="metric-value negative" id="var95">$--</div>
                <div class="metric-change negative" id="var95Change">
                    <span>--</span>
                </div>
            </div>
            <div class="metric-card">
                <h3>Value at Risk (99%)</h3>
                <div class="metric-value negative" id="var99">$--</div>
                <div class="metric-change negative" id="var99Change">
                    <span>--</span>
                </div>
            </div>
            <div class="metric-card">
                <h3>Sharpe Ratio</h3>
                <div class="metric-value" id="sharpeRatio">--</div>
                <div class="metric-change" id="sharpeChange">
                    <span>Risk-adjusted return</span>
                </div>
            </div>
            <div class="metric-card">
                <h3>Sortino Ratio</h3>
                <div class="metric-value" id="sortinoRatio">--</div>
                <div class="metric-change" id="sortinoChange">
                    <span>Downside deviation</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>üìà Equity Curve & Drawdown</h3>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="7d">7D</button>
                        <button class="chart-btn" data-period="30d">30D</button>
                        <button class="chart-btn" data-period="90d">90D</button>
                        <button class="chart-btn" data-period="all">All</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>üéØ Risk Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Risk Metrics Tables -->
        <div class="risk-metrics-section">
            <div class="metrics-table">
                <div class="table-header">üìä Portfolio Metrics</div>
                <div class="table-row">
                    <span class="table-label">üí∞ Total Equity</span>
                    <span class="table-value" id="totalEquity">$--</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üìà Total Exposure</span>
                    <span class="table-value" id="totalExposure">$--</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üíµ Unrealized P&L</span>
                    <span class="table-value" id="unrealizedPnl">$--</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üìâ Max Drawdown</span>
                    <span class="table-value" id="maxDrawdown">--%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üéØ Current Drawdown</span>
                    <span class="table-value" id="currentDrawdown">--%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">‚úÖ Win Rate</span>
                    <span class="table-value" id="winRate">--%</span>
                </div>
            </div>
            <div class="metrics-table">
                <div class="table-header">‚öôÔ∏è Risk Thresholds</div>
                <div class="table-row">
                    <span class="table-label">üî¥ Max Drawdown</span>
                    <span class="table-value" id="thresholdMaxDrawdown">20%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üìä Max Exposure</span>
                    <span class="table-value" id="thresholdMaxExposure">200%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üìê Max Position Size</span>
                    <span class="table-value" id="thresholdMaxPosition">25%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üìâ Max Daily Loss</span>
                    <span class="table-value" id="thresholdDailyLoss">5%</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üîó Max Correlation</span>
                    <span class="table-value" id="thresholdCorrelation">0.7</span>
                </div>
                <div class="table-row">
                    <span class="table-label">üíß Min Liquidity</span>
                    <span class="table-value" id="thresholdLiquidity">0.5</span>
                </div>
            </div>
        </div>

        <!-- Position Risk Heatmap -->
        <div class="chart-card chart-card-mb">
            <div class="chart-header">
                <h3>üî• Position Risk Heatmap</h3>
                <div class="chart-controls">
                    <span class="legend-small">
                        <span class="legend-low">‚óè Low</span> | 
                        <span class="legend-medium">‚óè Medium</span> | 
                        <span class="legend-high">‚óè High</span>
                    </span>
                </div>
            </div>
            <div class="heatmap-container" id="positionHeatmap">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="alerts-section">
            <div class="alerts-header">
                <h3>üö® Active Alerts</h3>
                <span class="alert-badge critical" id="alertCount">0 Critical</span>
            </div>
            <div id="alertsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const RISK_API = `${API_BASE}/api/v1/risk`;
        
        let equityChart = null;
        let riskDistributionChart = null;
        let refreshInterval = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            refreshData();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshData, 30000);
            
            // Period buttons
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadEquityData(e.target.dataset.period);
                });
            });
        });

        function initCharts() {
            // Equity Curve Chart
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            equityChart = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Equity',
                            data: [],
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Drawdown %',
                            data: [],
                            borderColor: '#f85149',
                            backgroundColor: 'rgba(248, 81, 73, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#f0f6fc' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#30363d' },
                            ticks: { color: '#8b949e' }
                        },
                        y: {
                            grid: { color: '#30363d' },
                            ticks: { color: '#8b949e' },
                            position: 'left'
                        },
                        y1: {
                            grid: { display: false },
                            ticks: { color: '#f85149' },
                            position: 'right'
                        }
                    }
                }
            });

            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskDistributionChart').getContext('2d');
            riskDistributionChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(63, 185, 80, 0.8)',
                            'rgba(210, 153, 34, 0.8)',
                            'rgba(248, 81, 73, 0.8)'
                        ],
                        borderColor: '#161b22',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f0f6fc' }
                        }
                    }
                }
            });
        }

        async function refreshData() {
            try {
                updateConnectionStatus(true);
                
                // Fetch risk summary
                const summaryResponse = await fetch(`${RISK_API}/summary`);
                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    updateRiskSummary(summary);
                }

                // Fetch portfolio metrics
                const portfolioResponse = await fetch(`${RISK_API}/portfolio`);
                if (portfolioResponse.ok) {
                    const portfolio = await portfolioResponse.json();
                    updatePortfolioMetrics(portfolio);
                }

                // Fetch positions
                const positionsResponse = await fetch(`${RISK_API}/positions`);
                if (positionsResponse.ok) {
                    const positions = await positionsResponse.json();
                    updatePositionHeatmap(positions);
                }

                // Fetch alerts
                const alertsResponse = await fetch(`${RISK_API}/alerts`);
                if (alertsResponse.ok) {
                    const alerts = await alertsResponse.json();
                    updateAlerts(alerts);
                }

                // Update timestamp
                document.getElementById('lastUpdate').textContent = 
                    `Last update: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Failed to refresh data:', error);
                updateConnectionStatus(false);
                showMockData();
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'status-badge connected';
                status.innerHTML = '<span class="status-dot"></span> Connected';
            } else {
                status.className = 'status-badge disconnected';
                status.innerHTML = '<span class="status-dot"></span> Demo Mode';
            }
        }

        function updateRiskSummary(summary) {
            const scoreEl = document.getElementById('riskScore');
            const levelEl = document.getElementById('riskLevel');
            const descEl = document.getElementById('riskDescription');

            const score = summary.risk_score || 0;
            scoreEl.textContent = score.toFixed(1);
            
            // Color based on score
            if (score < 30) {
                scoreEl.style.color = 'var(--accent-green)';
                levelEl.textContent = 'Low Risk';
                descEl.textContent = 'Portfolio is within safe parameters';
            } else if (score < 70) {
                scoreEl.style.color = 'var(--accent-yellow)';
                levelEl.textContent = 'Medium Risk';
                descEl.textContent = 'Some positions require attention';
            } else {
                scoreEl.style.color = 'var(--accent-red)';
                levelEl.textContent = 'High Risk';
                descEl.textContent = 'Immediate action recommended';
            }
        }

        function updatePortfolioMetrics(portfolio) {
            // VaR metrics
            document.getElementById('var95').textContent = formatCurrency(portfolio.var_95 || 0);
            document.getElementById('var99').textContent = formatCurrency(portfolio.var_99 || 0);
            
            // Ratios
            const sharpe = portfolio.sharpe_ratio || 0;
            const sortino = portfolio.sortino_ratio || 0;
            
            document.getElementById('sharpeRatio').textContent = sharpe.toFixed(2);
            document.getElementById('sharpeRatio').className = 
                `metric-value ${sharpe > 1 ? 'positive' : sharpe < 0 ? 'negative' : ''}`;
            
            document.getElementById('sortinoRatio').textContent = sortino.toFixed(2);
            document.getElementById('sortinoRatio').className = 
                `metric-value ${sortino > 1 ? 'positive' : sortino < 0 ? 'negative' : ''}`;

            // Table values
            document.getElementById('totalEquity').textContent = formatCurrency(portfolio.total_equity || 0);
            document.getElementById('totalExposure').textContent = formatCurrency(portfolio.total_exposure || 0);
            
            const pnl = portfolio.unrealized_pnl || 0;
            document.getElementById('unrealizedPnl').textContent = formatCurrency(pnl);
            document.getElementById('unrealizedPnl').style.color = 
                pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            document.getElementById('maxDrawdown').textContent = 
                formatPercent(portfolio.max_drawdown || 0);
            document.getElementById('currentDrawdown').textContent = 
                formatPercent(portfolio.current_drawdown || 0);
            document.getElementById('winRate').textContent = 
                formatPercent(portfolio.win_rate || 0);
        }

        function updatePositionHeatmap(positions) {
            const container = document.getElementById('positionHeatmap');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">No open positions</p>';
                return;
            }

            container.innerHTML = positions.map(pos => {
                const riskClass = pos.risk_score > 70 ? 'high-risk' : 
                                  pos.risk_score > 30 ? 'medium-risk' : 'low-risk';
                return `
                    <div class="heatmap-cell ${riskClass}" onclick="showPositionDetails('${pos.symbol}')">
                        <span class="heatmap-symbol">${pos.symbol}</span>
                        <span class="heatmap-value">${formatPercent(pos.unrealized_pnl_pct)}</span>
                    </div>
                `;
            }).join('');

            // Update distribution chart
            const low = positions.filter(p => p.risk_score < 30).length;
            const medium = positions.filter(p => p.risk_score >= 30 && p.risk_score < 70).length;
            const high = positions.filter(p => p.risk_score >= 70).length;
            
            riskDistributionChart.data.datasets[0].data = [low, medium, high];
            riskDistributionChart.update();
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('alertsList');
            const badge = document.getElementById('alertCount');
            
            const criticalCount = alerts.filter(a => a.level === 'critical').length;
            badge.textContent = `${criticalCount} Critical`;
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        <span style="font-size: 32px;">‚úÖ</span>
                        <p style="margin-top: 12px;">No active alerts</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = alerts.slice(0, 5).map(alert => {
                const iconClass = alert.level === 'critical' ? 'critical' : 
                                  alert.level === 'warning' ? 'warning' : 'info';
                const icon = alert.level === 'critical' ? 'üî¥' : 
                             alert.level === 'warning' ? 'üü°' : '‚ÑπÔ∏è';
                return `
                    <div class="alert-item">
                        <div class="alert-icon ${iconClass}">${icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.alert_type}</div>
                            <div class="alert-description">${alert.message}</div>
                        </div>
                        <div class="alert-time">${formatTime(alert.timestamp)}</div>
                    </div>
                `;
            }).join('');
        }

        function showMockData() {
            // Show demo data when API is unavailable
            updateRiskSummary({ risk_score: 42, overall_risk_level: 'MEDIUM' });
            
            updatePortfolioMetrics({
                var_95: -1250.50,
                var_99: -2100.75,
                sharpe_ratio: 1.85,
                sortino_ratio: 2.12,
                total_equity: 50000,
                total_exposure: 35000,
                unrealized_pnl: 1250.00,
                max_drawdown: 12.5,
                current_drawdown: 3.2,
                win_rate: 58.5
            });

            updatePositionHeatmap([
                { symbol: 'BTCUSDT', unrealized_pnl_pct: 5.2, risk_score: 25 },
                { symbol: 'ETHUSDT', unrealized_pnl_pct: -2.1, risk_score: 45 },
                { symbol: 'SOLUSDT', unrealized_pnl_pct: 12.5, risk_score: 65 },
                { symbol: 'BNBUSDT', unrealized_pnl_pct: -8.3, risk_score: 82 },
                { symbol: 'XRPUSDT', unrealized_pnl_pct: 3.1, risk_score: 30 },
                { symbol: 'ADAUSDT', unrealized_pnl_pct: -1.5, risk_score: 40 }
            ]);

            updateAlerts([
                {
                    level: 'warning',
                    alert_type: 'High Exposure',
                    message: 'SOLUSDT position exceeds recommended size (15% of portfolio)',
                    timestamp: new Date().toISOString()
                },
                {
                    level: 'critical',
                    alert_type: 'Stop Loss Triggered',
                    message: 'BNBUSDT hit stop loss at $285.50',
                    timestamp: new Date(Date.now() - 300000).toISOString()
                }
            ]);

            // Demo equity curve
            const labels = Array.from({length: 30}, (_, i) => `Day ${i + 1}`);
            const equity = Array.from({length: 30}, () => 45000 + Math.random() * 10000);
            const drawdown = Array.from({length: 30}, () => -(Math.random() * 15));
            
            equityChart.data.labels = labels;
            equityChart.data.datasets[0].data = equity;
            equityChart.data.datasets[1].data = drawdown;
            equityChart.update();
        }

        async function loadEquityData(period) {
            // Would fetch historical data based on period
            console.log('Loading equity data for period:', period);
        }

        function showPositionDetails(symbol) {
            alert(`Position details for ${symbol}\n\nThis would open a detailed modal with position info.`);
        }

        function exportReport() {
            alert('Generating PDF report...\n\nThis feature will export a comprehensive risk report.');
        }

        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>
