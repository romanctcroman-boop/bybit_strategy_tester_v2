<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Security Headers (X-Frame-Options must be set via HTTP header, not meta) -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; connect-src 'self' https://api.bybit.com wss://stream.bybit.com ws://localhost:* http://localhost:* https://cdn.jsdelivr.net; object-src 'none'; base-uri 'self'; form-action 'self'; frame-src 'none'" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Strategy Builder - Bybit Strategy Tester v2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- External CSS (Phase 1) -->
  <link rel="stylesheet" href="./css/variables.css?v=20260204d" />
  <link rel="stylesheet" href="./css/components.css?v=20260204d" />
  <link rel="stylesheet" href="./css/common.css?v=20260204d" />
  <link rel="stylesheet" href="./css/strategy_builder.css?v=20260204d" />

  <!-- auto-event-binding.js removed - using native event listeners in strategy_builder.js -->
</head>

<body>
  <div class="app-layout">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-left">
        <a href="dashboard.html" class="navbar-brand" title="Back to Dashboard" aria-label="Back to Dashboard">
          <i class="bi bi-arrow-left"></i>
        </a>
        <div class="strategy-name">
          <i class="bi bi-diagram-3"></i>
          <label for="strategyName" class="visually-hidden">Strategy name</label>
          <input type="text" id="strategyName" value="New Strategy" placeholder="Strategy name..."
            title="Strategy name" />
        </div>
        <span class="text-secondary text-sm">
          <i class="bi bi-clock"></i> Last saved: Never
        </span>
        <!-- Global Loading Indicator -->
        <span class="global-loading-indicator hidden" id="globalLoadingIndicator">
          <span class="loading-spinner"></span>
          <span class="loading-text">Loading...</span>
        </span>
      </div>
      <div class="navbar-actions">
        <button class="btn btn-secondary hidden" id="btnVersions" title="Версии стратегии">
          <i class="bi bi-clock-history"></i> Versions
        </button>
        <button class="btn btn-secondary" id="btnTemplates">
          <i class="bi bi-collection"></i> Templates
        </button>
        <button class="btn btn-secondary" id="btnValidate">
          <i class="bi bi-check-circle"></i> Validate
        </button>
        <button class="btn btn-secondary" id="btnGenerateCode">
          <i class="bi bi-code-slash"></i> Generate Code
        </button>
        <button class="btn btn-primary" id="btnSave">
          <i class="bi bi-save"></i> Save
        </button>
        <button class="btn btn-success" id="btnBacktest">
          <i class="bi bi-play-fill"></i> Backtest
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Sidebar - Block Library -->
      <div class="sidebar-left" id="sidebarLeft">
        <!-- Tab handle for collapsed state -->
        <div class="sidebar-tab-left" id="toggleLeftSidebarBtn" title="Block Library">
          <i class="bi bi-chevron-right tab-arrow"></i>
        </div>
        <div class="sidebar-header">
          <span class="sidebar-title">Библиотека</span>
          <button class="btn-icon-sm" id="refreshLibraryBtn" title="Refresh library">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
        <div class="block-categories" id="blockCategories">
          <!-- Populated by JavaScript -->
        </div>
        <div class="sidebar-search">
          <label for="blockSearch" class="visually-hidden">Search blocks</label>
          <input type="text" class="search-input" id="blockSearch" placeholder="Search blocks..."
            title="Search blocks" />
        </div>
      </div>

      <!-- Canvas Area -->
      <div class="canvas-area">
        <div class="canvas-toolbar">
          <div class="toolbar-group">
            <button id="btnUndo" class="btn btn-icon btn-secondary" title="Undo">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button id="btnRedo" class="btn btn-icon btn-secondary" title="Redo">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          <div class="toolbar-group">
            <button id="btnDuplicate" class="btn btn-icon btn-secondary" title="Duplicate">
              <i class="bi bi-copy"></i>
            </button>
            <button id="btnClearAll" class="btn btn-icon btn-secondary btn-clear-all" title="Очистить всё и сбросить к началу">
              <i class="bi bi-trash3"></i>
            </button>
          </div>
          <div class="toolbar-group">
            <button id="btnAlignLeft" class="btn btn-icon btn-secondary" title="Align Left">
              <i class="bi bi-align-start"></i>
            </button>
            <button id="btnAlignCenter" class="btn btn-icon btn-secondary" title="Align Center">
              <i class="bi bi-align-center"></i>
            </button>
            <button id="btnAlignRight" class="btn btn-icon btn-secondary" title="Align Right">
              <i class="bi bi-align-end"></i>
            </button>
          </div>
          <div class="toolbar-group">
            <button id="btnAutoLayout" class="btn btn-icon btn-secondary" title="Auto Layout">
              <i class="bi bi-grid-3x3"></i>
            </button>
            <button class="btn btn-icon btn-secondary" onclick="fitToScreen()" title="Fit to Screen">
              <i class="bi bi-fullscreen"></i>
            </button>
          </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
          <svg class="canvas" id="connectionsCanvas">
            <!-- Connection lines rendered here -->
          </svg>
          <div id="blocksContainer">
            <!-- Strategy blocks rendered here -->
          </div>
        </div>

        <!-- Zoom Controls — вне canvas-container, чтобы не обрезалось overflow -->
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()" title="Zoom out" aria-label="Zoom out">
            <i class="bi bi-dash"></i>
          </button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button class="zoom-btn" onclick="zoomIn()" title="Zoom in" aria-label="Zoom in">
            <i class="bi bi-plus"></i>
          </button>
          <button class="zoom-btn" onclick="resetZoom()" title="Reset zoom" aria-label="Reset zoom">
            <i class="bi bi-arrows-angle-expand"></i>
          </button>
        </div>
      </div>

      <!-- Floating Windows Container - все окна на одном уровне -->
      <div class="floating-windows-container" id="propertiesPanel">

        <!-- Окно Basic (Параметры) - голубое -->
        <div class="floating-window floating-window-collapsed" data-tab="basic" id="floatingWindowBasic">
          <div class="floating-window-spine" data-tab="basic" title="Параметры">
            <span>Параметры</span>
          </div>
          <div class="floating-window-inner">
            <div class="floating-window-title">Параметры</div>
            <div class="floating-window-body" id="strategyBasicProps">
              <div class="property-row property-row-vertical">
                <span class="property-label">Название стратегии</span>
                <input type="text" class="property-input property-input-full" id="strategyNameDisplay"
                  placeholder="Название стратегии" title="Синхронизируется с полем в шапке страницы" />
              </div>
              <div class="property-row property-row-two-cols" id="marketDirectionRow">
                <div class="property-col-half">
                  <label for="builderMarketType" class="property-label">Тип рынка</label>
                  <select class="property-select property-select-full" id="builderMarketType"
                    title="SPOT = данные идентичны TradingView для паритета сигналов. LINEAR = перпетуальные фьючерсы для реальной торговли.">
                    <option value="spot">SPOT (TradingView Parity)</option>
                    <option value="linear" selected>Futures (LINEAR/Perpetual)</option>
                  </select>
                </div>
                <div class="property-col-half">
                  <label for="builderDirection" class="property-label">Тип позиции</label>
                  <select class="property-select property-select-full" id="builderDirection"
                    title="Разрешённые направления торговли">
                    <option value="both">Long &amp; Short</option>
                    <option value="long">Только Long</option>
                    <option value="short">Только Short</option>
                  </select>
                </div>
              </div>
              <div class="property-row property-row-two-cols symbol-picker-wrap">
                <div class="property-col-half">
                  <label for="backtestSymbol" class="property-label">Symbol</label>
                  <div class="symbol-picker">
                    <input type="text" class="property-input property-input-full" id="backtestSymbol" autocomplete="off"
                      placeholder="Поиск тикера (Bybit)..." value=""
                      title="Тикеры с Bybit по типу рынка; введите для поиска" />
                    <ul class="symbol-picker-dropdown" id="backtestSymbolDropdown" role="listbox"
                      aria-label="Available trading symbols" aria-hidden="true"></ul>
                  </div>
                </div>
                <div class="property-col-half">
                  <label for="strategyTimeframe" class="property-label">Таймфрейм</label>
                  <select class="property-select property-select-full" id="strategyTimeframe"
                    title="Таймфреймы: 1m, 5m, 15m, 30m, 60m, 4h, 1D, 1W, 1M">
                    <option value="1">1m</option>
                    <option value="5">5m</option>
                    <option value="15" selected>15m</option>
                    <option value="30">30m</option>
                    <option value="60">1h</option>
                    <option value="240">4h</option>
                    <option value="D">1D</option>
                    <option value="W">1W</option>
                    <option value="M">1M</option>
                  </select>
                </div>
              </div>
              <hr class="property-divider" aria-hidden="true" />
              <div id="propertiesDataStatusRow" class="property-row property-row-vertical data-status-row hidden">
                <div id="propertiesDataStatusIndicator" class="data-status">
                  <span class="status-icon">⏳</span>
                  <span class="status-text">Проверка данных...</span>
                </div>
                <div id="propertiesCandleLoadingProgress" class="properties-loading-strip hidden">
                  <div id="propertiesCandleLoadingBar" class="properties-loading-bar" role="progressbar"
                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                    aria-label="Прогресс синхронизации БД с биржей" title="Синхронизация данных..."></div>
                </div>
              </div>
              <div class="property-row property-row-two-cols" data-props-version="2">
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestCapital" class="property-label">Initial Capital ($)</label>
                  <input type="number" class="property-input property-input-full" id="backtestCapital" value="10000"
                    min="100" step="100" />
                </div>
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestPositionSizeType" class="property-label">Тип размера ордера</label>
                  <select class="property-select property-select-full" id="backtestPositionSizeType"
                    title="Как считать размер позиции">
                    <option value="percent">% от капитала</option>
                    <option value="fixed_amount">Сумма в $ (фикс.)</option>
                    <option value="contracts">Контракты/Лоты</option>
                  </select>
                </div>
              </div>
              <div class="property-row property-row-two-cols">
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestPositionSize" id="backtestPositionSizeLabel" class="property-label">Размер
                    позиции (%)</label>
                  <input type="number" class="property-input property-input-full" id="backtestPositionSize" value="100"
                    min="1" max="100" step="1" />
                </div>
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestCommission" class="property-label">Commission %</label>
                  <input type="number" class="property-input property-input-full" id="backtestCommission" value="0.07"
                    min="0" max="1" step="0.01" title="0.07% = TradingView parity" />
                </div>
              </div>
              <div class="property-row property-row-vertical properties-leverage-block">
                <label for="backtestLeverage" class="property-label">Плечо:
                  <span id="backtestLeverageValue" class="leverage-value">10x</span></label>
                <input type="range" class="property-input-full properties-leverage-range" id="backtestLeverageRange"
                  min="1" max="50" step="1" value="10" title="Кредитное плечо 1–50x" />
                <input type="hidden" id="backtestLeverage" value="10" />
                <div id="backtestLeverageRiskIndicator" class="leverage-risk-indicator properties-leverage-risk"></div>
              </div>
              <div class="property-row property-row-vertical">
                <label for="backtestPyramiding" class="property-label">Pyramiding (макс. одновременных позиций)</label>
                <input type="number" class="property-input property-input-full" id="backtestPyramiding" value="1"
                  min="0" max="99" step="1" title="Макс. одновременных входов в одном направлении (0-99, совместимо с TradingView)" />
              </div>
              <div class="property-row property-row-two-cols">
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestStartDate" class="property-label">Start Date</label>
                  <input type="date" class="property-input property-input-full" id="backtestStartDate"
                    value="2025-01-01" />
                </div>
                <div class="property-row property-row-vertical property-col-half">
                  <label for="backtestEndDate" class="property-label">End Date</label>
                  <input type="date" class="property-input property-input-full" id="backtestEndDate"
                    value="2030-01-01" />
                </div>
              </div>
              <div class="property-row property-row-vertical">
                <span class="property-label property-label-secondary">TIME FILTER (USE FOR TESTS)</span>
                <div class="days-to-block-row" aria-label="Days to block">
                  <label class="day-block-item" title="Sunday – block"><input type="checkbox" id="dayBlockSu" />
                    Su</label>
                  <label class="day-block-item" title="Monday – block"><input type="checkbox" id="dayBlockMo" />
                    Mo</label>
                  <label class="day-block-item" title="Tuesday – block"><input type="checkbox" id="dayBlockTu" />
                    Tu</label>
                  <label class="day-block-item" title="Wednesday – block"><input type="checkbox" id="dayBlockWe" />
                    We</label>
                  <label class="day-block-item" title="Thursday – block"><input type="checkbox" id="dayBlockTh" />
                    Th</label>
                  <label class="day-block-item" title="Friday – block"><input type="checkbox" id="dayBlockFr" />
                    Fr</label>
                  <label class="day-block-item" title="Saturday – block"><input type="checkbox" id="dayBlockSa" />
                    Sa</label>
                  <span class="days-to-block-caption">– Days To Block</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Окно Evaluation - розовое -->
        <div class="floating-window floating-window-collapsed" data-tab="evaluation" id="floatingWindowEvaluation">
          <div class="floating-window-spine" data-tab="evaluation" title="Evaluation">
            <span>Evaluation</span>
          </div>
          <div class="floating-window-inner">
            <div class="floating-window-title">Evaluation</div>
            <div class="floating-window-body" id="evaluationCriteriaSection">
              <div class="property-row property-row-vertical">
                <label for="primaryMetric" class="property-label">Primary Metric</label>
                <select class="property-select property-select-full" id="primaryMetric" title="Main metric to optimize">
                  <option value="sharpe_ratio" selected>Sharpe Ratio</option>
                  <option value="sortino_ratio">Sortino Ratio</option>
                  <option value="total_return">Total Return %</option>
                  <option value="calmar_ratio">Calmar Ratio</option>
                  <option value="profit_factor">Profit Factor</option>
                  <option value="win_rate">Win Rate %</option>
                </select>
              </div>
              <div class="property-row property-row-vertical">
                <label class="property-label">Secondary Metrics</label>
                <div class="criteria-checkbox-list">
                  <label class="criteria-checkbox-item">
                    <input type="checkbox" id="metricWinRate" checked title="Win Rate" />
                    <span>Win Rate</span>
                  </label>
                  <label class="criteria-checkbox-item">
                    <input type="checkbox" id="metricMaxDD" checked title="Max Drawdown" />
                    <span>Max Drawdown</span>
                  </label>
                  <label class="criteria-checkbox-item">
                    <input type="checkbox" id="metricProfitFactor" checked title="Profit Factor" />
                    <span>Profit Factor</span>
                  </label>
                  <label class="criteria-checkbox-item">
                    <input type="checkbox" id="metricExpectancy" title="Expectancy" />
                    <span>Expectancy</span>
                  </label>
                  <label class="criteria-checkbox-item">
                    <input type="checkbox" id="metricCAGR" title="CAGR" />
                    <span>CAGR</span>
                  </label>
                </div>
              </div>
              <div class="property-row property-row-vertical">
                <label class="property-label">Constraints</label>
                <div class="constraints-list" id="constraintsList">
                  <div class="constraint-item">
                    <select class="constraint-metric" title="Constraint metric">
                      <option value="max_drawdown">Max DD</option>
                    </select>
                    <select class="constraint-operator" title="Operator">
                      <option value="<=">&le;</option>
                    </select>
                    <input type="number" class="constraint-value" value="15" title="Value" />
                    <span class="constraint-unit">%</span>
                    <button class="constraint-remove" title="Remove" aria-label="Remove constraint">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                  <div class="constraint-item">
                    <select class="constraint-metric" title="Constraint metric">
                      <option value="min_trades">Min Trades</option>
                    </select>
                    <select class="constraint-operator" title="Operator">
                      <option value=">=">&ge;</option>
                    </select>
                    <input type="number" class="constraint-value" value="50" title="Value" />
                    <span class="constraint-unit"></span>
                    <button class="constraint-remove" title="Remove" aria-label="Remove constraint">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
                <button class="btn-add-constraint" id="btnAddConstraint" title="Add constraint">
                  <i class="bi bi-plus"></i> Add Constraint
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Окно Optimization - красное -->
        <div class="floating-window floating-window-collapsed" data-tab="optimization" id="floatingWindowOptimization">
          <div class="floating-window-spine" data-tab="optimization" title="Optimization">
            <span>Optimization</span>
          </div>
          <div class="floating-window-inner">
            <div class="floating-window-title">Optimization</div>
            <div class="floating-window-body" id="optimizationConfigSection">
              <div class="property-row property-row-vertical">
                <label for="optMethod" class="property-label">Method</label>
                <select class="property-select property-select-full" id="optMethod" title="Optimization method">
                  <option value="bayesian" selected>Bayesian (TPE) - Recommended</option>
                  <option value="grid_search">Grid Search (Exhaustive)</option>
                  <option value="random_search">Random Search (Fast)</option>
                  <option value="walk_forward">Walk-Forward Analysis</option>
                </select>
              </div>
              <div class="property-row property-row-vertical">
                <label class="property-label">Parameter Ranges</label>
                <div class="param-ranges-list" id="paramRangesList">
                  <p class="text-muted text-sm">
                    <i class="bi bi-info-circle"></i>
                    Add indicator blocks to configure parameter ranges
                  </p>
                </div>
              </div>
              <div class="property-row">
                <label for="optMaxTrials" class="property-label">Max Trials</label>
                <input type="number" class="property-input" id="optMaxTrials" value="200" min="10" max="10000"
                  title="Maximum optimization trials" />
              </div>
              <div class="property-row">
                <label for="optWorkers" class="property-label">Workers</label>
                <input type="number" class="property-input" id="optWorkers" value="4" min="1" max="16"
                  title="Parallel workers" />
              </div>
              <button class="btn btn-primary w-100 mt-3" id="btnStartOptimization">
                <i class="bi bi-play-fill"></i> Start Optimization
              </button>
            </div>
          </div>
        </div>

        <!-- Окно Database - зелёное -->
        <div class="floating-window floating-window-collapsed" data-tab="database" id="floatingWindowDatabase">
          <div class="floating-window-spine" data-tab="database" title="База данных">
            <span>Б/Д</span>
          </div>
          <div class="floating-window-inner">
            <div class="floating-window-title">База данных</div>
            <div class="floating-window-body" id="dunnahBaseSection">
              <p class="text-muted text-sm mb-2">Тикеры в БД по группам (Symbol + Market Type). Удаление или
                блокировка догрузки.</p>
              <div class="dunnah-base-toolbar mb-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDunnahRefresh"
                  title="Обновить список">
                  <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
              </div>
              <div class="dunnah-base-groups" id="dunnahBaseGroups">
                <p class="text-muted text-sm">Загрузка...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Окно Results - жёлтое -->
        <div class="floating-window floating-window-collapsed" data-tab="results" id="floatingWindowResults">
          <div class="floating-window-spine" data-tab="results" title="Results">
            <span>Results</span>
          </div>
          <div class="floating-window-inner">
            <div class="floating-window-title">Results</div>
            <div class="floating-window-body" id="resultsQuickViewSection">
              <div class="results-quick-summary" id="resultsQuickSummary">
                <p class="text-muted text-sm text-center">
                  <i class="bi bi-bar-chart"></i>
                  Run optimization to see results
                </p>
              </div>
              <a href="optimization-results.html" class="btn btn-outline-primary btn-sm w-100 mt-2 d-none"
                id="btnViewFullResults">
                <i class="bi bi-box-arrow-up-right"></i> View Full Results
              </a>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Sidebar - Validation -->
      <div class="sidebar-right collapsed" id="sidebarRight">
        <div class="validation-panel">
          <div class="validation-header">
            <span class="validation-title">Validation</span>
            <span class="validation-status valid" id="validationStatus">
              <i class="bi bi-check-circle-fill"></i> Valid
            </span>
          </div>
          <div class="validation-list" id="validationList">
            <div class="validation-item info">
              <i class="bi bi-info-circle"></i>
              <span>Add blocks to start building your strategy</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Templates Modal -->
      <div class="modal-overlay" id="templatesModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Strategy Templates</h3>
            <button class="modal-close" id="btnCloseModal">&times;</button>
          </div>
          <div class="modal-body">
            <div class="templates-grid" id="templatesGrid">
              <!-- Populated by JavaScript -->
            </div>
          </div>
          <div class="modal-footer d-flex flex-wrap gap-2 justify-content-between">
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="exportAsTemplate()"
                title="Save current strategy as JSON file">
                <i class="bi bi-download"></i> Export
              </button>
              <button class="btn btn-outline-secondary btn-sm"
                onclick="document.getElementById('importTemplateInput').click()" title="Load strategy from JSON file">
                <i class="bi bi-upload"></i> Import
              </button>
              <input type="file" id="importTemplateInput" accept=".json" class="hidden"
                title="Select JSON file to import" />
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-secondary" id="btnCancelModal">Cancel</button>
              <button class="btn btn-primary" id="btnLoadTemplate">
                <i class="bi bi-check-lg"></i> Use Template
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Strategy Versions Modal -->
      <div class="modal-overlay" id="versionsModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title"><i class="bi bi-clock-history"></i> Strategy Versions</h3>
            <button class="modal-close" id="btnCloseVersionsModal">&times;</button>
          </div>
          <div class="modal-body">
            <p class="text-muted text-sm mb-2">Восстановить предыдущую версию стратегии.</p>
            <div id="versionsList" class="versions-list">
              <p class="text-muted">Загрузка...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="btnCloseVersions">Close</button>
          </div>
        </div>
      </div>

      <!-- Backtest Results Modal -->
      <div class="modal-overlay" id="backtestResultsModal">
        <div class="modal modal-xl">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="bi bi-bar-chart-fill text-primary"></i>
              Backtest Results
            </h3>
            <button class="modal-close" onclick="closeBacktestResultsModal()">
              &times;
            </button>
          </div>
          <div class="modal-body" id="backtestResultsContent">
            <!-- Summary Cards Row -->
            <div class="results-summary-cards" id="resultsSummaryCards">
              <!-- Populated by JavaScript -->
            </div>

            <!-- Tabs for different views -->
            <div class="results-tabs">
              <button class="results-tab active" data-tab="overview" onclick="switchResultsTab('overview')">
                <i class="bi bi-speedometer2"></i> Overview
              </button>
              <button class="results-tab" data-tab="equity" onclick="switchResultsTab('equity')">
                <i class="bi bi-graph-up-arrow"></i> Equity Curve
              </button>
              <button class="results-tab" data-tab="trades" onclick="switchResultsTab('trades')">
                <i class="bi bi-list-ul"></i> Trades
              </button>
              <button class="results-tab" data-tab="metrics" onclick="switchResultsTab('metrics')">
                <i class="bi bi-calculator"></i> All Metrics
              </button>
            </div>

            <!-- Tab Contents -->
            <div class="results-tab-content active" id="tab-overview">
              <div class="metrics-grid" id="metricsOverview">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <div class="results-tab-content" id="tab-equity">
              <div class="equity-chart-container" id="equityChartContainer">
                <canvas id="equityChart"></canvas>
              </div>
              <div class="drawdown-chart-container" id="drawdownChartContainer">
                <canvas id="drawdownChart"></canvas>
              </div>
            </div>

            <div class="results-tab-content" id="tab-trades">
              <div class="trades-table-container">
                <table class="trades-table" id="tradesTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Entry Time</th>
                      <th>Exit Time</th>
                      <th>Side</th>
                      <th>Entry Price</th>
                      <th>Exit Price</th>
                      <th>Qty</th>
                      <th>PnL</th>
                      <th>PnL %</th>
                      <th>MFE</th>
                      <th>MAE</th>
                    </tr>
                  </thead>
                  <tbody id="tradesTableBody">
                    <!-- Populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <div class="results-tab-content" id="tab-metrics">
              <div class="all-metrics-grid" id="allMetricsGrid">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBacktestResultsModal()">
              <i class="bi bi-x-lg"></i> Close
            </button>
            <button class="btn btn-outline-primary" onclick="exportBacktestResults()">
              <i class="bi bi-download"></i> Export Results
            </button>
            <button class="btn btn-primary" onclick="viewFullResults()">
              <i class="bi bi-box-arrow-up-right"></i> Full Analysis
            </button>
          </div>
        </div>
      </div>

      <script src="./js/sidebar-toggle.js"></script>
      <script src="./js/pages/strategy_builder_debug.js"></script>
      <script type="module" src="./js/pages/strategy_builder.js?v=20260204"></script>
      <script src="./js/pages/symbol_picker_debug.js" defer></script>
      <script src="./js/pages/optimization_panels.js?v=20260204"></script>
      <script src="./js/pages/optimization.js"></script>
      <script src="./js/pages/evaluation_criteria_panel.js?v=20260204"></script>
      <script src="./js/pages/optimization_config_panel.js?v=20260204d"></script>
</body>

</html>