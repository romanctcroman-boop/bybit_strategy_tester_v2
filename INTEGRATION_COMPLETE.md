# ‚úÖ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø RETRY –õ–û–ì–ò–ö–ò –ó–ê–í–ï–†–®–ï–ù–ê

**–î–∞—Ç–∞:** 2025-11-06  
**–ó–∞–¥–∞—á–∞:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è `api_resilient.py` –≤ `server.py`  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–£–°–ü–ï–®–ù–û**

---

## üéØ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã —É–ª—É—á—à–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

```python
# –ò–º–ø–æ—Ä—Ç —É–ª—É—á—à–µ–Ω–Ω—ã—Ö API —Ñ—É–Ω–∫—Ü–∏–π —Å retry –ª–æ–≥–∏–∫–æ–π
from api_resilient import (
    call_perplexity_with_retry,
    call_deepseek_with_retry,
    APIError,
    RateLimitError,
    AuthenticationError,
    TimeoutError
)
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_call_perplexity_api`

**–î–æ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è, ~100 —Å—Ç—Ä–æ–∫):**
```python
async def _call_perplexity_api(query: str, model: str = "sonar", use_cache: bool = True):
    # –ü—Ä—è–º–æ–π httpx.AsyncClient –∑–∞–ø—Ä–æ—Å
    # –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
    # –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    async with httpx.AsyncClient(timeout=60.0) as client:
        response = await client.post(...)
        if response.status_code == 200:
            # ...
```

**–ü–æ—Å–ª–µ (—Å retry, ~50 —Å—Ç—Ä–æ–∫):**
```python
async def _call_perplexity_api(query: str, model: str = "sonar", use_cache: bool = True):
    """
    –£–õ–£–ß–®–ï–ù–ò–Ø:
    - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry –ø—Ä–∏ —Å–±–æ—è—Ö (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫)
    - ‚úÖ –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (rate limits, timeouts, server errors)
    - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    if use_cache:
        cached_result = await perplexity_cache.get(query, actual_model)
        if cached_result is not None:
            return cached_result
    
    # üõ°Ô∏è –í—ã–∑–æ–≤ —Å retry –ª–æ–≥–∏–∫–æ–π
    try:
        result = await call_perplexity_with_retry(
            api_key=PERPLEXITY_API_KEY,
            api_url=PERPLEXITY_API_URL,
            query=query,
            model=actual_model,
            timeout=60.0
        )
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
        if use_cache and result.get("success"):
            await perplexity_cache.set(query, actual_model, result)
        
        return result
        
    except (APIError, RateLimitError, AuthenticationError, TimeoutError) as e:
        return {"success": False, "error": str(e)}
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞:** 100 —Å—Ç—Ä–æ–∫ ‚Üí 50 —Å—Ç—Ä–æ–∫ (**-50%**)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_call_deepseek_api`

**–î–æ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è, ~80 —Å—Ç—Ä–æ–∫):**
```python
async def _call_deepseek_api(query: str, model: str = "deepseek-chat"):
    # –ü—Ä—è–º–æ–π httpx.AsyncClient –∑–∞–ø—Ä–æ—Å
    # –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
    # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç 120s
    async with httpx.AsyncClient(timeout=120.0) as client:
        response = await client.post(...)
        if response.status_code == 200:
            # ...
```

**–ü–æ—Å–ª–µ (—Å retry, ~40 —Å—Ç—Ä–æ–∫):**
```python
async def _call_deepseek_api(query: str, model: str = "deepseek-chat"):
    """
    –£–õ–£–ß–®–ï–ù–ò–Ø:
    - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry –ø—Ä–∏ —Å–±–æ—è—Ö (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫)
    - ‚úÖ –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (rate limits, timeouts, server errors)
    - ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è reasoning –º–æ–¥–µ–ª–µ–π (120s)
    """
    # üõ°Ô∏è –í—ã–∑–æ–≤ —Å retry –ª–æ–≥–∏–∫–æ–π
    try:
        result = await call_deepseek_with_retry(
            api_key=DEEPSEEK_API_KEY,
            api_url=DEEPSEEK_API_URL,
            query=query,
            model=model,
            max_tokens=4000,
            temperature=0.3,
            timeout=120.0
        )
        
        return result
        
    except (APIError, RateLimitError, AuthenticationError, TimeoutError) as e:
        return {"success": False, "error": str(e)}
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞:** 80 —Å—Ç—Ä–æ–∫ ‚Üí 40 —Å—Ç—Ä–æ–∫ (**-50%**)

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –¢–µ—Å—Ç 1: DeepSeek API (5 –∑–∞–ø—Ä–æ—Å–æ–≤)
```
‚úÖ –£—Å–ø–µ—à–Ω–æ: 5/5 (100%)
‚è±Ô∏è  –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 66.9s
üìä –°—Ä–µ–¥–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã: 1,944
üí∞ –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.00054/–∑–∞–ø—Ä–æ—Å
```

### –¢–µ—Å—Ç 2: Perplexity API (5 –∑–∞–ø—Ä–æ—Å–æ–≤)
```
‚úÖ –£—Å–ø–µ—à–Ω–æ: 5/5 (100%)
‚è±Ô∏è  –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 10.2s
üìä –°—Ä–µ–¥–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã: 456
üí∞ –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.012/–∑–∞–ø—Ä–æ—Å
```

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```
–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: 10
–£—Å–ø–µ—à–Ω—ã—Ö: 10 (100%)
–û—à–∏–±–æ–∫: 0 (0%)
–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: 12,665
–û–±—â–µ–µ –≤—Ä–µ–º—è: 668.9s
```

---

## üõ°Ô∏è –£–õ–£–ß–®–ï–ù–ò–Ø –ù–ê–î–Å–ñ–ù–û–°–¢–ò

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ Retry

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π —Å–µ—Ç–∏
```
–ó–∞–ø—Ä–æ—Å 1: ‚ùå ConnectError ‚Üí Retry —á–µ—Ä–µ–∑ 2s
–ó–∞–ø—Ä–æ—Å 2: ‚ùå ConnectError ‚Üí Retry —á–µ—Ä–µ–∑ 4s
–ó–∞–ø—Ä–æ—Å 3: ‚úÖ SUCCESS
```

**–ë–µ–∑ retry:** –û—à–∏–±–∫–∞ —Å—Ä–∞–∑—É  
**–° retry:** –£—Å–ø–µ—Ö –ø–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫

### 2. Rate Limit Handling

**–°—Ü–µ–Ω–∞—Ä–∏–π:** HTTP 429 (Too Many Requests)
```
–ó–∞–ø—Ä–æ—Å 1: ‚ùå RateLimitError ‚Üí Retry —á–µ—Ä–µ–∑ 2-10s (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ)
–ó–∞–ø—Ä–æ—Å 2: ‚úÖ SUCCESS
```

**–ë–µ–∑ retry:** –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö  
**–° retry:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### 3. Timeout Protection

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ú–µ–¥–ª–µ–Ω–Ω—ã–π API
```
Perplexity: timeout=60s  ‚Üí –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
DeepSeek:   timeout=120s ‚Üí Reasoning —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
```

**–ë–µ–∑ timeout:** –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ  
**–° timeout:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

---

## üìà –ú–ï–¢–†–ò–ö–ò –£–õ–£–ß–®–ï–ù–ò–ô

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞** | ~180 | ~90 | -50% |
| **Retry –ª–æ–≥–∏–∫–∞** | ‚ùå | ‚úÖ 3 –ø–æ–ø—ã—Ç–∫–∏ | –ù–æ–≤–∞—è |
| **Rate limit handling** | ‚ùå | ‚úÖ –£–º–Ω–∞—è | –ù–æ–≤–∞—è |
| **–¢–∞–π–º–∞—É—Ç—ã** | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ | –ì–∏–±—á–µ |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** | –ë–∞–∑–æ–≤–æ–µ | –î–µ—Ç–∞–ª—å–Ω–æ–µ | –£–ª—É—á—à–µ–Ω–æ |
| **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | +100% |

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (tenacity)
```python
@retry(
    stop=stop_after_attempt(3),          # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
    wait=wait_exponential(                # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        multiplier=1, 
        min=2,                            # –ú–∏–Ω–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã
        max=10                            # –ú–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥
    ),
    retry=retry_if_exception_type((       # Retry —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
        httpx.TimeoutException, 
        RateLimitError, 
        httpx.ConnectError
    ))
)
```

**–¢–∞–π–º–ª–∞–π–Ω retry:**
- –ü–æ–ø—ã—Ç–∫–∞ 1: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –ü–æ–ø—ã—Ç–∫–∞ 2: –ü–æ—Å–ª–µ 2-4 —Å–µ–∫—É–Ω–¥ (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ)
- –ü–æ–ø—ã—Ç–∫–∞ 3: –ü–æ—Å–ª–µ 4-10 —Å–µ–∫—É–Ω–¥ (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```python
# 429 Too Many Requests ‚Üí Retry
if response.status_code == 429:
    raise RateLimitError(...)  # tenacity –ø–æ–≤—Ç–æ—Ä–∏—Ç

# 401/403 Authentication ‚Üí No Retry (–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ)
elif response.status_code in (401, 403):
    raise AuthenticationError(...)  # –æ—à–∏–±–∫–∞ —Å—Ä–∞–∑—É

# 500+ Server Error ‚Üí Retry
elif response.status_code >= 500:
    raise APIError(...)  # tenacity –ø–æ–≤—Ç–æ—Ä–∏—Ç
```

---

## ‚úÖ –ò–¢–û–ì–ò

### –ß—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ:
1. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –≤ –æ–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ API
2. ‚úÖ –°–æ–∫—Ä–∞—â—ë–Ω –∫–æ–¥ –Ω–∞ 50% (180 ‚Üí 90 —Å—Ç—Ä–æ–∫)
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ 10 –∑–∞–ø—Ä–æ—Å–æ–≤ (100% —É—Å–ø–µ—Ö)
4. ‚úÖ –ù–µ—Ç DeprecationWarnings
5. ‚úÖ –í—Å–µ 49 MCP tools —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç retry –ª–æ–≥–∏–∫—É

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- üõ°Ô∏è **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ –∫–æ–¥–∞ = –±—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∑–∫–∞
- üîç **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ retry –ø–æ–ø—ã—Ç–æ–∫
- üéØ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ retry –º–µ—Ç—Ä–∏–∫ (—Å–∫–æ–ª—å–∫–æ retry –≤ production)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö retry
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã

---

## üìù –§–ê–ô–õ–´

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ:**
- ‚úÖ `mcp-server/server.py` - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ retry –ª–æ–≥–∏–∫–∞

**–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ:**
- ‚úÖ `mcp-server/api_resilient.py` - –£–ª—É—á—à–µ–Ω–Ω—ã–µ API —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ `mcp-server/activity_logger.py` - –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä
- ‚úÖ `IMPROVEMENTS_REPORT.md` - –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
- ‚úÖ `AI_COLLABORATION_SUMMARY.md` - –ò—Ç–æ–≥–æ–≤—ã–π summary
- ‚úÖ `INTEGRATION_COMPLETE.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª

---

## üéâ –§–ò–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê

**–ö–∞—á–µ—Å—Ç–≤–æ:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)  
**–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)  
**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** Production-Ready ‚úÖ

---

**–°–æ–∑–¥–∞–Ω–æ:** GitHub Copilot  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** AI-driven refactoring  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 –º–∏–Ω—É—Ç  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û**
