# Redis Configuration for Production

# ============================================
# NETWORK
# ============================================
# The address Redis server will listen on
bind 127.0.0.1 ::1

# Accept connections on this port
port 6379

# TCP listen() backlog
tcp-backlog 511

# Close the connection after a client is idle for N seconds (0 = never)
timeout 0

# TCP keepalive.
tcp-keepalive 300

# ============================================
# GENERAL
# ============================================
# Run the server in the background
daemonize no

# Set the server verbosity to 'notice'
loglevel notice

# Set the log file name
logfile ""

# Set the number of databases
databases 16

# ============================================
# PERSISTENCE - RDB (Snapshots)
# ============================================
# Save DB on disk
# save [seconds] [changes]
# Will save the DB if both the given number of seconds and the given number of write operations
# have occurred
save 900 1
save 300 10
save 60 10000

# By default Redis will stop accepting writes if RDB snapshots are enabled
# (and the latest save has failed).
stop-writes-on-bgsave-error yes

# Compress string objects using LZF when dump .rdb databases
rdbcompression yes

# Checksum the RDB file
rdbchecksum yes

# The filename for the RDB file
dbfilename dump.rdb

# The working directory
dir ./

# ============================================
# PERSISTENCE - AOF (Append Only File)
# ============================================
# Enable the AOF instead of RDB persistence
appendonly yes

# The name of the append only file
appendfilename "appendonly.aof"

# fsync policy - how often to write data to disk
# no: fsync is never called, data will be written when the OS says it's time
# always: fsync is called after every write command
# everysec: fsync is called every second (good balance)
appendfsync everysec

# Prevent fsync during rewrites
no-appendfsync-on-rewrite no

# When the AOF fsync policy is set to "always" or "everysec", and a background
# saving process (a background rewrite or bgsave) is performing a lot of I/O
# against the disk, Redis might block too long on the fsync() call
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# LUA SCRIPTING
# ============================================
# Max execution time for Lua scripts (milliseconds)
lua-time-limit 5000

# ============================================
# CLUSTER
# ============================================
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000

# ============================================
# MEMORY MANAGEMENT
# ============================================
# Set a memory usage limit
maxmemory 2gb

# Memory eviction policy when max memory is reached
# noeviction: Do not evict any key, just return an error
# allkeys-lru: Evict any key according to LRU algorithm
# volatile-lru: Evict using LRU among keys with an expire set
# allkeys-lfu: Evict any key according to LFU algorithm
# volatile-lfu: Evict using LFU among keys with an expire set
# volatile-random: Evict random keys with an expire set
# allkeys-random: Evict random keys
# volatile-ttl: Evict keys with an expire set, trying to evict keys with shorter TTL first
maxmemory-policy allkeys-lru

# Number of samples to use for LRU/LFU eviction
maxmemory-samples 5

# ============================================
# REPLICATION
# ============================================
# slaveof <masterip> <masterport>
# slaveof 192.168.1.1 6379

# Replica-read-only
replica-read-only yes

# Serve stale data while connecting to master
replica-serve-stale-data yes

# Disable TCP_NODELAY on replica
repl-disable-tcp-nodelay no

# Replication backlog
repl-backlog-size 1mb
repl-backlog-ttl 3600

# ============================================
# SECURITY
# ============================================
# Require a password to connect
requirepass redis_production_password_here

# Command renaming (for security)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""

# ============================================
# CLIENTS
# ============================================
# Set the max number of connected clients
maxclients 10000

# ============================================
# SLOW LOG
# ============================================
# Log queries slower than specified microseconds
slowlog-log-slower-than 10000

# Keep only this many entries in the slow log
slowlog-max-len 128

# ============================================
# ADVANCED CONFIG
# ============================================
# How many bytes should be used to represent the Redis object
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000

# ============================================
# ACTIVE REHASHING
# ============================================
# Enable active defragmentation of the main dictionary
activerehashing yes

# The minimum percentage of samples needed to trigger active defrag
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10

# ============================================
# LATENCY MONITORING
# ============================================
# Sample all commands for latency monitoring
latency-monitor-threshold 0

# ============================================
# NOTIFICATIONS
# ============================================
# Enable keyspace notifications
notify-keyspace-events ""

# ============================================
# APPEND ONLY MODE FSYNC SETTINGS
# ============================================
# Never used fsync
# appendfsync no

